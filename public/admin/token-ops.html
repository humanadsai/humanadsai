<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Ops - Admin - HumanAds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    .admin-page { padding: 24px 16px; max-width: 1200px; margin: 0 auto; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .admin-header h1 { font-family: var(--font-mono); font-size: 1.5rem; }

    /* Wallet Connection */
    .wallet-section { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .wallet-btn { padding: 8px 16px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; -webkit-tap-highlight-color: transparent; }
    .wallet-btn:hover { opacity: 0.9; }
    .wallet-btn:active { opacity: 0.7; }
    .wallet-btn.connected { background: rgba(52,199,89,0.2); color: #34c759; border: 1px solid rgba(52,199,89,0.3); }
    .wallet-info { font-family: var(--font-mono); font-size: 0.75rem; }
    .wallet-address { color: var(--color-text-muted); }
    .wallet-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 8px; }
    .wallet-badge.owner { background: rgba(255,107,53,0.2); color: #ff6b35; }
    .wallet-badge.not-owner { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .chain-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 4px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .chain-badge.correct { background: rgba(52,199,89,0.2); color: #34c759; }
    .chain-badge.wrong { background: rgba(255,59,48,0.2); color: #ff3b30; }

    /* Cards */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .card-title { font-family: var(--font-mono); font-size: 0.875rem; color: var(--color-text-muted); text-transform: uppercase; }
    .card-value { font-family: var(--font-mono); font-size: 1.75rem; font-weight: 600; }
    .card-sub { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }

    /* Owner Cards */
    .owner-card { background: linear-gradient(135deg, rgba(52,199,89,0.1) 0%, rgba(0,122,255,0.05) 100%); border-color: rgba(52,199,89,0.3); }
    .owner-form { display: flex; flex-direction: column; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-label { font-size: 0.75rem; color: var(--color-text-muted); font-family: var(--font-mono); }
    .form-input { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); }
    .form-input:focus { outline: none; border-color: var(--color-primary); }
    .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
    .form-input::placeholder { color: var(--color-text-muted); }
    .form-select { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); cursor: pointer; }
    .form-hint { font-size: 0.7rem; color: var(--color-text-muted); }
    .form-hint.fixed { background: rgba(255,149,0,0.1); padding: 4px 8px; border-radius: 4px; }

    /* Faucet Form */
    .faucet-card { background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,149,0,0.05) 100%); border-color: rgba(255,107,53,0.3); }
    .faucet-form { display: flex; flex-direction: column; gap: 12px; }
    .faucet-input { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); }
    .faucet-input:focus { outline: none; border-color: var(--color-primary); }
    .faucet-input::placeholder { color: var(--color-text-muted); }
    .faucet-amount { display: flex; align-items: center; gap: 8px; }
    .faucet-amount-value { font-family: var(--font-mono); font-size: 1.25rem; font-weight: 600; color: var(--color-primary); }

    /* Buttons */
    .action-btn { padding: 12px 24px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-family: var(--font-mono); font-weight: 600; cursor: pointer; transition: opacity 0.2s; width: 100%; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .action-btn:hover { opacity: 0.9; }
    .action-btn:active { opacity: 0.7; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.mint { background: #34c759; }
    .action-btn.transfer { background: #007aff; }
    .status-msg { font-size: 0.75rem; padding: 8px; border-radius: 4px; margin-top: 8px; word-break: break-all; }
    .status-msg.success { background: rgba(52,199,89,0.2); color: #34c759; }
    .status-msg.error { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .status-msg.info { background: rgba(0,122,255,0.2); color: #007aff; }

    /* Config Info */
    .config-info { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border); }
    .config-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .config-label { opacity: 0.7; }
    .config-value { font-family: var(--font-mono); }

    /* Table */
    .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-family: var(--font-mono); background: var(--color-surface); border: 1px solid var(--color-border); cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .filter-chip:hover, .filter-chip.active { border-color: var(--color-primary); color: var(--color-primary); }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 0.875rem; }
    .data-table th { font-family: var(--font-mono); font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; }
    .data-table tr:hover { background: rgba(255,255,255,0.02); }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-family: var(--font-mono); font-weight: 600; }
    .status-badge.confirmed { background: rgba(52,199,89,0.2); color: #34c759; }
    .status-badge.submitted { background: rgba(0,122,255,0.2); color: #007aff; }
    .status-badge.pending { background: rgba(255,149,0,0.2); color: #ff9500; }
    .status-badge.failed { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .type-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-family: var(--font-mono); }
    .type-badge.faucet { background: rgba(255,107,53,0.2); color: #ff6b35; }
    .type-badge.mint { background: rgba(52,199,89,0.2); color: #34c759; }
    .type-badge.transfer { background: rgba(0,122,255,0.2); color: #007aff; }
    .type-badge.owner_mint { background: rgba(52,199,89,0.2); color: #34c759; }
    .type-badge.owner_transfer { background: rgba(0,122,255,0.2); color: #007aff; }
    .loading, .empty { text-align: center; padding: 40px; color: var(--color-text-muted); }
    .id-cell { font-family: var(--font-mono); font-size: 0.75rem; color: var(--color-text-muted); }
    .address-cell { font-family: var(--font-mono); font-size: 0.7rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .table-container { overflow-x: auto; }
    .section-title { font-family: var(--font-mono); font-size: 1rem; margin: 24px 0 16px; }

    /* TX Hash link */
    .tx-link { color: var(--color-primary); text-decoration: none; font-family: var(--font-mono); font-size: 0.7rem; }
    .tx-link:hover { text-decoration: underline; }

    /* Confirmation Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 16px; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 24px; max-width: 420px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-family: var(--font-mono); font-size: 1.25rem; margin-bottom: 16px; }
    .modal-content { margin-bottom: 20px; }
    .modal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border); font-size: 0.875rem; }
    .modal-row:last-child { border-bottom: none; }
    .modal-label { color: var(--color-text-muted); }
    .modal-value { font-family: var(--font-mono); text-align: right; word-break: break-all; max-width: 200px; }
    .modal-actions { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 14px; border-radius: 8px; font-family: var(--font-mono); font-weight: 600; cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-size: 1rem; }
    .modal-btn:active { opacity: 0.7; }
    .modal-btn.cancel { background: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text); }
    .modal-btn.confirm { background: var(--color-primary); border: none; color: white; }
    .modal-btn.confirm.mint { background: #34c759; }
    .modal-btn.confirm.transfer { background: #007aff; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Debug Panel */
    .debug-panel { margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.7rem; font-family: var(--font-mono); }
    .debug-toggle { cursor: pointer; color: var(--color-text-muted); display: flex; align-items: center; gap: 4px; }
    .debug-toggle:hover { color: var(--color-text); }
    .debug-content { margin-top: 8px; display: none; }
    .debug-content.show { display: block; }
    .debug-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .debug-row:last-child { border-bottom: none; }
    .debug-key { color: var(--color-text-muted); }
    .debug-value { color: #34c759; word-break: break-all; max-width: 200px; text-align: right; }
    .debug-value.error { color: #ff3b30; }
    .debug-value.warn { color: #ff9500; }

    /* Modal Status */
    .modal-status { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 0.8rem; display: none; }
    .modal-status.show { display: block; }
    .modal-status.info { background: rgba(0,122,255,0.2); color: #007aff; }
    .modal-status.error { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .modal-status.success { background: rgba(52,199,89,0.2); color: #34c759; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/><circle cx="14" cy="20" r="4" fill="#FF6B35"/><path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu"><span class="hamburger-line"></span><span class="hamburger-line"></span><span class="hamburger-line"></span></button>
      </div>
    </header>
    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false"></nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <main class="admin-page" id="content">
      <div class="loading">Loading token ops...</div>
    </main>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm Transaction</div>
      <div class="modal-content" id="modal-content"></div>
      <div class="modal-status" id="modal-status"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="modal-cancel-btn">Cancel</button>
        <button class="modal-btn confirm" id="modal-confirm-btn">Confirm</button>
      </div>
      <!-- Debug Panel -->
      <div class="debug-panel">
        <div class="debug-toggle" id="debug-toggle">
          <span id="debug-arrow">+</span> Debug Info
        </div>
        <div class="debug-content" id="debug-content"></div>
      </div>
    </div>
  </div>

  <script src="/js/side-menu.js"></script>
  <script src="/js/humanads.js"></script>
  <script>
    // ============================================
    // Configuration
    // ============================================
    const CONFIG = {
      chainId: 11155111,
      chainIdHex: '0xaa36a7',
      chainName: 'Sepolia',
      husdContract: '0x62C2225D5691515BD4ee36539D127d0dB7dCeb67',
      ownerAddress: '0x64D6407757218ECbFc173C1efE0Fe7EdAaF67cC3',
      treasuryAddress: '0x0B9F043D4BcD45B95B72d4D595dEA8a31acdc017',
      decimals: 6,
      maxMintAmount: 1000000000,
      defaultMintAmount: 1000000,
      explorerUrl: 'https://sepolia.etherscan.io',
    };

    // ERC20 function selectors
    const SELECTORS = {
      mint: '0x40c10f19',
      transfer: '0xa9059cbb',
      balanceOf: '0x70a08231',
      totalSupply: '0x18160ddd',
    };

    // ============================================
    // State
    // ============================================
    let walletAddress = null;
    let isOwner = false;
    let currentChainId = null;
    let currentFilter = null;
    let serverConfig = null;
    let pendingAction = null;
    let pendingTxParams = null;
    let debugInfo = {};

    // ============================================
    // Debug Logging
    // ============================================
    function log(level, message, data = null) {
      const timestamp = new Date().toISOString();
      const logEntry = { timestamp, level, message, data };
      console[level === 'error' ? 'error' : 'log'](`[TokenOps] ${message}`, data || '');

      // Store for debug panel
      if (!window.tokenOpsLogs) window.tokenOpsLogs = [];
      window.tokenOpsLogs.push(logEntry);
      if (window.tokenOpsLogs.length > 50) window.tokenOpsLogs.shift();
    }

    function updateDebugPanel() {
      const content = document.getElementById('debug-content');
      if (!content) return;

      const provider = window.ethereum;
      debugInfo = {
        hasWindowEthereum: !!provider,
        providerType: provider ? (provider.isMetaMask ? 'MetaMask' : provider.isCoinbaseWallet ? 'Coinbase' : 'Unknown') : 'none',
        chainId: currentChainId,
        chainIdHex: currentChainId ? '0x' + currentChainId.toString(16) : null,
        expectedChainId: CONFIG.chainId,
        isCorrectChain: currentChainId === CONFIG.chainId,
        selectedAddress: walletAddress,
        isOwner: isOwner,
        ownerAddress: CONFIG.ownerAddress,
        contract: CONFIG.husdContract,
      };

      if (pendingTxParams) {
        debugInfo.txParams = pendingTxParams;
      }

      content.innerHTML = Object.entries(debugInfo).map(([key, value]) => {
        let valueClass = '';
        if (key === 'hasWindowEthereum' && !value) valueClass = 'error';
        if (key === 'isCorrectChain' && !value) valueClass = 'error';
        if (key === 'isOwner' && !value) valueClass = 'warn';

        const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
        return `<div class="debug-row"><span class="debug-key">${key}</span><span class="debug-value ${valueClass}">${displayValue}</span></div>`;
      }).join('');
    }

    // ============================================
    // Provider Management
    // ============================================
    function getProvider() {
      if (typeof window.ethereum === 'undefined') {
        log('error', 'No ethereum provider found');
        return null;
      }
      return window.ethereum;
    }

    async function ensureConnected() {
      const provider = getProvider();
      if (!provider) {
        throw new Error('No wallet detected. Please use MetaMask browser.');
      }

      log('info', 'Requesting accounts...');
      try {
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        log('info', 'Accounts received', accounts);

        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts returned. Please unlock your wallet.');
        }

        walletAddress = accounts[0].toLowerCase();
        isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();

        return accounts[0];
      } catch (e) {
        log('error', 'eth_requestAccounts failed', { code: e.code, message: e.message });
        throw new Error(`Wallet connection failed: ${e.message} (code: ${e.code || 'unknown'})`);
      }
    }

    async function ensureCorrectChain() {
      const provider = getProvider();
      if (!provider) {
        throw new Error('No wallet provider');
      }

      log('info', 'Checking chain ID...');
      const chainIdHex = await provider.request({ method: 'eth_chainId' });
      currentChainId = parseInt(chainIdHex, 16);
      log('info', 'Current chain', { chainId: currentChainId, expected: CONFIG.chainId });

      if (currentChainId !== CONFIG.chainId) {
        log('info', 'Switching to Sepolia...');
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CONFIG.chainIdHex }],
          });
          log('info', 'Chain switched successfully');
        } catch (switchError) {
          log('error', 'Chain switch failed', { code: switchError.code, message: switchError.message });

          if (switchError.code === 4902) {
            log('info', 'Adding Sepolia chain...');
            try {
              await provider.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: CONFIG.chainIdHex,
                  chainName: 'Sepolia Testnet',
                  nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                  rpcUrls: ['https://rpc.sepolia.org'],
                  blockExplorerUrls: ['https://sepolia.etherscan.io'],
                }],
              });
              log('info', 'Sepolia chain added');
            } catch (addError) {
              log('error', 'Failed to add Sepolia', { code: addError.code, message: addError.message });
              throw new Error(`Failed to add Sepolia network: ${addError.message}`);
            }
          } else if (switchError.code === 4001) {
            throw new Error('You rejected the network switch. Please switch to Sepolia manually.');
          } else {
            throw new Error(`Failed to switch network: ${switchError.message} (code: ${switchError.code})`);
          }
        }

        // Re-check chain after switch
        const newChainIdHex = await provider.request({ method: 'eth_chainId' });
        currentChainId = parseInt(newChainIdHex, 16);

        if (currentChainId !== CONFIG.chainId) {
          throw new Error(`Still on wrong chain (${currentChainId}). Please switch to Sepolia manually.`);
        }
      }

      return true;
    }

    async function estimateGas(txParams) {
      const provider = getProvider();
      if (!provider) throw new Error('No provider');

      log('info', 'Estimating gas...', txParams);
      try {
        const gasEstimate = await provider.request({
          method: 'eth_estimateGas',
          params: [txParams],
        });
        log('info', 'Gas estimate', { gas: gasEstimate, decimal: parseInt(gasEstimate, 16) });
        return gasEstimate;
      } catch (e) {
        log('error', 'Gas estimation failed', { code: e.code, message: e.message, data: e.data });

        // Parse revert reason if available
        let reason = e.message;
        if (e.data && typeof e.data === 'string') {
          reason += ` (data: ${e.data})`;
        }
        if (e.message.includes('execution reverted')) {
          reason = 'Transaction would fail. Check: 1) You are the contract owner, 2) Sufficient balance';
        }

        throw new Error(`Transaction would fail: ${reason}`);
      }
    }

    // ============================================
    // Wallet Connection UI
    // ============================================
    async function connectWallet() {
      log('info', 'Connect wallet clicked');

      const provider = getProvider();
      if (!provider) {
        alert('No wallet detected. Please open this page in MetaMask browser or install MetaMask extension.');
        return;
      }

      try {
        await ensureConnected();
        await ensureCorrectChain();

        // Listen for changes
        provider.on('accountsChanged', handleAccountsChanged);
        provider.on('chainChanged', handleChainChanged);

        updateWalletUI();
        await refreshOnchainData();
        log('info', 'Wallet connected successfully');
      } catch (e) {
        log('error', 'Wallet connection failed', { message: e.message });
        alert('Failed to connect: ' + e.message);
      }
    }

    function handleAccountsChanged(accounts) {
      log('info', 'Accounts changed', accounts);
      if (accounts.length === 0) {
        walletAddress = null;
        isOwner = false;
      } else {
        walletAddress = accounts[0].toLowerCase();
        isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();
      }
      updateWalletUI();
      refreshOnchainData();
    }

    function handleChainChanged(chainIdHex) {
      log('info', 'Chain changed', chainIdHex);
      currentChainId = parseInt(chainIdHex, 16);
      updateWalletUI();
      refreshOnchainData();
    }

    async function switchToSepolia() {
      try {
        await ensureCorrectChain();
        updateWalletUI();
      } catch (e) {
        alert(e.message);
      }
    }

    function updateWalletUI() {
      const walletSection = document.getElementById('wallet-section');
      if (!walletSection) return;

      const isCorrectChain = currentChainId === CONFIG.chainId;

      if (walletAddress) {
        const shortAddr = walletAddress.substring(0, 6) + '...' + walletAddress.substring(38);
        walletSection.innerHTML = `
          <button class="wallet-btn connected">${shortAddr}</button>
          <span class="wallet-badge ${isOwner ? 'owner' : 'not-owner'}">${isOwner ? 'OWNER' : 'NOT OWNER'}</span>
          <span class="chain-badge ${isCorrectChain ? 'correct' : 'wrong'}" id="chain-badge">
            ${isCorrectChain ? 'Sepolia' : 'Wrong Chain!'}
          </span>
        `;

        // Add click handler for wrong chain badge
        if (!isCorrectChain) {
          document.getElementById('chain-badge').addEventListener('click', switchToSepolia);
        }
      } else {
        walletSection.innerHTML = `
          <button class="wallet-btn" id="connect-wallet-btn">Connect Wallet</button>
        `;
        document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);
      }

      updateButtonStates();
    }

    function updateButtonStates() {
      const mintBtn = document.getElementById('mint-btn');
      const transferBtn = document.getElementById('transfer-btn');
      const isCorrectChain = currentChainId === CONFIG.chainId;
      const canExecute = walletAddress && isOwner && isCorrectChain;

      if (mintBtn) {
        mintBtn.disabled = !canExecute;
        if (!walletAddress) {
          mintBtn.textContent = 'Connect Wallet First';
        } else if (!isOwner) {
          mintBtn.textContent = `Owner only: ${CONFIG.ownerAddress.substring(0, 10)}...`;
        } else if (!isCorrectChain) {
          mintBtn.textContent = 'Switch to Sepolia';
        } else {
          mintBtn.textContent = 'Mint hUSD';
        }
      }

      if (transferBtn) {
        transferBtn.disabled = !canExecute;
        if (!walletAddress) {
          transferBtn.textContent = 'Connect Wallet First';
        } else if (!isOwner) {
          transferBtn.textContent = `Owner only: ${CONFIG.ownerAddress.substring(0, 10)}...`;
        } else if (!isCorrectChain) {
          transferBtn.textContent = 'Switch to Sepolia';
        } else {
          transferBtn.textContent = 'Transfer to Treasury';
        }
      }
    }

    // ============================================
    // On-chain Reads
    // ============================================
    async function readContract(selector, params = '') {
      const provider = getProvider();
      if (!provider) return null;

      const data = selector + params;
      const result = await provider.request({
        method: 'eth_call',
        params: [{ to: CONFIG.husdContract, data }, 'latest'],
      });
      return result;
    }

    async function getTotalSupply() {
      try {
        const result = await readContract(SELECTORS.totalSupply);
        if (!result) return null;
        const raw = BigInt(result);
        return Number(raw / BigInt(10 ** CONFIG.decimals));
      } catch (e) {
        log('error', 'getTotalSupply error', e.message);
        return null;
      }
    }

    async function getBalance(address) {
      try {
        const paddedAddress = address.toLowerCase().replace('0x', '').padStart(64, '0');
        const result = await readContract(SELECTORS.balanceOf, paddedAddress);
        if (!result) return null;
        const raw = BigInt(result);
        return Number(raw / BigInt(10 ** CONFIG.decimals));
      } catch (e) {
        log('error', 'getBalance error', e.message);
        return null;
      }
    }

    async function refreshOnchainData() {
      if (!walletAddress) return;

      try {
        const [totalSupply, ownerBalance, treasuryBalance] = await Promise.all([
          getTotalSupply(),
          getBalance(CONFIG.ownerAddress),
          getBalance(CONFIG.treasuryAddress),
        ]);

        const totalSupplyEl = document.getElementById('total-supply');
        const ownerBalanceEl = document.getElementById('owner-balance');
        const treasuryBalanceEl = document.getElementById('treasury-balance-live');

        if (totalSupplyEl && totalSupply !== null) {
          totalSupplyEl.textContent = totalSupply.toLocaleString() + ' hUSD';
        }
        if (ownerBalanceEl && ownerBalance !== null) {
          ownerBalanceEl.textContent = ownerBalance.toLocaleString() + ' hUSD';
        }
        if (treasuryBalanceEl && treasuryBalance !== null) {
          treasuryBalanceEl.textContent = treasuryBalance.toLocaleString() + ' hUSD';
        }
      } catch (e) {
        log('error', 'refreshOnchainData error', e.message);
      }
    }

    // ============================================
    // Modal Management
    // ============================================
    function showConfirmModal(action, title, details, btnClass, txParams) {
      pendingAction = action;
      pendingTxParams = txParams;

      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-content').innerHTML = details.map(d => `
        <div class="modal-row">
          <span class="modal-label">${d.label}</span>
          <span class="modal-value">${d.value}</span>
        </div>
      `).join('');

      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.className = 'modal-btn confirm ' + btnClass;
      confirmBtn.textContent = 'Confirm ' + (btnClass === 'mint' ? 'Mint' : 'Transfer');
      confirmBtn.disabled = false;

      // Reset status
      const statusEl = document.getElementById('modal-status');
      statusEl.className = 'modal-status';
      statusEl.textContent = '';

      // Update debug panel
      updateDebugPanel();

      document.getElementById('confirm-modal').classList.add('show');
      log('info', 'Modal shown', { title, txParams });
    }

    function closeModal() {
      document.getElementById('confirm-modal').classList.remove('show');
      pendingAction = null;
      pendingTxParams = null;
    }

    function setModalStatus(message, type) {
      const statusEl = document.getElementById('modal-status');
      statusEl.className = 'modal-status show ' + type;
      statusEl.textContent = message;
    }

    async function executeConfirmed() {
      if (!pendingAction) {
        log('error', 'No pending action');
        return;
      }

      const confirmBtn = document.getElementById('modal-confirm-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');

      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      setModalStatus('Preparing transaction...', 'info');
      log('info', 'Execute confirmed clicked');

      try {
        // Step 1: Ensure wallet is connected
        setModalStatus('Connecting wallet...', 'info');
        await ensureConnected();
        updateDebugPanel();

        // Step 2: Ensure correct chain
        setModalStatus('Checking network...', 'info');
        await ensureCorrectChain();
        updateDebugPanel();

        // Step 3: Estimate gas (validates tx will succeed)
        setModalStatus('Validating transaction...', 'info');
        if (pendingTxParams) {
          await estimateGas(pendingTxParams);
        }

        // Step 4: Execute the action
        setModalStatus('Waiting for wallet confirmation...', 'info');
        closeModal();
        await pendingAction();

      } catch (e) {
        log('error', 'Transaction failed', { code: e.code, message: e.message });
        setModalStatus(`Error: ${e.message}`, 'error');
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        confirmBtn.textContent = 'Retry';
        updateDebugPanel();

        // Add error to debug info
        debugInfo.lastError = { code: e.code, message: e.message };
        updateDebugPanel();
      }
    }

    // ============================================
    // Owner Actions
    // ============================================
    function prepareMint() {
      log('info', 'Prepare mint clicked');

      const toSelect = document.getElementById('mint-to');
      const amountInput = document.getElementById('mint-amount');
      const to = toSelect.value;
      const amount = parseInt(amountInput.value) || CONFIG.defaultMintAmount;

      if (amount <= 0 || amount > CONFIG.maxMintAmount) {
        showMintStatus(`Invalid amount. Must be 1 - ${CONFIG.maxMintAmount.toLocaleString()}`, 'error');
        return;
      }

      // Build tx params for gas estimation
      const paddedTo = to.toLowerCase().replace('0x', '').padStart(64, '0');
      const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
      const paddedAmount = amountWei.toString(16).padStart(64, '0');
      const data = SELECTORS.mint + paddedTo + paddedAmount;

      const txParams = {
        from: walletAddress,
        to: CONFIG.husdContract,
        data: data,
      };

      const toLabel = to.toLowerCase() === CONFIG.ownerAddress.toLowerCase() ? 'Owner' : 'Treasury';
      const toShort = to.substring(0, 10) + '...' + to.substring(36);

      showConfirmModal(
        () => executeMint(to, amount),
        'Confirm Mint',
        [
          { label: 'Network', value: CONFIG.chainName },
          { label: 'Contract', value: CONFIG.husdContract.substring(0, 14) + '...' },
          { label: 'To', value: `${toLabel} (${toShort})` },
          { label: 'Amount', value: amount.toLocaleString() + ' hUSD' },
        ],
        'mint',
        txParams
      );
    }

    async function executeMint(to, amount) {
      const btn = document.getElementById('mint-btn');

      btn.disabled = true;
      btn.textContent = 'Minting...';
      showMintStatus('Sending transaction to MetaMask...', 'info');
      log('info', 'Executing mint', { to, amount });

      try {
        const provider = getProvider();
        if (!provider) throw new Error('No wallet provider');

        // Build transaction
        const paddedTo = to.toLowerCase().replace('0x', '').padStart(64, '0');
        const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
        const paddedAmount = amountWei.toString(16).padStart(64, '0');
        const data = SELECTORS.mint + paddedTo + paddedAmount;

        const txParams = {
          from: walletAddress,
          to: CONFIG.husdContract,
          data: data,
        };

        log('info', 'Sending eth_sendTransaction', txParams);

        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        log('info', 'Transaction sent', { txHash });

        showMintStatus(
          `Mint submitted! <a href="${CONFIG.explorerUrl}/tx/${txHash}" target="_blank" class="tx-link">${txHash.substring(0, 20)}...</a>`,
          'success'
        );

        logTokenOp('owner_mint', txHash, walletAddress, to, amount);

        setTimeout(() => {
          refreshOnchainData();
          loadTokenOps(currentFilter);
        }, 5000);

      } catch (e) {
        log('error', 'Mint failed', { code: e.code, message: e.message });

        let errorMsg = e.message;
        if (e.code === 4001) {
          errorMsg = 'Transaction rejected by user';
        } else if (e.code === -32603) {
          errorMsg = 'Internal error. Check if you are the contract owner.';
        }

        showMintStatus(`Failed: ${errorMsg} (code: ${e.code || 'unknown'})`, 'error');
      } finally {
        btn.disabled = false;
        updateButtonStates();
      }
    }

    function showMintStatus(message, type) {
      const statusDiv = document.getElementById('mint-status');
      if (statusDiv) {
        statusDiv.className = 'status-msg ' + type;
        statusDiv.innerHTML = message;
      }
    }

    function prepareTransfer() {
      log('info', 'Prepare transfer clicked');

      const amountInput = document.getElementById('transfer-amount');
      const amount = parseInt(amountInput.value) || CONFIG.defaultMintAmount;

      if (amount <= 0 || amount > CONFIG.maxMintAmount) {
        showTransferStatus(`Invalid amount. Must be 1 - ${CONFIG.maxMintAmount.toLocaleString()}`, 'error');
        return;
      }

      // Build tx params for gas estimation
      const paddedTo = CONFIG.treasuryAddress.toLowerCase().replace('0x', '').padStart(64, '0');
      const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
      const paddedAmount = amountWei.toString(16).padStart(64, '0');
      const data = SELECTORS.transfer + paddedTo + paddedAmount;

      const txParams = {
        from: walletAddress,
        to: CONFIG.husdContract,
        data: data,
      };

      showConfirmModal(
        () => executeTransfer(amount),
        'Confirm Transfer',
        [
          { label: 'Network', value: CONFIG.chainName },
          { label: 'Contract', value: CONFIG.husdContract.substring(0, 14) + '...' },
          { label: 'From', value: 'Owner (' + CONFIG.ownerAddress.substring(0, 10) + '...)' },
          { label: 'To', value: 'Treasury (' + CONFIG.treasuryAddress.substring(0, 10) + '...)' },
          { label: 'Amount', value: amount.toLocaleString() + ' hUSD' },
        ],
        'transfer',
        txParams
      );
    }

    async function executeTransfer(amount) {
      const btn = document.getElementById('transfer-btn');

      btn.disabled = true;
      btn.textContent = 'Transferring...';
      showTransferStatus('Sending transaction to MetaMask...', 'info');
      log('info', 'Executing transfer', { amount });

      try {
        const provider = getProvider();
        if (!provider) throw new Error('No wallet provider');

        const paddedTo = CONFIG.treasuryAddress.toLowerCase().replace('0x', '').padStart(64, '0');
        const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
        const paddedAmount = amountWei.toString(16).padStart(64, '0');
        const data = SELECTORS.transfer + paddedTo + paddedAmount;

        const txParams = {
          from: walletAddress,
          to: CONFIG.husdContract,
          data: data,
        };

        log('info', 'Sending eth_sendTransaction', txParams);

        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        log('info', 'Transaction sent', { txHash });

        showTransferStatus(
          `Transfer submitted! <a href="${CONFIG.explorerUrl}/tx/${txHash}" target="_blank" class="tx-link">${txHash.substring(0, 20)}...</a>`,
          'success'
        );

        logTokenOp('owner_transfer', txHash, walletAddress, CONFIG.treasuryAddress, amount);

        setTimeout(() => {
          refreshOnchainData();
          loadTokenOps(currentFilter);
        }, 5000);

      } catch (e) {
        log('error', 'Transfer failed', { code: e.code, message: e.message });

        let errorMsg = e.message;
        if (e.code === 4001) {
          errorMsg = 'Transaction rejected by user';
        } else if (e.code === -32603) {
          errorMsg = 'Internal error. Check if you have sufficient balance.';
        }

        showTransferStatus(`Failed: ${errorMsg} (code: ${e.code || 'unknown'})`, 'error');
      } finally {
        btn.disabled = false;
        updateButtonStates();
      }
    }

    function showTransferStatus(message, type) {
      const statusDiv = document.getElementById('transfer-status');
      if (statusDiv) {
        statusDiv.className = 'status-msg ' + type;
        statusDiv.innerHTML = message;
      }
    }

    // ============================================
    // Backend Logging
    // ============================================
    async function logTokenOp(type, txHash, from, to, amount) {
      try {
        await HumanAds.fetchApi('/api/admin/token-ops/log', {
          method: 'POST',
          body: JSON.stringify({
            type,
            tx_hash: txHash,
            from_address: from,
            to_address: to,
            amount_cents: amount * 100,
            chain_id: CONFIG.chainId,
          }),
        });
      } catch (e) {
        log('error', 'Failed to log token op', e.message);
      }
    }

    // ============================================
    // Server Data Loading
    // ============================================
    async function loadBalances() {
      try {
        const res = await HumanAds.fetchApi('/api/admin/token-ops/balances');
        if (res.success) return res.data;
      } catch (e) {
        log('error', 'Failed to load balances', e.message);
      }
      return null;
    }

    async function loadTokenOps(filter = null) {
      currentFilter = filter;
      const content = document.getElementById('content');

      try {
        const [balances, opsRes] = await Promise.all([
          loadBalances(),
          HumanAds.fetchApi(filter ? `/api/admin/token-ops?op_type=${filter}` : '/api/admin/token-ops')
        ]);

        if (!opsRes.success) {
          content.innerHTML = `<div class="empty">Error: ${opsRes.error?.message || 'Failed to load'}</div>`;
          return;
        }

        const ops = opsRes.data.token_ops || [];
        serverConfig = balances?.config || {};

        content.innerHTML = `
          <div class="admin-header">
            <h1>Token Ops (hUSD)</h1>
            <div class="wallet-section" id="wallet-section">
              <button class="wallet-btn" id="connect-wallet-btn">Connect Wallet</button>
            </div>
          </div>

          <h2 class="section-title">Owner Operations (MetaMask)</h2>
          <div class="cards-grid">
            <div class="card owner-card">
              <div class="card-header">
                <span class="card-title">Owner Mint</span>
              </div>
              <div class="owner-form">
                <div class="form-group">
                  <label class="form-label">Mint To</label>
                  <select id="mint-to" class="form-select">
                    <option value="${CONFIG.ownerAddress}">Owner (${CONFIG.ownerAddress.substring(0, 10)}...)</option>
                    <option value="${CONFIG.treasuryAddress}">Treasury (${CONFIG.treasuryAddress.substring(0, 10)}...)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Amount (hUSD)</label>
                  <input type="number" id="mint-amount" class="form-input" value="${CONFIG.defaultMintAmount}" min="1" max="${CONFIG.maxMintAmount}" />
                  <span class="form-hint">Max: ${CONFIG.maxMintAmount.toLocaleString()}</span>
                </div>
                <button class="action-btn mint" id="mint-btn" disabled>Connect Wallet First</button>
                <div id="mint-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Total Supply:</span>
                  <span class="config-value" id="total-supply">-</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Owner Balance:</span>
                  <span class="config-value" id="owner-balance">-</span>
                </div>
              </div>
            </div>

            <div class="card owner-card">
              <div class="card-header">
                <span class="card-title">Owner -> Treasury Transfer</span>
              </div>
              <div class="owner-form">
                <div class="form-group">
                  <label class="form-label">To (Fixed)</label>
                  <input type="text" class="form-input" value="${CONFIG.treasuryAddress}" disabled />
                  <span class="form-hint fixed">Treasury address - cannot be changed</span>
                </div>
                <div class="form-group">
                  <label class="form-label">Amount (hUSD)</label>
                  <input type="number" id="transfer-amount" class="form-input" value="${CONFIG.defaultMintAmount}" min="1" max="${CONFIG.maxMintAmount}" />
                </div>
                <button class="action-btn transfer" id="transfer-btn" disabled>Connect Wallet First</button>
                <div id="transfer-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Treasury Balance:</span>
                  <span class="config-value" id="treasury-balance-live">-</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Contract:</span>
                  <span class="config-value">${CONFIG.husdContract.substring(0, 10)}...</span>
                </div>
              </div>
            </div>
          </div>

          <h2 class="section-title">Treasury Operations (Server)</h2>
          <div class="cards-grid">
            <div class="card faucet-card">
              <div class="card-header">
                <span class="card-title">Faucet (Advertiser)</span>
              </div>
              <div class="faucet-form">
                <input type="text" id="faucet-address" class="faucet-input" placeholder="0x... Advertiser Address" />
                <div class="faucet-amount">
                  <span>Amount:</span>
                  <span class="faucet-amount-value">$${((serverConfig.faucet_amount_cents || 100000) / 100).toLocaleString()}</span>
                  <span style="color: var(--color-text-muted)">hUSD</span>
                </div>
                <button class="action-btn" id="faucet-btn">Send hUSD</button>
                <div id="faucet-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Cooldown:</span>
                  <span class="config-value">${Math.floor((serverConfig.faucet_cooldown_seconds || 86400) / 3600)}h</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Treasury Key:</span>
                  <span class="config-value">${serverConfig.has_treasury_key ? 'Configured' : 'Not set'}</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Mode:</span>
                  <span class="config-value">${serverConfig.payout_mode || 'ledger'}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Treasury Balance (Server)</span>
              </div>
              <div class="card-value">${balances?.treasury ? balances.treasury.husd_display : '-'}</div>
              <div class="card-sub">hUSD (${balances?.treasury?.eth || '0'} ETH for gas)</div>
              ${balances?.treasury?.address ? `<div class="config-info"><div class="config-row"><span class="config-label">Address:</span><span class="config-value">${balances.treasury.address.substring(0, 14)}...</span></div></div>` : ''}
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Admin Balance (Server)</span>
              </div>
              <div class="card-value">${balances?.admin ? balances.admin.husd_display : '-'}</div>
              <div class="card-sub">hUSD (${balances?.admin?.eth || '0'} ETH for gas)</div>
              ${balances?.admin?.address ? `<div class="config-info"><div class="config-row"><span class="config-label">Address:</span><span class="config-value">${balances.admin.address.substring(0, 14)}...</span></div></div>` : ''}
            </div>
          </div>

          <h2 class="section-title">Recent Operations (${ops.length})</h2>

          <div class="filters">
            <span class="filter-chip ${!filter ? 'active' : ''}" data-filter="">All</span>
            <span class="filter-chip ${filter === 'faucet' ? 'active' : ''}" data-filter="faucet">Faucet</span>
            <span class="filter-chip ${filter === 'mint' ? 'active' : ''}" data-filter="mint">Mint</span>
            <span class="filter-chip ${filter === 'owner_mint' ? 'active' : ''}" data-filter="owner_mint">Owner Mint</span>
            <span class="filter-chip ${filter === 'transfer' ? 'active' : ''}" data-filter="transfer">Transfer</span>
            <span class="filter-chip ${filter === 'owner_transfer' ? 'active' : ''}" data-filter="owner_transfer">Owner Transfer</span>
          </div>

          <div class="table-container">
            ${ops.length === 0 ? '<div class="empty">No token operations found</div>' : `
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Amount</th>
                    <th>TX Hash</th>
                    <th>Status</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody>
                  ${ops.map(op => `
                    <tr>
                      <td class="id-cell">${op.id.substring(0,8)}...</td>
                      <td><span class="type-badge ${op.op_type}">${op.op_type}</span></td>
                      <td class="address-cell" title="${op.from_address || ''}">${op.from_address ? op.from_address.substring(0, 10) + '...' : '-'}</td>
                      <td class="address-cell" title="${op.to_address}">${op.to_address ? op.to_address.substring(0, 10) + '...' : '-'}</td>
                      <td>${HumanAds.formatCurrency(op.amount_cents)}</td>
                      <td>${op.tx_hash ? (op.tx_hash.startsWith('SIMULATED_') ?
                        `<span class="id-cell">${op.tx_hash.substring(0, 16)}...</span>` :
                        `<a href="${CONFIG.explorerUrl}/tx/${op.tx_hash}" target="_blank" class="tx-link">${op.tx_hash.substring(0, 10)}...</a>`) : '-'}</td>
                      <td><span class="status-badge ${op.status}">${op.status}</span></td>
                      <td>${HumanAds.formatDate(op.created_at)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `}
          </div>
        `;

        // Attach event listeners
        attachEventListeners();

        // Update wallet UI if connected
        if (walletAddress) {
          updateWalletUI();
          refreshOnchainData();
        }
      } catch (e) {
        content.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
      }
    }

    function attachEventListeners() {
      // Connect wallet button
      const connectBtn = document.getElementById('connect-wallet-btn');
      if (connectBtn) {
        connectBtn.addEventListener('click', connectWallet);
      }

      // Mint button
      const mintBtn = document.getElementById('mint-btn');
      if (mintBtn) {
        mintBtn.addEventListener('click', prepareMint);
      }

      // Transfer button
      const transferBtn = document.getElementById('transfer-btn');
      if (transferBtn) {
        transferBtn.addEventListener('click', prepareTransfer);
      }

      // Faucet button
      const faucetBtn = document.getElementById('faucet-btn');
      if (faucetBtn) {
        faucetBtn.addEventListener('click', sendFaucet);
      }

      // Filter chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const filter = chip.dataset.filter || null;
          loadTokenOps(filter);
        });
      });
    }

    async function sendFaucet() {
      const addressInput = document.getElementById('faucet-address');
      const btn = document.getElementById('faucet-btn');
      const statusDiv = document.getElementById('faucet-status');

      const address = addressInput.value.trim();
      if (!address || !address.startsWith('0x')) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = 'Please enter a valid 0x address';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending...';
      statusDiv.className = '';
      statusDiv.textContent = '';

      try {
        const res = await HumanAds.fetchApi('/api/admin/faucet', {
          method: 'POST',
          body: JSON.stringify({ advertiser_address: address })
        });

        if (res.success) {
          statusDiv.className = 'status-msg success';
          const amount = res.data.amount_cents ? `$${(res.data.amount_cents / 100).toLocaleString()}` : '';
          statusDiv.innerHTML = `Sent ${amount} hUSD! <a href="${CONFIG.explorerUrl}/tx/${res.data.tx_hash}" target="_blank" class="tx-link">${res.data.tx_hash?.substring(0, 20) || 'pending'}...</a>`;
          addressInput.value = '';
          setTimeout(() => loadTokenOps(currentFilter), 2000);
        } else {
          statusDiv.className = 'status-msg error';
          statusDiv.textContent = res.error?.message || 'Faucet failed';
        }
      } catch (e) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = e.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send hUSD';
      }
    }

    // ============================================
    // Modal Event Listeners
    // ============================================
    function initModalListeners() {
      // Cancel button
      document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);

      // Confirm button - use both click and touchend for iOS
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        executeConfirmed();
      });

      // Debug toggle
      document.getElementById('debug-toggle').addEventListener('click', () => {
        const content = document.getElementById('debug-content');
        const arrow = document.getElementById('debug-arrow');
        if (content.classList.contains('show')) {
          content.classList.remove('show');
          arrow.textContent = '+';
        } else {
          content.classList.add('show');
          arrow.textContent = '-';
          updateDebugPanel();
        }
      });

      // Close on overlay click
      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.id === 'confirm-modal') {
          closeModal();
        }
      });
    }

    // ============================================
    // Initialization
    // ============================================
    (async function() {
      log('info', 'Initializing Token Ops page');

      const meRes = await HumanAds.fetchApi('/me');
      if (!meRes.success || !meRes.data?.user?.is_admin) {
        window.location.href = '/admin';
        return;
      }

      await loadTokenOps();
      SideMenu.init(true, true);
      initModalListeners();

      // Auto-connect if MetaMask is already connected
      const provider = getProvider();
      if (provider) {
        try {
          const accounts = await provider.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            log('info', 'Auto-connecting with existing session');
            walletAddress = accounts[0].toLowerCase();
            isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();
            const chainId = await provider.request({ method: 'eth_chainId' });
            currentChainId = parseInt(chainId, 16);
            provider.on('accountsChanged', handleAccountsChanged);
            provider.on('chainChanged', handleChainChanged);
            updateWalletUI();
            refreshOnchainData();
          }
        } catch (e) {
          log('error', 'Auto-connect failed', e.message);
        }
      }

      log('info', 'Token Ops page initialized');
    })();
  </script>
</body>
</html>
