<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Ops - Admin - HumanAds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    .admin-page { padding: 24px 16px; max-width: 1200px; margin: 0 auto; }
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .admin-header h1 { font-family: var(--font-mono); font-size: 1.5rem; }

    /* Wallet Connection - Enhanced */
    .wallet-section { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; position: relative; }

    /* Wallet Pill - State-aware button */
    .wallet-pill {
      display: flex; align-items: center; gap: 8px; padding: 8px 12px;
      background: var(--color-surface); border: 1px solid var(--color-border);
      border-radius: 24px; font-family: var(--font-mono); font-size: 0.75rem;
      cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    }
    .wallet-pill:hover { border-color: var(--color-primary); }
    .wallet-pill:active { opacity: 0.7; }

    /* Wallet Pill States */
    .wallet-pill.not-connected {
      background: rgba(255,59,48,0.1); border-color: rgba(255,59,48,0.3); color: #ff3b30;
    }
    .wallet-pill.connected {
      background: rgba(52,199,89,0.1); border-color: rgba(52,199,89,0.3); color: #34c759;
    }
    .wallet-pill.wrong-network {
      background: rgba(255,149,0,0.1); border-color: rgba(255,149,0,0.3); color: #ff9500;
    }
    .wallet-pill.verifying {
      background: rgba(0,122,255,0.1); border-color: rgba(0,122,255,0.3); color: #007aff;
    }

    .wallet-pill-icon { width: 16px; height: 16px; }
    .wallet-pill-main { display: flex; flex-direction: column; align-items: flex-start; }
    .wallet-pill-label { font-weight: 600; }
    .wallet-pill-sub { font-size: 0.65rem; opacity: 0.7; }
    .wallet-pill-arrow { opacity: 0.5; font-size: 0.6rem; }

    /* Wallet Badges */
    .wallet-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; }
    .wallet-badge.owner { background: rgba(255,107,53,0.2); color: #ff6b35; }
    .wallet-badge.not-owner { background: rgba(255,59,48,0.2); color: #ff3b30; }

    /* Action Sheet */
    .action-sheet-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
    }
    .action-sheet-overlay.show { display: block; }
    .action-sheet {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--color-surface); border-radius: 16px 16px 0 0;
      padding: 16px; padding-bottom: max(16px, env(safe-area-inset-bottom));
      z-index: 1001; transform: translateY(100%); transition: transform 0.3s ease-out;
    }
    .action-sheet-overlay.show .action-sheet { transform: translateY(0); }
    .action-sheet-header {
      text-align: center; padding-bottom: 12px; margin-bottom: 12px;
      border-bottom: 1px solid var(--color-border);
    }
    .action-sheet-title { font-family: var(--font-mono); font-size: 0.875rem; font-weight: 600; }
    .action-sheet-subtitle { font-size: 0.7rem; color: var(--color-text-muted); margin-top: 4px; }
    .action-sheet-btn {
      width: 100%; padding: 14px; margin-bottom: 8px; border-radius: 10px;
      font-family: var(--font-mono); font-size: 0.875rem; font-weight: 500;
      background: var(--color-bg); border: 1px solid var(--color-border);
      color: var(--color-text); cursor: pointer; text-align: center;
      -webkit-tap-highlight-color: transparent;
    }
    .action-sheet-btn:hover { background: rgba(255,255,255,0.05); }
    .action-sheet-btn:active { opacity: 0.7; }
    .action-sheet-btn.primary { background: var(--color-primary); border-color: var(--color-primary); color: white; }
    .action-sheet-btn.danger { color: #ff3b30; }
    .action-sheet-btn.cancel { margin-top: 8px; font-weight: 600; }

    /* Cards */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .card-title { font-family: var(--font-mono); font-size: 0.875rem; color: var(--color-text-muted); text-transform: uppercase; }
    .card-value { font-family: var(--font-mono); font-size: 1.75rem; font-weight: 600; }
    .card-sub { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }

    /* Owner Cards */
    .owner-card { background: linear-gradient(135deg, rgba(52,199,89,0.1) 0%, rgba(0,122,255,0.05) 100%); border-color: rgba(52,199,89,0.3); }
    .owner-form { display: flex; flex-direction: column; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-label { font-size: 0.75rem; color: var(--color-text-muted); font-family: var(--font-mono); }
    .form-input { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); }
    .form-input:focus { outline: none; border-color: var(--color-primary); }
    .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
    .form-input::placeholder { color: var(--color-text-muted); }
    .form-select { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); cursor: pointer; }
    .form-hint { font-size: 0.7rem; color: var(--color-text-muted); }
    .form-hint.fixed { background: rgba(255,149,0,0.1); padding: 4px 8px; border-radius: 4px; }

    /* Faucet Form */
    .faucet-card { background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,149,0,0.05) 100%); border-color: rgba(255,107,53,0.3); }
    .faucet-form { display: flex; flex-direction: column; gap: 12px; }
    .faucet-input { width: 100%; padding: 12px; font-family: var(--font-mono); font-size: 0.875rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); }
    .faucet-input:focus { outline: none; border-color: var(--color-primary); }
    .faucet-input::placeholder { color: var(--color-text-muted); }
    .faucet-amount { display: flex; align-items: center; gap: 8px; }
    .faucet-amount-value { font-family: var(--font-mono); font-size: 1.25rem; font-weight: 600; color: var(--color-primary); }

    /* Buttons */
    .action-btn { padding: 12px 24px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-family: var(--font-mono); font-weight: 600; cursor: pointer; transition: opacity 0.2s; width: 100%; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .action-btn:hover { opacity: 0.9; }
    .action-btn:active { opacity: 0.7; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .action-btn.mint { background: #34c759; }
    .action-btn.transfer { background: #007aff; }
    .status-msg { font-size: 0.75rem; padding: 8px; border-radius: 4px; margin-top: 8px; word-break: break-all; }
    .status-msg.success { background: rgba(52,199,89,0.2); color: #34c759; }
    .status-msg.error { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .status-msg.info { background: rgba(0,122,255,0.2); color: #007aff; }

    /* Config Info */
    .config-info { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border); }
    .config-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .config-label { opacity: 0.7; }
    .config-value { font-family: var(--font-mono); }

    /* Table */
    .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-family: var(--font-mono); background: var(--color-surface); border: 1px solid var(--color-border); cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .filter-chip:hover, .filter-chip.active { border-color: var(--color-primary); color: var(--color-primary); }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 0.875rem; }
    .data-table th { font-family: var(--font-mono); font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; }
    .data-table tr:hover { background: rgba(255,255,255,0.02); }
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-family: var(--font-mono); font-weight: 600; }
    .status-badge.confirmed { background: rgba(52,199,89,0.2); color: #34c759; }
    .status-badge.submitted { background: rgba(0,122,255,0.2); color: #007aff; }
    .status-badge.pending { background: rgba(255,149,0,0.2); color: #ff9500; }
    .status-badge.failed { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .type-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-family: var(--font-mono); }
    .type-badge.faucet { background: rgba(255,107,53,0.2); color: #ff6b35; }
    .type-badge.mint { background: rgba(52,199,89,0.2); color: #34c759; }
    .type-badge.transfer { background: rgba(0,122,255,0.2); color: #007aff; }
    .type-badge.owner_mint { background: rgba(52,199,89,0.2); color: #34c759; }
    .type-badge.owner_transfer { background: rgba(0,122,255,0.2); color: #007aff; }
    .loading, .empty { text-align: center; padding: 40px; color: var(--color-text-muted); }
    .id-cell { font-family: var(--font-mono); font-size: 0.75rem; color: var(--color-text-muted); }
    .address-cell { font-family: var(--font-mono); font-size: 0.7rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
    .table-container { overflow-x: auto; }
    .section-title { font-family: var(--font-mono); font-size: 1rem; margin: 24px 0 16px; }

    /* TX Hash link */
    .tx-link { color: var(--color-primary); text-decoration: none; font-family: var(--font-mono); font-size: 0.7rem; }
    .tx-link:hover { text-decoration: underline; }

    /* Confirmation Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 16px; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 24px; max-width: 420px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-family: var(--font-mono); font-size: 1.25rem; margin-bottom: 16px; }
    .modal-content { margin-bottom: 20px; }
    .modal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border); font-size: 0.875rem; }
    .modal-row:last-child { border-bottom: none; }
    .modal-label { color: var(--color-text-muted); }
    .modal-value { font-family: var(--font-mono); text-align: right; word-break: break-all; max-width: 200px; }
    .modal-actions { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 14px; border-radius: 8px; font-family: var(--font-mono); font-weight: 600; cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; font-size: 1rem; }
    .modal-btn:active { opacity: 0.7; }
    .modal-btn.cancel { background: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text); }
    .modal-btn.confirm { background: var(--color-primary); border: none; color: white; }
    .modal-btn.confirm.mint { background: #34c759; }
    .modal-btn.confirm.transfer { background: #007aff; }
    .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Debug Panel - Enhanced */
    .debug-panel { margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.7rem; font-family: var(--font-mono); }
    .debug-toggle { cursor: pointer; color: var(--color-text-muted); display: flex; align-items: center; gap: 4px; }
    .debug-toggle:hover { color: var(--color-text); }
    .debug-content { margin-top: 8px; display: none; }
    .debug-content.show { display: block; }
    .debug-section { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .debug-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .debug-section-title { color: var(--color-primary); font-weight: 600; margin-bottom: 4px; }
    .debug-row { display: flex; justify-content: space-between; padding: 2px 0; }
    .debug-key { color: var(--color-text-muted); }
    .debug-value { color: #34c759; word-break: break-all; max-width: 200px; text-align: right; }
    .debug-value.error { color: #ff3b30; }
    .debug-value.warn { color: #ff9500; }
    .debug-value.null { color: #666; font-style: italic; }

    /* Modal Status */
    .modal-status { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 0.8rem; display: none; }
    .modal-status.show { display: block; }
    .modal-status.info { background: rgba(0,122,255,0.2); color: #007aff; }
    .modal-status.error { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .modal-status.success { background: rgba(52,199,89,0.2); color: #34c759; }

    /* Header Debug Panel */
    .header-debug {
      margin-top: 8px; padding: 8px 12px; background: rgba(0,0,0,0.2);
      border-radius: 8px; font-size: 0.65rem; font-family: var(--font-mono);
      display: none;
    }
    .header-debug.show { display: block; }
    .header-debug-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .header-debug-item { display: flex; gap: 4px; }
    .header-debug-key { color: var(--color-text-muted); }
    .header-debug-value { color: #34c759; }
    .header-debug-value.error { color: #ff3b30; }
    .header-debug-value.warn { color: #ff9500; }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/><circle cx="14" cy="20" r="4" fill="#FF6B35"/><path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu"><span class="hamburger-line"></span><span class="hamburger-line"></span><span class="hamburger-line"></span></button>
      </div>
    </header>
    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false"></nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <main class="admin-page" id="content">
      <div class="loading">Loading token ops...</div>
    </main>
  </div>

  <!-- Wallet Action Sheet -->
  <div class="action-sheet-overlay" id="wallet-action-sheet">
    <div class="action-sheet">
      <div class="action-sheet-header">
        <div class="action-sheet-title" id="action-sheet-title">Wallet</div>
        <div class="action-sheet-subtitle" id="action-sheet-subtitle"></div>
      </div>
      <button class="action-sheet-btn primary" id="action-reconnect">Reconnect Wallet</button>
      <button class="action-sheet-btn" id="action-copy">Copy Address</button>
      <button class="action-sheet-btn danger" id="action-disconnect">Disconnect</button>
      <button class="action-sheet-btn cancel" id="action-cancel">Cancel</button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm Transaction</div>
      <div class="modal-content" id="modal-content"></div>
      <div class="modal-status" id="modal-status"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="modal-cancel-btn">Cancel</button>
        <button class="modal-btn confirm" id="modal-confirm-btn">Confirm</button>
      </div>
      <!-- Debug Panel -->
      <div class="debug-panel">
        <div class="debug-toggle" id="debug-toggle">
          <span id="debug-arrow">+</span> Debug Info
        </div>
        <div class="debug-content" id="debug-content"></div>
      </div>
    </div>
  </div>

  <script src="/js/side-menu.js"></script>
  <script src="/js/humanads.js"></script>
  <script>
    // ============================================
    // Configuration
    // ============================================
    const CONFIG = {
      chainId: 11155111,
      chainIdHex: '0xaa36a7',
      chainName: 'Sepolia',
      husdContract: '0x62C2225D5691515BD4ee36539D127d0dB7dCeb67',
      ownerAddress: '0x64D6407757218ECbFc173C1efE0Fe7EdAaF67cC3',
      treasuryAddress: '0x0B9F043D4BcD45B95B72d4D595dEA8a31acdc017',
      decimals: 6,
      maxMintAmount: 1000000000,
      defaultMintAmount: 1000000,
      explorerUrl: 'https://sepolia.etherscan.io',
    };

    // ERC20 function selectors
    const SELECTORS = {
      mint: '0x40c10f19',
      transfer: '0xa9059cbb',
      balanceOf: '0x70a08231',
      totalSupply: '0x18160ddd',
    };

    // ============================================
    // State - Enhanced with signer verification
    // ============================================
    let walletAddress = null;
    let signerVerified = false;  // NEW: true only if we can actually sign
    let isOwner = false;
    let currentChainId = null;
    let currentFilter = null;
    let serverConfig = null;
    let pendingAction = null;
    let pendingTxParams = null;
    let debugInfo = {};
    let connectionState = 'disconnected'; // 'disconnected' | 'verifying' | 'connected' | 'wrong-network'

    // ============================================
    // Debug Logging
    // ============================================
    function log(level, message, data = null) {
      const timestamp = new Date().toISOString();
      const logEntry = { timestamp, level, message, data };
      console[level === 'error' ? 'error' : 'log'](`[TokenOps] ${message}`, data || '');

      // Store for debug panel
      if (!window.tokenOpsLogs) window.tokenOpsLogs = [];
      window.tokenOpsLogs.push(logEntry);
      if (window.tokenOpsLogs.length > 50) window.tokenOpsLogs.shift();
    }

    function updateDebugPanel() {
      const content = document.getElementById('debug-content');
      if (!content) return;

      const provider = window.ethereum;

      // Build comprehensive debug info
      debugInfo = {
        // Provider Info
        hasWindowEthereum: !!provider,
        providerType: provider ? (provider.isMetaMask ? 'MetaMask' : provider.isCoinbaseWallet ? 'Coinbase' : 'Unknown') : 'none',
        isMetaMaskMobile: provider ? (provider.isMetaMask && /Mobile|Android|iPhone/i.test(navigator.userAgent)) : false,

        // Connection State
        connectionState: connectionState,
        signerVerified: signerVerified,
        walletAddress: walletAddress,

        // Chain Info
        chainId: currentChainId,
        chainIdHex: currentChainId ? '0x' + currentChainId.toString(16) : null,
        expectedChainId: CONFIG.chainId,
        isCorrectChain: currentChainId === CONFIG.chainId,

        // Owner Info
        isOwner: isOwner,
        ownerAddress: CONFIG.ownerAddress,

        // Contract
        contract: CONFIG.husdContract,
      };

      if (pendingTxParams) {
        debugInfo.pendingTx = pendingTxParams;
      }

      // Render with sections
      content.innerHTML = `
        <div class="debug-section">
          <div class="debug-section-title">Provider</div>
          ${renderDebugRows({
            hasWindowEthereum: debugInfo.hasWindowEthereum,
            providerType: debugInfo.providerType,
            isMetaMaskMobile: debugInfo.isMetaMaskMobile,
          })}
        </div>
        <div class="debug-section">
          <div class="debug-section-title">Connection</div>
          ${renderDebugRows({
            state: debugInfo.connectionState,
            signerVerified: debugInfo.signerVerified,
            address: debugInfo.walletAddress,
          })}
        </div>
        <div class="debug-section">
          <div class="debug-section-title">Chain</div>
          ${renderDebugRows({
            chainId: debugInfo.chainId,
            expected: debugInfo.expectedChainId,
            isCorrect: debugInfo.isCorrectChain,
          })}
        </div>
        <div class="debug-section">
          <div class="debug-section-title">Owner</div>
          ${renderDebugRows({
            isOwner: debugInfo.isOwner,
            ownerAddr: debugInfo.ownerAddress?.substring(0, 14) + '...',
          })}
        </div>
        ${debugInfo.pendingTx ? `
        <div class="debug-section">
          <div class="debug-section-title">Pending TX</div>
          <div class="debug-row"><span class="debug-key">from</span><span class="debug-value">${debugInfo.pendingTx.from?.substring(0, 14)}...</span></div>
          <div class="debug-row"><span class="debug-key">to</span><span class="debug-value">${debugInfo.pendingTx.to?.substring(0, 14)}...</span></div>
          <div class="debug-row"><span class="debug-key">data</span><span class="debug-value">${debugInfo.pendingTx.data?.substring(0, 20)}...</span></div>
        </div>
        ` : ''}
      `;
    }

    function renderDebugRows(obj) {
      return Object.entries(obj).map(([key, value]) => {
        let valueClass = '';
        if (value === null || value === undefined) valueClass = 'null';
        else if (value === false) valueClass = 'error';
        else if (key === 'state' && value !== 'connected') valueClass = value === 'wrong-network' ? 'warn' : 'error';
        else if (key === 'signerVerified' && !value) valueClass = 'error';
        else if (key === 'isCorrect' && !value) valueClass = 'error';
        else if (key === 'isOwner' && !value) valueClass = 'warn';

        const displayValue = value === null || value === undefined ? 'null' : String(value);
        return `<div class="debug-row"><span class="debug-key">${key}</span><span class="debug-value ${valueClass}">${displayValue}</span></div>`;
      }).join('');
    }

    // ============================================
    // Provider Management
    // ============================================
    function getProvider() {
      if (typeof window.ethereum === 'undefined') {
        log('error', 'No ethereum provider found');
        return null;
      }
      return window.ethereum;
    }

    /**
     * Verify signer connection - the "truth" check
     * Returns true only if we can actually get a signer that can sign transactions
     */
    async function verifySignerConnection() {
      const provider = getProvider();
      if (!provider) {
        log('info', 'verifySignerConnection: no provider');
        return { verified: false, address: null, reason: 'No provider' };
      }

      try {
        // Step 1: Check if we have accounts via eth_accounts (non-interactive)
        const accounts = await provider.request({ method: 'eth_accounts' });
        log('info', 'eth_accounts result', accounts);

        if (!accounts || accounts.length === 0) {
          return { verified: false, address: null, reason: 'No accounts (not connected)' };
        }

        const address = accounts[0].toLowerCase();

        // Step 2: Verify we can actually use this account by checking chain
        const chainIdHex = await provider.request({ method: 'eth_chainId' });
        const chainId = parseInt(chainIdHex, 16);

        // Step 3: Try a simple personal_sign test message to verify signer capability
        // Actually, this would prompt the user - let's skip this for now and trust eth_accounts
        // The real test will be when we try to send a transaction

        log('info', 'Signer verified', { address, chainId });
        return { verified: true, address, chainId };

      } catch (e) {
        log('error', 'verifySignerConnection failed', { code: e.code, message: e.message });
        return { verified: false, address: null, reason: e.message };
      }
    }

    /**
     * Connect wallet - request accounts
     */
    async function connectWallet() {
      log('info', 'connectWallet called');
      connectionState = 'verifying';
      updateWalletUI();

      const provider = getProvider();
      if (!provider) {
        alert('No wallet detected. Please open this page in MetaMask browser or install MetaMask extension.');
        connectionState = 'disconnected';
        updateWalletUI();
        return false;
      }

      try {
        // Request accounts - this will prompt the user
        log('info', 'Requesting eth_requestAccounts...');
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        log('info', 'Accounts received', accounts);

        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts returned');
        }

        walletAddress = accounts[0].toLowerCase();
        isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();

        // Get chain
        const chainIdHex = await provider.request({ method: 'eth_chainId' });
        currentChainId = parseInt(chainIdHex, 16);

        // Mark as verified
        signerVerified = true;

        // Set up listeners
        provider.on('accountsChanged', handleAccountsChanged);
        provider.on('chainChanged', handleChainChanged);

        // Determine connection state
        if (currentChainId !== CONFIG.chainId) {
          connectionState = 'wrong-network';
        } else {
          connectionState = 'connected';
        }

        updateWalletUI();
        await refreshOnchainData();
        log('info', 'Wallet connected successfully', { address: walletAddress, chainId: currentChainId });
        return true;

      } catch (e) {
        log('error', 'connectWallet failed', { code: e.code, message: e.message });

        if (e.code === 4001) {
          // User rejected
          alert('Connection rejected. Please approve the connection request.');
        } else {
          alert('Failed to connect: ' + e.message);
        }

        connectionState = 'disconnected';
        signerVerified = false;
        walletAddress = null;
        updateWalletUI();
        return false;
      }
    }

    /**
     * Reconnect wallet - force new connection with wallet_requestPermissions
     */
    async function reconnectWallet() {
      log('info', 'reconnectWallet called');
      connectionState = 'verifying';
      updateWalletUI();

      const provider = getProvider();
      if (!provider) {
        alert('No wallet detected.');
        connectionState = 'disconnected';
        updateWalletUI();
        return false;
      }

      try {
        // Clear any cached state
        clearLocalWalletState();

        // Force permission request - this should always prompt
        log('info', 'Requesting wallet_requestPermissions...');
        try {
          await provider.request({
            method: 'wallet_requestPermissions',
            params: [{ eth_accounts: {} }],
          });
          log('info', 'wallet_requestPermissions succeeded');
        } catch (permError) {
          // Some wallets don't support wallet_requestPermissions, fall back to eth_requestAccounts
          log('info', 'wallet_requestPermissions failed, falling back to eth_requestAccounts', permError.message);
        }

        // Now get accounts
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        log('info', 'Reconnect accounts', accounts);

        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts returned');
        }

        walletAddress = accounts[0].toLowerCase();
        isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();

        // Get chain
        const chainIdHex = await provider.request({ method: 'eth_chainId' });
        currentChainId = parseInt(chainIdHex, 16);

        signerVerified = true;

        // Set up listeners
        provider.removeListener('accountsChanged', handleAccountsChanged);
        provider.removeListener('chainChanged', handleChainChanged);
        provider.on('accountsChanged', handleAccountsChanged);
        provider.on('chainChanged', handleChainChanged);

        if (currentChainId !== CONFIG.chainId) {
          connectionState = 'wrong-network';
        } else {
          connectionState = 'connected';
        }

        updateWalletUI();
        await refreshOnchainData();
        log('info', 'Wallet reconnected successfully');
        return true;

      } catch (e) {
        log('error', 'reconnectWallet failed', { code: e.code, message: e.message });
        alert('Reconnect failed: ' + e.message);
        connectionState = 'disconnected';
        signerVerified = false;
        walletAddress = null;
        updateWalletUI();
        return false;
      }
    }

    /**
     * Disconnect wallet - clear all state
     */
    function disconnectWallet() {
      log('info', 'disconnectWallet called');

      const provider = getProvider();
      if (provider) {
        provider.removeListener('accountsChanged', handleAccountsChanged);
        provider.removeListener('chainChanged', handleChainChanged);
      }

      // Clear state
      walletAddress = null;
      signerVerified = false;
      isOwner = false;
      currentChainId = null;
      connectionState = 'disconnected';

      // Clear local storage
      clearLocalWalletState();

      updateWalletUI();
      log('info', 'Wallet disconnected');
    }

    /**
     * Clear local wallet state (localStorage/sessionStorage)
     */
    function clearLocalWalletState() {
      // Clear common wallet connection keys
      const keysToRemove = [
        'walletconnect',
        'WALLETCONNECT_DEEPLINK_CHOICE',
        'wagmi.wallet',
        'wagmi.connected',
        'wagmi.cache',
        'metamask.connected',
      ];

      keysToRemove.forEach(key => {
        try {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
        } catch (e) {}
      });

      // Clear all wagmi-related keys
      try {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('wagmi') || key.startsWith('wc@')) {
            localStorage.removeItem(key);
          }
        });
      } catch (e) {}
    }

    /**
     * Switch to Sepolia network
     */
    async function switchToSepolia() {
      const provider = getProvider();
      if (!provider) return false;

      log('info', 'Switching to Sepolia...');
      try {
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: CONFIG.chainIdHex }],
        });
        log('info', 'Chain switched successfully');

        const chainIdHex = await provider.request({ method: 'eth_chainId' });
        currentChainId = parseInt(chainIdHex, 16);

        if (currentChainId === CONFIG.chainId) {
          connectionState = 'connected';
          updateWalletUI();
          return true;
        }
      } catch (switchError) {
        log('error', 'Chain switch failed', { code: switchError.code, message: switchError.message });

        if (switchError.code === 4902) {
          // Chain not added, try to add it
          try {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: CONFIG.chainIdHex,
                chainName: 'Sepolia Testnet',
                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                rpcUrls: ['https://rpc.sepolia.org'],
                blockExplorerUrls: ['https://sepolia.etherscan.io'],
              }],
            });
            log('info', 'Sepolia chain added');
            return await switchToSepolia();
          } catch (addError) {
            log('error', 'Failed to add Sepolia', addError);
            alert('Failed to add Sepolia network. Please add it manually in MetaMask.');
          }
        } else if (switchError.code === 4001) {
          alert('Network switch rejected. Please switch to Sepolia manually.');
        } else {
          alert('Failed to switch network: ' + switchError.message);
        }
      }
      return false;
    }

    function handleAccountsChanged(accounts) {
      log('info', 'accountsChanged event', accounts);
      if (accounts.length === 0) {
        // User disconnected
        walletAddress = null;
        signerVerified = false;
        isOwner = false;
        connectionState = 'disconnected';
      } else {
        walletAddress = accounts[0].toLowerCase();
        isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();
        signerVerified = true;
        connectionState = currentChainId === CONFIG.chainId ? 'connected' : 'wrong-network';
      }
      updateWalletUI();
      refreshOnchainData();
    }

    function handleChainChanged(chainIdHex) {
      log('info', 'chainChanged event', chainIdHex);
      currentChainId = parseInt(chainIdHex, 16);

      if (walletAddress && signerVerified) {
        connectionState = currentChainId === CONFIG.chainId ? 'connected' : 'wrong-network';
      }

      updateWalletUI();
      refreshOnchainData();
    }

    // ============================================
    // Wallet UI
    // ============================================
    function updateWalletUI() {
      const walletSection = document.getElementById('wallet-section');
      if (!walletSection) return;

      let pillClass = '';
      let pillLabel = '';
      let pillSub = '';
      let showArrow = false;

      switch (connectionState) {
        case 'disconnected':
          pillClass = 'not-connected';
          pillLabel = 'Not Connected';
          pillSub = 'Tap to connect';
          break;
        case 'verifying':
          pillClass = 'verifying';
          pillLabel = 'Connecting...';
          pillSub = 'Please wait';
          break;
        case 'wrong-network':
          pillClass = 'wrong-network';
          pillLabel = walletAddress ? walletAddress.substring(0, 6) + '...' + walletAddress.substring(38) : 'Wrong Network';
          pillSub = 'Switch to Sepolia';
          showArrow = true;
          break;
        case 'connected':
          pillClass = 'connected';
          pillLabel = walletAddress.substring(0, 6) + '...' + walletAddress.substring(38);
          pillSub = 'MetaMask • Sepolia';
          showArrow = true;
          break;
      }

      const ownerBadge = (connectionState === 'connected' || connectionState === 'wrong-network') && walletAddress
        ? `<span class="wallet-badge ${isOwner ? 'owner' : 'not-owner'}">${isOwner ? 'OWNER' : 'NOT OWNER'}</span>`
        : '';

      walletSection.innerHTML = `
        <div class="wallet-pill ${pillClass}" id="wallet-pill">
          <div class="wallet-pill-main">
            <span class="wallet-pill-label">${pillLabel}</span>
            <span class="wallet-pill-sub">${pillSub}</span>
          </div>
          ${showArrow ? '<span class="wallet-pill-arrow">▼</span>' : ''}
        </div>
        ${ownerBadge}
      `;

      // Attach click handler
      const pill = document.getElementById('wallet-pill');
      if (pill) {
        pill.addEventListener('click', handleWalletPillClick);
      }

      updateButtonStates();
    }

    function handleWalletPillClick() {
      log('info', 'Wallet pill clicked', { connectionState });

      switch (connectionState) {
        case 'disconnected':
          connectWallet();
          break;
        case 'verifying':
          // Do nothing while verifying
          break;
        case 'wrong-network':
          // Show action sheet
          showWalletActionSheet();
          break;
        case 'connected':
          // Show action sheet
          showWalletActionSheet();
          break;
      }
    }

    function showWalletActionSheet() {
      const overlay = document.getElementById('wallet-action-sheet');
      const title = document.getElementById('action-sheet-title');
      const subtitle = document.getElementById('action-sheet-subtitle');

      title.textContent = walletAddress ? walletAddress.substring(0, 8) + '...' + walletAddress.substring(36) : 'Wallet';
      subtitle.textContent = connectionState === 'wrong-network'
        ? 'Wrong network - switch to Sepolia'
        : (isOwner ? 'Owner Account • Sepolia' : 'Sepolia');

      overlay.classList.add('show');
    }

    function hideWalletActionSheet() {
      document.getElementById('wallet-action-sheet').classList.remove('show');
    }

    function copyWalletAddress() {
      if (!walletAddress) return;

      navigator.clipboard.writeText(walletAddress).then(() => {
        // Show brief toast
        const title = document.getElementById('action-sheet-title');
        const original = title.textContent;
        title.textContent = 'Copied!';
        setTimeout(() => {
          title.textContent = original;
          hideWalletActionSheet();
        }, 1000);
      }).catch(err => {
        alert('Failed to copy: ' + err.message);
      });
    }

    function updateButtonStates() {
      const mintBtn = document.getElementById('mint-btn');
      const transferBtn = document.getElementById('transfer-btn');

      // Can only execute if: signer verified + correct chain + is owner
      const canExecute = signerVerified && currentChainId === CONFIG.chainId && isOwner;

      if (mintBtn) {
        mintBtn.disabled = !canExecute;
        if (!signerVerified) {
          mintBtn.textContent = 'Connect Wallet First';
        } else if (currentChainId !== CONFIG.chainId) {
          mintBtn.textContent = 'Switch to Sepolia';
        } else if (!isOwner) {
          mintBtn.textContent = `Owner only: ${CONFIG.ownerAddress.substring(0, 10)}...`;
        } else {
          mintBtn.textContent = 'Mint hUSD';
        }
      }

      if (transferBtn) {
        transferBtn.disabled = !canExecute;
        if (!signerVerified) {
          transferBtn.textContent = 'Connect Wallet First';
        } else if (currentChainId !== CONFIG.chainId) {
          transferBtn.textContent = 'Switch to Sepolia';
        } else if (!isOwner) {
          transferBtn.textContent = `Owner only: ${CONFIG.ownerAddress.substring(0, 10)}...`;
        } else {
          transferBtn.textContent = 'Transfer to Treasury';
        }
      }
    }

    // ============================================
    // On-chain Reads
    // ============================================
    async function readContract(selector, params = '') {
      const provider = getProvider();
      if (!provider) return null;

      const data = selector + params;
      const result = await provider.request({
        method: 'eth_call',
        params: [{ to: CONFIG.husdContract, data }, 'latest'],
      });
      return result;
    }

    async function getTotalSupply() {
      try {
        const result = await readContract(SELECTORS.totalSupply);
        if (!result) return null;
        const raw = BigInt(result);
        return Number(raw / BigInt(10 ** CONFIG.decimals));
      } catch (e) {
        log('error', 'getTotalSupply error', e.message);
        return null;
      }
    }

    async function getBalance(address) {
      try {
        const paddedAddress = address.toLowerCase().replace('0x', '').padStart(64, '0');
        const result = await readContract(SELECTORS.balanceOf, paddedAddress);
        if (!result) return null;
        const raw = BigInt(result);
        return Number(raw / BigInt(10 ** CONFIG.decimals));
      } catch (e) {
        log('error', 'getBalance error', e.message);
        return null;
      }
    }

    async function refreshOnchainData() {
      if (!signerVerified) return;

      try {
        const [totalSupply, ownerBalance, treasuryBalance] = await Promise.all([
          getTotalSupply(),
          getBalance(CONFIG.ownerAddress),
          getBalance(CONFIG.treasuryAddress),
        ]);

        const totalSupplyEl = document.getElementById('total-supply');
        const ownerBalanceEl = document.getElementById('owner-balance');
        const treasuryBalanceEl = document.getElementById('treasury-balance-live');

        if (totalSupplyEl && totalSupply !== null) {
          totalSupplyEl.textContent = totalSupply.toLocaleString() + ' hUSD';
        }
        if (ownerBalanceEl && ownerBalance !== null) {
          ownerBalanceEl.textContent = ownerBalance.toLocaleString() + ' hUSD';
        }
        if (treasuryBalanceEl && treasuryBalance !== null) {
          treasuryBalanceEl.textContent = treasuryBalance.toLocaleString() + ' hUSD';
        }
      } catch (e) {
        log('error', 'refreshOnchainData error', e.message);
      }
    }

    // ============================================
    // Modal Management
    // ============================================
    function showConfirmModal(action, title, details, btnClass, txParams) {
      pendingAction = action;
      pendingTxParams = txParams;

      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-content').innerHTML = details.map(d => `
        <div class="modal-row">
          <span class="modal-label">${d.label}</span>
          <span class="modal-value">${d.value}</span>
        </div>
      `).join('');

      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.className = 'modal-btn confirm ' + btnClass;
      confirmBtn.textContent = 'Confirm ' + (btnClass === 'mint' ? 'Mint' : 'Transfer');
      confirmBtn.disabled = false;

      // Reset status
      const statusEl = document.getElementById('modal-status');
      statusEl.className = 'modal-status';
      statusEl.textContent = '';

      // Update debug panel
      updateDebugPanel();

      document.getElementById('confirm-modal').classList.add('show');
      log('info', 'Modal shown', { title, txParams });
    }

    function closeModal() {
      document.getElementById('confirm-modal').classList.remove('show');
      pendingAction = null;
      pendingTxParams = null;
    }

    function setModalStatus(message, type) {
      const statusEl = document.getElementById('modal-status');
      statusEl.className = 'modal-status show ' + type;
      statusEl.textContent = message;
    }

    async function executeConfirmed() {
      if (!pendingAction) {
        log('error', 'No pending action');
        return;
      }

      const confirmBtn = document.getElementById('modal-confirm-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');

      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      setModalStatus('Preparing transaction...', 'info');
      log('info', 'Execute confirmed clicked');

      try {
        // Step 1: Verify signer is available
        setModalStatus('Verifying wallet connection...', 'info');

        if (!signerVerified) {
          setModalStatus('Wallet not connected. Reconnecting...', 'info');
          const connected = await reconnectWallet();
          if (!connected) {
            throw new Error('Wallet not connected. Please connect MetaMask.');
          }
        }
        updateDebugPanel();

        // Step 2: Ensure correct chain
        if (currentChainId !== CONFIG.chainId) {
          setModalStatus('Switching to Sepolia...', 'info');
          const switched = await switchToSepolia();
          if (!switched) {
            throw new Error('Wrong network. Please switch to Sepolia.');
          }
        }
        updateDebugPanel();

        // Step 3: Send transaction directly to MetaMask
        setModalStatus('Opening wallet...', 'info');
        closeModal();
        await pendingAction();

      } catch (e) {
        log('error', 'Transaction failed', { code: e.code, message: e.message });
        setModalStatus(`Error: ${e.message}`, 'error');
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        confirmBtn.textContent = 'Retry';
        updateDebugPanel();

        debugInfo.lastError = { code: e.code, message: e.message };
        updateDebugPanel();
      }
    }

    // ============================================
    // Owner Actions
    // ============================================
    function prepareMint() {
      log('info', 'Prepare mint clicked');

      // Pre-check connection
      if (!signerVerified) {
        showMintStatus('Wallet not connected. Please connect MetaMask.', 'error');
        return;
      }
      if (currentChainId !== CONFIG.chainId) {
        showMintStatus('Wrong network. Please switch to Sepolia.', 'error');
        return;
      }
      if (!isOwner) {
        showMintStatus(`Only contract owner can mint. Owner: ${CONFIG.ownerAddress}`, 'error');
        return;
      }

      const toSelect = document.getElementById('mint-to');
      const amountInput = document.getElementById('mint-amount');
      const to = toSelect.value;
      const amount = parseInt(amountInput.value) || CONFIG.defaultMintAmount;

      if (amount <= 0 || amount > CONFIG.maxMintAmount) {
        showMintStatus(`Invalid amount. Must be 1 - ${CONFIG.maxMintAmount.toLocaleString()}`, 'error');
        return;
      }

      // Build tx params
      const paddedTo = to.toLowerCase().replace('0x', '').padStart(64, '0');
      const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
      const paddedAmount = amountWei.toString(16).padStart(64, '0');
      const data = SELECTORS.mint + paddedTo + paddedAmount;

      const txParams = {
        from: walletAddress,
        to: CONFIG.husdContract,
        data: data,
      };

      const toLabel = to.toLowerCase() === CONFIG.ownerAddress.toLowerCase() ? 'Owner' : 'Treasury';
      const toShort = to.substring(0, 10) + '...' + to.substring(36);

      showConfirmModal(
        () => executeMint(to, amount),
        'Confirm Mint',
        [
          { label: 'Network', value: CONFIG.chainName },
          { label: 'Contract', value: CONFIG.husdContract.substring(0, 14) + '...' },
          { label: 'To', value: `${toLabel} (${toShort})` },
          { label: 'Amount', value: amount.toLocaleString() + ' hUSD' },
        ],
        'mint',
        txParams
      );
    }

    async function executeMint(to, amount) {
      const btn = document.getElementById('mint-btn');

      btn.disabled = true;
      btn.textContent = 'Minting...';
      showMintStatus('Sending transaction to MetaMask...', 'info');
      log('info', 'Executing mint', { to, amount });

      try {
        const provider = getProvider();
        if (!provider) throw new Error('No wallet provider');

        // Build transaction
        const paddedTo = to.toLowerCase().replace('0x', '').padStart(64, '0');
        const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
        const paddedAmount = amountWei.toString(16).padStart(64, '0');
        const data = SELECTORS.mint + paddedTo + paddedAmount;

        const txParams = {
          from: walletAddress,
          to: CONFIG.husdContract,
          data: data,
        };

        log('info', 'Sending eth_sendTransaction', txParams);

        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        log('info', 'Transaction sent', { txHash });

        showMintStatus(
          `Mint submitted! <a href="${CONFIG.explorerUrl}/tx/${txHash}" target="_blank" class="tx-link">${txHash.substring(0, 20)}...</a>`,
          'success'
        );

        logTokenOp('owner_mint', txHash, walletAddress, to, amount);

        setTimeout(() => {
          refreshOnchainData();
          loadTokenOps(currentFilter);
        }, 5000);

      } catch (e) {
        log('error', 'Mint failed', { code: e.code, message: e.message });

        let errorMsg = e.message;
        if (e.code === 4001) {
          errorMsg = 'Transaction rejected by user';
        } else if (e.code === -32603) {
          errorMsg = 'Internal error. Check if you are the contract owner.';
        }

        showMintStatus(`Failed: ${errorMsg} (code: ${e.code || 'unknown'})`, 'error');
      } finally {
        btn.disabled = false;
        updateButtonStates();
      }
    }

    function showMintStatus(message, type) {
      const statusDiv = document.getElementById('mint-status');
      if (statusDiv) {
        statusDiv.className = 'status-msg ' + type;
        statusDiv.innerHTML = message;
      }
    }

    function prepareTransfer() {
      log('info', 'Prepare transfer clicked');

      // Pre-check connection
      if (!signerVerified) {
        showTransferStatus('Wallet not connected. Please connect MetaMask.', 'error');
        return;
      }
      if (currentChainId !== CONFIG.chainId) {
        showTransferStatus('Wrong network. Please switch to Sepolia.', 'error');
        return;
      }
      if (!isOwner) {
        showTransferStatus(`Only contract owner can transfer. Owner: ${CONFIG.ownerAddress}`, 'error');
        return;
      }

      const amountInput = document.getElementById('transfer-amount');
      const amount = parseInt(amountInput.value) || CONFIG.defaultMintAmount;

      if (amount <= 0 || amount > CONFIG.maxMintAmount) {
        showTransferStatus(`Invalid amount. Must be 1 - ${CONFIG.maxMintAmount.toLocaleString()}`, 'error');
        return;
      }

      // Build tx params
      const paddedTo = CONFIG.treasuryAddress.toLowerCase().replace('0x', '').padStart(64, '0');
      const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
      const paddedAmount = amountWei.toString(16).padStart(64, '0');
      const data = SELECTORS.transfer + paddedTo + paddedAmount;

      const txParams = {
        from: walletAddress,
        to: CONFIG.husdContract,
        data: data,
      };

      showConfirmModal(
        () => executeTransfer(amount),
        'Confirm Transfer',
        [
          { label: 'Network', value: CONFIG.chainName },
          { label: 'Contract', value: CONFIG.husdContract.substring(0, 14) + '...' },
          { label: 'From', value: 'Owner (' + CONFIG.ownerAddress.substring(0, 10) + '...)' },
          { label: 'To', value: 'Treasury (' + CONFIG.treasuryAddress.substring(0, 10) + '...)' },
          { label: 'Amount', value: amount.toLocaleString() + ' hUSD' },
        ],
        'transfer',
        txParams
      );
    }

    async function executeTransfer(amount) {
      const btn = document.getElementById('transfer-btn');

      btn.disabled = true;
      btn.textContent = 'Transferring...';
      showTransferStatus('Sending transaction to MetaMask...', 'info');
      log('info', 'Executing transfer', { amount });

      try {
        const provider = getProvider();
        if (!provider) throw new Error('No wallet provider');

        const paddedTo = CONFIG.treasuryAddress.toLowerCase().replace('0x', '').padStart(64, '0');
        const amountWei = BigInt(amount) * BigInt(10 ** CONFIG.decimals);
        const paddedAmount = amountWei.toString(16).padStart(64, '0');
        const data = SELECTORS.transfer + paddedTo + paddedAmount;

        const txParams = {
          from: walletAddress,
          to: CONFIG.husdContract,
          data: data,
        };

        log('info', 'Sending eth_sendTransaction', txParams);

        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });

        log('info', 'Transaction sent', { txHash });

        showTransferStatus(
          `Transfer submitted! <a href="${CONFIG.explorerUrl}/tx/${txHash}" target="_blank" class="tx-link">${txHash.substring(0, 20)}...</a>`,
          'success'
        );

        logTokenOp('owner_transfer', txHash, walletAddress, CONFIG.treasuryAddress, amount);

        setTimeout(() => {
          refreshOnchainData();
          loadTokenOps(currentFilter);
        }, 5000);

      } catch (e) {
        log('error', 'Transfer failed', { code: e.code, message: e.message });

        let errorMsg = e.message;
        if (e.code === 4001) {
          errorMsg = 'Transaction rejected by user';
        } else if (e.code === -32603) {
          errorMsg = 'Internal error. Check if you have sufficient balance.';
        }

        showTransferStatus(`Failed: ${errorMsg} (code: ${e.code || 'unknown'})`, 'error');
      } finally {
        btn.disabled = false;
        updateButtonStates();
      }
    }

    function showTransferStatus(message, type) {
      const statusDiv = document.getElementById('transfer-status');
      if (statusDiv) {
        statusDiv.className = 'status-msg ' + type;
        statusDiv.innerHTML = message;
      }
    }

    // ============================================
    // Backend Logging
    // ============================================
    async function logTokenOp(type, txHash, from, to, amount) {
      try {
        await HumanAds.fetchApi('/api/admin/token-ops/log', {
          method: 'POST',
          body: JSON.stringify({
            type,
            tx_hash: txHash,
            from_address: from,
            to_address: to,
            amount_cents: amount * 100,
            chain_id: CONFIG.chainId,
          }),
        });
      } catch (e) {
        log('error', 'Failed to log token op', e.message);
      }
    }

    // ============================================
    // Server Data Loading
    // ============================================
    async function loadBalances() {
      try {
        const res = await HumanAds.fetchApi('/api/admin/token-ops/balances');
        if (res.success) return res.data;
      } catch (e) {
        log('error', 'Failed to load balances', e.message);
      }
      return null;
    }

    async function loadTokenOps(filter = null) {
      currentFilter = filter;
      const content = document.getElementById('content');

      try {
        const [balances, opsRes] = await Promise.all([
          loadBalances(),
          HumanAds.fetchApi(filter ? `/api/admin/token-ops?op_type=${filter}` : '/api/admin/token-ops')
        ]);

        if (!opsRes.success) {
          content.innerHTML = `<div class="empty">Error: ${opsRes.error?.message || 'Failed to load'}</div>`;
          return;
        }

        const ops = opsRes.data.token_ops || [];
        serverConfig = balances?.config || {};

        content.innerHTML = `
          <div class="admin-header">
            <h1>Token Ops (hUSD)</h1>
            <div class="wallet-section" id="wallet-section">
              <div class="wallet-pill not-connected" id="wallet-pill">
                <div class="wallet-pill-main">
                  <span class="wallet-pill-label">Not Connected</span>
                  <span class="wallet-pill-sub">Tap to connect</span>
                </div>
              </div>
            </div>
          </div>

          <h2 class="section-title">Owner Operations (MetaMask)</h2>
          <div class="cards-grid">
            <div class="card owner-card">
              <div class="card-header">
                <span class="card-title">Owner Mint</span>
              </div>
              <div class="owner-form">
                <div class="form-group">
                  <label class="form-label">Mint To</label>
                  <select id="mint-to" class="form-select">
                    <option value="${CONFIG.ownerAddress}">Owner (${CONFIG.ownerAddress.substring(0, 10)}...)</option>
                    <option value="${CONFIG.treasuryAddress}">Treasury (${CONFIG.treasuryAddress.substring(0, 10)}...)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Amount (hUSD)</label>
                  <input type="number" id="mint-amount" class="form-input" value="${CONFIG.defaultMintAmount}" min="1" max="${CONFIG.maxMintAmount}" />
                  <span class="form-hint">Max: ${CONFIG.maxMintAmount.toLocaleString()}</span>
                </div>
                <button class="action-btn mint" id="mint-btn" disabled>Connect Wallet First</button>
                <div id="mint-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Total Supply:</span>
                  <span class="config-value" id="total-supply">-</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Owner Balance:</span>
                  <span class="config-value" id="owner-balance">-</span>
                </div>
              </div>
            </div>

            <div class="card owner-card">
              <div class="card-header">
                <span class="card-title">Owner -> Treasury Transfer</span>
              </div>
              <div class="owner-form">
                <div class="form-group">
                  <label class="form-label">To (Fixed)</label>
                  <input type="text" class="form-input" value="${CONFIG.treasuryAddress}" disabled />
                  <span class="form-hint fixed">Treasury address - cannot be changed</span>
                </div>
                <div class="form-group">
                  <label class="form-label">Amount (hUSD)</label>
                  <input type="number" id="transfer-amount" class="form-input" value="${CONFIG.defaultMintAmount}" min="1" max="${CONFIG.maxMintAmount}" />
                </div>
                <button class="action-btn transfer" id="transfer-btn" disabled>Connect Wallet First</button>
                <div id="transfer-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Treasury Balance:</span>
                  <span class="config-value" id="treasury-balance-live">-</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Contract:</span>
                  <span class="config-value">${CONFIG.husdContract.substring(0, 10)}...</span>
                </div>
              </div>
            </div>
          </div>

          <h2 class="section-title">Treasury Operations (Server)</h2>
          <div class="cards-grid">
            <div class="card faucet-card">
              <div class="card-header">
                <span class="card-title">Faucet (Advertiser)</span>
              </div>
              <div class="faucet-form">
                <input type="text" id="faucet-address" class="faucet-input" placeholder="0x... Advertiser Address" />
                <div class="faucet-amount">
                  <span>Amount:</span>
                  <span class="faucet-amount-value">$${((serverConfig.faucet_amount_cents || 100000) / 100).toLocaleString()}</span>
                  <span style="color: var(--color-text-muted)">hUSD</span>
                </div>
                <button class="action-btn" id="faucet-btn">Send hUSD</button>
                <div id="faucet-status"></div>
              </div>
              <div class="config-info">
                <div class="config-row">
                  <span class="config-label">Cooldown:</span>
                  <span class="config-value">${Math.floor((serverConfig.faucet_cooldown_seconds || 86400) / 3600)}h</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Treasury Key:</span>
                  <span class="config-value">${serverConfig.has_treasury_key ? 'Configured' : 'Not set'}</span>
                </div>
                <div class="config-row">
                  <span class="config-label">Mode:</span>
                  <span class="config-value">${serverConfig.payout_mode || 'ledger'}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Treasury Balance (Server)</span>
              </div>
              <div class="card-value">${balances?.treasury ? balances.treasury.husd_display : '-'}</div>
              <div class="card-sub">hUSD (${balances?.treasury?.eth || '0'} ETH for gas)</div>
              ${balances?.treasury?.address ? `<div class="config-info"><div class="config-row"><span class="config-label">Address:</span><span class="config-value">${balances.treasury.address.substring(0, 14)}...</span></div></div>` : ''}
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Admin Balance (Server)</span>
              </div>
              <div class="card-value">${balances?.admin ? balances.admin.husd_display : '-'}</div>
              <div class="card-sub">hUSD (${balances?.admin?.eth || '0'} ETH for gas)</div>
              ${balances?.admin?.address ? `<div class="config-info"><div class="config-row"><span class="config-label">Address:</span><span class="config-value">${balances.admin.address.substring(0, 14)}...</span></div></div>` : ''}
            </div>
          </div>

          <h2 class="section-title">Recent Operations (${ops.length})</h2>

          <div class="filters">
            <span class="filter-chip ${!filter ? 'active' : ''}" data-filter="">All</span>
            <span class="filter-chip ${filter === 'faucet' ? 'active' : ''}" data-filter="faucet">Faucet</span>
            <span class="filter-chip ${filter === 'mint' ? 'active' : ''}" data-filter="mint">Mint</span>
            <span class="filter-chip ${filter === 'owner_mint' ? 'active' : ''}" data-filter="owner_mint">Owner Mint</span>
            <span class="filter-chip ${filter === 'transfer' ? 'active' : ''}" data-filter="transfer">Transfer</span>
            <span class="filter-chip ${filter === 'owner_transfer' ? 'active' : ''}" data-filter="owner_transfer">Owner Transfer</span>
          </div>

          <div class="table-container">
            ${ops.length === 0 ? '<div class="empty">No token operations found</div>' : `
              <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Amount</th>
                    <th>TX Hash</th>
                    <th>Status</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody>
                  ${ops.map(op => `
                    <tr>
                      <td class="id-cell">${op.id.substring(0,8)}...</td>
                      <td><span class="type-badge ${op.op_type}">${op.op_type}</span></td>
                      <td class="address-cell" title="${op.from_address || ''}">${op.from_address ? op.from_address.substring(0, 10) + '...' : '-'}</td>
                      <td class="address-cell" title="${op.to_address}">${op.to_address ? op.to_address.substring(0, 10) + '...' : '-'}</td>
                      <td>${HumanAds.formatCurrency(op.amount_cents)}</td>
                      <td>${op.tx_hash ? (op.tx_hash.startsWith('SIMULATED_') ?
                        `<span class="id-cell">${op.tx_hash.substring(0, 16)}...</span>` :
                        `<a href="${CONFIG.explorerUrl}/tx/${op.tx_hash}" target="_blank" class="tx-link">${op.tx_hash.substring(0, 10)}...</a>`) : '-'}</td>
                      <td><span class="status-badge ${op.status}">${op.status}</span></td>
                      <td>${HumanAds.formatDate(op.created_at)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `}
          </div>
        `;

        // Attach event listeners
        attachEventListeners();

        // Update wallet UI based on current state
        updateWalletUI();

        // Refresh on-chain data if connected
        if (signerVerified) {
          refreshOnchainData();
        }
      } catch (e) {
        content.innerHTML = `<div class="empty">Error: ${e.message}</div>`;
      }
    }

    function attachEventListeners() {
      // Mint button
      const mintBtn = document.getElementById('mint-btn');
      if (mintBtn) {
        mintBtn.addEventListener('click', prepareMint);
      }

      // Transfer button
      const transferBtn = document.getElementById('transfer-btn');
      if (transferBtn) {
        transferBtn.addEventListener('click', prepareTransfer);
      }

      // Faucet button
      const faucetBtn = document.getElementById('faucet-btn');
      if (faucetBtn) {
        faucetBtn.addEventListener('click', sendFaucet);
      }

      // Filter chips
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const filter = chip.dataset.filter || null;
          loadTokenOps(filter);
        });
      });
    }

    async function sendFaucet() {
      const addressInput = document.getElementById('faucet-address');
      const btn = document.getElementById('faucet-btn');
      const statusDiv = document.getElementById('faucet-status');

      const address = addressInput.value.trim();
      if (!address || !address.startsWith('0x')) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = 'Please enter a valid 0x address';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending...';
      statusDiv.className = '';
      statusDiv.textContent = '';

      try {
        const res = await HumanAds.fetchApi('/api/admin/faucet', {
          method: 'POST',
          body: JSON.stringify({ advertiser_address: address })
        });

        if (res.success) {
          statusDiv.className = 'status-msg success';
          const amount = res.data.amount_cents ? `$${(res.data.amount_cents / 100).toLocaleString()}` : '';
          statusDiv.innerHTML = `Sent ${amount} hUSD! <a href="${CONFIG.explorerUrl}/tx/${res.data.tx_hash}" target="_blank" class="tx-link">${res.data.tx_hash?.substring(0, 20) || 'pending'}...</a>`;
          addressInput.value = '';
          setTimeout(() => loadTokenOps(currentFilter), 2000);
        } else {
          statusDiv.className = 'status-msg error';
          statusDiv.textContent = res.error?.message || 'Faucet failed';
        }
      } catch (e) {
        statusDiv.className = 'status-msg error';
        statusDiv.textContent = e.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send hUSD';
      }
    }

    // ============================================
    // Modal & Action Sheet Event Listeners
    // ============================================
    function initModalListeners() {
      // Cancel button
      document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);

      // Confirm button
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        executeConfirmed();
      });

      // Debug toggle
      document.getElementById('debug-toggle').addEventListener('click', () => {
        const content = document.getElementById('debug-content');
        const arrow = document.getElementById('debug-arrow');
        if (content.classList.contains('show')) {
          content.classList.remove('show');
          arrow.textContent = '+';
        } else {
          content.classList.add('show');
          arrow.textContent = '-';
          updateDebugPanel();
        }
      });

      // Close on overlay click
      document.getElementById('confirm-modal').addEventListener('click', (e) => {
        if (e.target.id === 'confirm-modal') {
          closeModal();
        }
      });

      // Action sheet listeners
      document.getElementById('wallet-action-sheet').addEventListener('click', (e) => {
        if (e.target.id === 'wallet-action-sheet') {
          hideWalletActionSheet();
        }
      });
      document.getElementById('action-reconnect').addEventListener('click', () => {
        hideWalletActionSheet();
        reconnectWallet();
      });
      document.getElementById('action-copy').addEventListener('click', copyWalletAddress);
      document.getElementById('action-disconnect').addEventListener('click', () => {
        hideWalletActionSheet();
        disconnectWallet();
      });
      document.getElementById('action-cancel').addEventListener('click', hideWalletActionSheet);
    }

    // ============================================
    // Initialization
    // ============================================
    (async function() {
      log('info', 'Initializing Token Ops page');

      const meRes = await HumanAds.fetchApi('/me');
      if (!meRes.success || !meRes.data?.user?.is_admin) {
        window.location.href = '/admin';
        return;
      }

      await loadTokenOps();
      SideMenu.init(true, true);
      initModalListeners();

      // Try to verify existing connection (non-interactive)
      const provider = getProvider();
      if (provider) {
        log('info', 'Provider detected, verifying existing connection...');
        connectionState = 'verifying';

        const verification = await verifySignerConnection();
        log('info', 'Verification result', verification);

        if (verification.verified) {
          walletAddress = verification.address;
          isOwner = walletAddress === CONFIG.ownerAddress.toLowerCase();
          currentChainId = verification.chainId;
          signerVerified = true;

          if (currentChainId !== CONFIG.chainId) {
            connectionState = 'wrong-network';
          } else {
            connectionState = 'connected';
          }

          // Set up listeners
          provider.on('accountsChanged', handleAccountsChanged);
          provider.on('chainChanged', handleChainChanged);

          updateWalletUI();
          refreshOnchainData();
          log('info', 'Existing connection verified');
        } else {
          // Not connected or can't verify
          connectionState = 'disconnected';
          signerVerified = false;
          updateWalletUI();
          log('info', 'No existing connection: ' + verification.reason);
        }
      } else {
        connectionState = 'disconnected';
        updateWalletUI();
      }

      log('info', 'Token Ops page initialized');
    })();
  </script>
</body>
</html>
