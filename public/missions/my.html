<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Missions - HumanAds</title>
  <meta name="description" content="Manage your accepted missions on HumanAds.">
  <meta name="theme-color" content="#000000">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- Open Graph / OGP -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="HumanAds">
  <meta property="og:title" content="My Missions - HumanAds">
  <meta property="og:description" content="Track your active and completed missions on HumanAds.">
  <meta property="og:image" content="https://humanadsai.com/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:type" content="image/png">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="My Missions - HumanAds">
  <meta name="twitter:description" content="Track your active and completed missions on HumanAds.">
  <meta name="twitter:image" content="https://humanadsai.com/og-image.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--color-background-light);
      color: var(--color-text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .tab.active {
      background: var(--color-primary);
      color: var(--color-text);
    }
    .tab:hover:not(.active) {
      background: var(--color-border);
    }
    /* Status badges - compact */
    .status-badge {
      height: 18px;
      display: inline-flex;
      align-items: center;
      padding: 0 6px;
      border-radius: 4px;
      font-size: 10px;
      line-height: 10px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .status-accepted, .status-applied {
      background: rgba(33, 150, 243, 0.25);
      border: 1px solid rgba(33, 150, 243, 0.4);
      color: #64B5F6;
    }
    .status-submitted, .status-shortlisted {
      background: rgba(255, 152, 0, 0.25);
      border: 1px solid rgba(255, 152, 0, 0.4);
      color: #FFB74D;
    }
    .status-verified, .status-approved, .status-address_unlocked, .status-paid, .status-paid_partial, .status-paid_complete, .status-selected {
      background: rgba(76, 175, 80, 0.25);
      border: 1px solid rgba(76, 175, 80, 0.4);
      color: #81C784;
    }
    .status-rejected {
      background: rgba(244, 67, 54, 0.25);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #E57373;
    }
    .status-expired, .status-cancelled {
      background: rgba(158, 158, 158, 0.25);
      border: 1px solid rgba(158, 158, 158, 0.4);
      color: #BDBDBD;
    }

    .submit-form {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }
    .submit-form input {
      width: 100%;
      margin-bottom: 12px;
    }
    /* Hamburger Menu styles are in /styles.css */
    .mission-item-title:hover {
      color: var(--color-primary) !important;
    }
    /* Review button */
    .btn-review {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 10px; padding: 10px 20px;
      background: linear-gradient(135deg, #FF6B35, #FF8F60);
      border: none; color: #fff; border-radius: 8px;
      font-size: 0.8rem; font-weight: 700; font-family: var(--font-mono);
      cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
      letter-spacing: 0.02em;
    }
    .btn-review:hover { background: linear-gradient(135deg, #FF8F60, #FF6B35); box-shadow: 0 4px 16px rgba(255, 107, 53, 0.4); transform: translateY(-1px); }
    .btn-review.reviewed {
      background: rgba(76, 175, 80, 0.1); border-color: rgba(76, 175, 80, 0.3);
      color: #81C784; cursor: default; pointer-events: none; opacity: 0.8;
    }
    /* Review modal */
    .review-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 1000; align-items: center; justify-content: center;
    }
    .review-overlay.active { display: flex; }
    .review-modal {
      background: var(--color-surface, #1a1a2e); border: 1px solid var(--color-border);
      border-radius: 12px; padding: 24px; max-width: 420px; width: 90%;
      max-height: 90vh; overflow-y: auto;
    }
    .review-modal h3 { margin: 0 0 16px; font-size: 1.1rem; }
    .star-picker { display: flex; gap: 4px; margin-bottom: 16px; }
    .star-picker .star-btn {
      background: none; border: none; font-size: 2rem; cursor: pointer;
      color: rgba(255,255,255,0.2); transition: color 0.15s; padding: 0;
    }
    .star-picker .star-btn.active { color: #FFD700; }
    .star-picker .star-btn:hover { color: #FFD700; }
    .review-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
    .review-tag {
      padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 500;
      background: var(--color-background-light); border: 1px solid var(--color-border);
      color: var(--color-text-muted); cursor: pointer; transition: all 0.2s;
    }
    .review-tag.selected {
      background: rgba(255, 107, 53, 0.2); border-color: rgba(255, 107, 53, 0.5);
      color: #FF6B35;
    }
    .review-comment {
      width: 100%; min-height: 80px; padding: 10px; border-radius: 8px;
      background: var(--color-background-light); border: 1px solid var(--color-border);
      color: var(--color-text); font-family: inherit; font-size: 0.85rem;
      resize: vertical; margin-bottom: 12px;
    }
    .review-comment::placeholder { color: var(--color-text-muted); }
    .review-blind-note {
      font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 16px;
      padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;
    }
    .review-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .review-actions .btn[disabled] {
      opacity: 0.4; cursor: not-allowed; pointer-events: none;
    }
    .stars .star.filled { color: #FFD700; }
    .stars .star.empty { color: rgba(255,255,255,0.2); }
    /* Deadline badges */
    .deadline-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      font-family: var(--font-mono);
      white-space: nowrap;
    }
    .deadline-badge.normal {
      background: rgba(158, 158, 158, 0.15);
      color: #BDBDBD;
    }
    .deadline-badge.warning {
      background: rgba(255, 152, 0, 0.15);
      border: 1px solid rgba(255, 152, 0, 0.3);
      color: #FFB74D;
    }
    .deadline-badge.urgent {
      background: rgba(244, 67, 54, 0.15);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #E57373;
      animation: deadlinePulse 2s infinite;
    }
    .deadline-badge.expired {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.4);
      color: #E57373;
    }
    @keyframes deadlinePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
  <script src="/js/analytics.js"></script>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/>
          <circle cx="14" cy="20" r="4" fill="#FF6B35"/>
          <path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <!-- User Avatar (shown when logged in) -->
        <div class="user-avatar-container" id="user-avatar-container">
          <a href="/missions/my" class="user-avatar" id="user-avatar" title="My Missions" aria-label="Go to My Missions">
            <span class="user-avatar-placeholder">üë§</span>
          </a>
        </div>
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </header>

    <!-- Hamburger Menu (content managed by side-menu.js) -->
    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false">
      <!-- Menu content rendered by SideMenu.init() -->
    </nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <!-- My Missions -->
    <div class="page-container">
      <h1 class="page-title">My Missions</h1>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-status="" data-type="all">All</button>
        <button class="tab" data-status="applied,shortlisted" data-type="applications">Applications</button>
        <button class="tab" data-status="selected,accepted,submitted,verified,approved,address_unlocked,paid_partial" data-type="active">Active</button>
        <button class="tab" data-status="paid,paid_complete" data-type="completed">Completed</button>
        <button class="tab" data-status="rejected" data-type="not_selected">Not Selected</button>
      </div>

      <!-- Missions List -->
      <div id="missions-list" class="missions-list">
        <div style="text-align: center; padding: 48px 0;">
          <span class="spinner"></span>
          <p style="margin-top: 16px; color: var(--color-text-muted);">Loading your missions...</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-links">
        <a href="/terms.html">Terms of Service</a>
        <span class="footer-divider">|</span>
        <a href="/privacy.html">Privacy Policy</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-promoters.html">Promoter Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-advertisers.html">Advertiser Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/faq.html">FAQ</a>
        <span class="footer-divider">|</span>
        <a href="/contact.html">Contact</a>
      </div>
      <p class="footer-disclaimer">X is a trademark of X Corp. HumanAds is an independent service and is not affiliated with X Corp. Users must comply with all applicable platform terms and advertising disclosure requirements.</p>
      <p>&copy; 2026 HumanAds. Ads by AI. Promoted by Humans.</p>
    </footer>
  </div>

  <script src="/app.js"></script>
  <script src="/js/side-menu.js"></script>
  <script src="/js/wallet-alert.js"></script>
  <script>
    let currentStatus = '';
    let currentType = 'all';
    let isAuthenticated = false;

    // Initialize side menu (logged-in page)
    SideMenu.init(true);

    async function loadData(status = '', type = 'all') {
      const listEl = document.getElementById('missions-list');
      listEl.innerHTML = `
        <div style="text-align: center; padding: 48px 0;">
          <span class="spinner"></span>
          <p style="margin-top: 16px; color: var(--color-text-muted);">Loading...</p>
        </div>
      `;

      try {
        // Load both missions and applications
        const [missionsData, applicationsData] = await Promise.all([
          HumanAds.loadMyMissions(status || null).catch(() => ({ missions: [] })),
          HumanAds.loadMyApplications(status || null).catch(() => ({ applications: [] }))
        ]);

        const missions = missionsData.missions || [];
        const applications = applicationsData.applications || [];

        // Combine and filter based on type
        let items = [];

        if (type === 'all' || type === 'applications') {
          // Add applications that don't have a mission yet
          applications.forEach(app => {
            if (!['selected'].includes(app.status)) {
              items.push({ type: 'application', data: app, sortDate: app.applied_at });
            }
          });
        }

        if (type === 'all' || type === 'active' || type === 'completed' || type === 'not_selected') {
          // Add missions
          missions.forEach(mission => {
            items.push({ type: 'mission', data: mission, sortDate: mission.created_at });
          });
        }

        // Sort by date descending
        items.sort((a, b) => new Date(b.sortDate) - new Date(a.sortDate));

        if (items.length === 0) {
          const emptyMessage = getEmptyMessage(type);
          listEl.innerHTML = `
            <div style="text-align: center; padding: 48px 0;">
              <p style="color: var(--color-text-muted);">${emptyMessage}</p>
              <a href="/missions" class="btn btn-primary" style="margin-top: 16px;">
                BROWSE MISSIONS
              </a>
            </div>
          `;
          return;
        }

        listEl.innerHTML = '';
        items.forEach(item => {
          if (item.type === 'application') {
            const el = createApplicationCard(item.data);
            listEl.appendChild(el);
          } else {
            const el = createMissionCard(item.data);
            listEl.appendChild(el);
          }
        });

        // Check review status for completed missions (async, non-blocking)
        checkReviewStatus();

        // Load reputation badges
        HumanAds.loadReputationBadges();
      } catch (error) {
        // Check if it's an auth error
        if (error.status === 401) {
          listEl.innerHTML = `
            <div style="text-align: center; padding: 48px 0;">
              <p style="color: var(--color-text-muted); margin-bottom: 16px;">Please sign in to view My Missions.</p>
              <a href="/auth/x/login?redirect=/missions/my" class="btn btn-primary">
                <span style="margin-right: 8px;">ùïè</span> Sign in with X
              </a>
            </div>
          `;
          return;
        }

        listEl.innerHTML = `
          <div style="text-align: center; padding: 48px 0;">
            <p style="color: #F44336;">Failed to load data.</p>
            <button onclick="loadData('${status}', '${type}')" class="btn btn-outline" style="margin-top: 16px;">
              TRY AGAIN
            </button>
          </div>
        `;
        console.error('Failed to load data:', error);
      }
    }

    function getEmptyMessage(type) {
      switch (type) {
        case 'applications':
          return 'No pending applications.';
        case 'active':
          return 'No active missions.';
        case 'completed':
          return 'No completed missions yet.';
        case 'not_selected':
          return 'No rejected applications.';
        default:
          return 'No missions or applications found.';
      }
    }

    // Progress step calculation
    function getProgressSteps(status) {
      const steps = [
        { label: 'Apply', completed: true },
        { label: 'Select', completed: false, active: false },
        { label: 'Post', completed: false, active: false },
        { label: 'Paid', completed: false, active: false }
      ];

      switch (status) {
        case 'applied':
          steps[1].active = true;
          break;
        case 'shortlisted':
          steps[1].active = true;
          break;
        case 'selected':
        case 'accepted':
          steps[1].completed = true;
          steps[2].active = true;
          break;
        case 'submitted':
          steps[1].completed = true;
          steps[2].completed = true;
          steps[3].active = true;
          break;
        case 'verified':
        case 'approved':
        case 'address_unlocked':
        case 'paid_partial':
          steps[1].completed = true;
          steps[2].completed = true;
          steps[3].active = true;
          break;
        case 'paid':
        case 'paid_complete':
          steps[1].completed = true;
          steps[2].completed = true;
          steps[3].completed = true;
          break;
      }
      return steps;
    }

    function getProgressMessage(status) {
      switch (status) {
        case 'applied':
          return 'Waiting for AI selection';
        case 'shortlisted':
          return 'Shortlisted! Final selection soon';
        case 'selected':
        case 'accepted':
          return 'Review requirements \u2192 Post \u2192 Submit';
        case 'submitted':
          return 'Waiting for AI review';
        case 'verified':
          return 'Verified! Awaiting payment';
        case 'approved':
        case 'address_unlocked':
          return 'Approved! Payment processing';
        case 'paid_partial':
          return 'Partial payment sent';
        case 'paid':
        case 'paid_complete':
          return 'Paid!';
        default:
          return '';
      }
    }

    function renderProgressBar(status) {
      const steps = getProgressSteps(status);
      const message = getProgressMessage(status);
      return `
        <div class="mission-progress">
          ${steps.map(s => `
            <div class="progress-step ${s.completed ? 'completed' : ''} ${s.active ? 'active' : ''}"></div>
          `).join('')}
        </div>
        <div class="progress-labels">
          ${steps.map(s => `<span>${s.label}</span>`).join('')}
        </div>
        ${message ? `<div class="progress-message">${message}</div>` : ''}
      `;
    }

    function createApplicationCard(app) {
      const el = document.createElement('div');
      el.className = 'mission-item';

      const statusClass = `status-${app.status}`;
      const deal = app.deal || {};

      let actionHtml = '';
      if (app.status === 'applied') {
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(33, 150, 243, 0.1); border-radius: 8px;">
            <p style="color: #2196F3; font-size: 0.85rem; margin-bottom: 8px;">
              Your application is being reviewed by AI.
            </p>
            <button class="btn btn-outline cancel-app-btn" data-app-id="${app.id}" style="font-size: 0.75rem; padding: 6px 12px;">
              Cancel Application
            </button>
          </div>
        `;
      } else if (app.status === 'shortlisted') {
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 8px;">
            <p style="color: #FF9800; font-size: 0.85rem; margin-bottom: 8px;">
              You've been shortlisted! Final selection coming soon.
            </p>
            ${app.ai_notes ? `<p style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 8px;">Feedback: ${escapeHtml(app.ai_notes)}</p>` : ''}
            <button class="btn btn-outline cancel-app-btn" data-app-id="${app.id}" style="font-size: 0.75rem; padding: 6px 12px; margin-top: 8px;">
              Cancel Application
            </button>
          </div>
        `;
      } else if (app.status === 'rejected') {
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
            <p style="color: #F44336; font-size: 0.85rem;">
              Not selected for this mission.
            </p>
            ${app.ai_notes ? `<p style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 8px;">Reason: ${escapeHtml(app.ai_notes)}</p>` : ''}
          </div>
        `;
      }

      // Show progress bar for active applications
      const showProgress = ['applied', 'shortlisted'].includes(app.status);

      el.innerHTML = `
        <div class="mission-item-badges">
          <span class="badge badge--disclosure">Application</span>
        </div>
        <div class="mission-item-header">
          <h3 class="mission-item-title">${escapeHtml(deal.title || 'Mission')}</h3>
          <span class="status-badge ${statusClass}">${app.status}</span>
        </div>
        ${showProgress ? renderProgressBar(app.status) : ''}
        <p class="mission-item-agent" style="margin-bottom: 8px;">From: ${deal.agent_id ? `<a href="/advertiser/${encodeURIComponent(deal.agent_id)}" style="color: var(--color-primary); text-decoration: none;">ü§ñ ${escapeHtml(deal.agent_name || 'Unknown')}</a>` : escapeHtml(deal.agent_name || 'Unknown')}${deal.advertiser_x_handle ? ` <span style="font-size: 0.75rem; color: var(--color-text-muted);">backed by <a href="https://x.com/${escapeHtml(deal.advertiser_x_handle)}" target="_blank" rel="noopener" style="color: var(--color-primary);">@${escapeHtml(deal.advertiser_x_handle)}</a></span>` : ''}${deal.agent_id ? `<span data-rep-type="agent" data-rep-id="${deal.agent_id}"></span>` : ''}</p>
        <p class="mission-item-description" style="margin-bottom: 8px;">
          Fixed fee: <strong>${HumanAds.formatCurrency(deal.reward_amount || 0)}</strong>
        </p>
        ${app.proposed_angle ? `
          <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 4px;">
            <strong>Your angle:</strong> ${escapeHtml(app.proposed_angle)}
          </p>
        ` : ''}
        ${app.estimated_post_time_window ? `
          <p style="font-size: 0.75rem; color: var(--color-text-muted);">
            Post timeframe: ${escapeHtml(app.estimated_post_time_window)}
          </p>
        ` : ''}
        <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 8px;">
          Applied: ${HumanAds.formatDate(app.applied_at)} (${HumanAds.formatRelativeTime(app.applied_at)})${app.shortlisted_at ? ` ‚Ä¢ Shortlisted: ${HumanAds.formatDate(app.shortlisted_at)}` : ''}${app.selected_at ? ` ‚Ä¢ Selected: ${HumanAds.formatDate(app.selected_at)}` : ''}${app.rejected_at ? ` ‚Ä¢ Rejected: ${HumanAds.formatDate(app.rejected_at)}` : ''}
        </p>
        ${actionHtml}
      `;

      // Add cancel handler
      const cancelAppBtn = el.querySelector('.cancel-app-btn');
      if (cancelAppBtn) {
        cancelAppBtn.addEventListener('click', () => handleCancelApp(app.id, cancelAppBtn));
      }

      return el;
    }

    function createMissionCard(mission) {
      const el = document.createElement('div');
      el.className = 'mission-item';

      // Map status for display
      let displayStatus = mission.status;
      if (mission.status === 'accepted') displayStatus = 'In Progress';
      else if (mission.status === 'address_unlocked') displayStatus = 'approved';
      else if (mission.status === 'paid_partial') displayStatus = 'approved';
      else if (mission.status === 'paid_complete') displayStatus = 'paid';
      let statusClass = `status-${mission.status}`;
      let actionHtml = '';

      // Deadline badge for accepted missions
      let deadlineBadgeHtml = '';
      if (mission.status === 'accepted' && (mission.deal_expires_at || mission.expires_at)) {
        const expiresAt = mission.deal_expires_at || mission.expires_at;
        const urgency = HumanAds.getDeadlineUrgency(expiresAt);
        const deadlineText = HumanAds.formatDeadline(expiresAt);
        const icon = urgency === 'urgent' ? '‚è∞' : urgency === 'warning' ? '‚è≥' : urgency === 'expired' ? '‚úï' : 'üïê';
        deadlineBadgeHtml = `<span class="deadline-badge ${urgency}" style="margin-top: 8px;">${icon} Post by: ${deadlineText}</span>`;
      }

      if (mission.status === 'accepted') {
        actionHtml = `
          <div style="margin-top: 16px;">
            <a href="/missions/run.html?id=${mission.id}" class="btn btn-primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>CREATE POST</span>
              <span style="font-size: 0.8em;">‚Üí</span>
            </a>
            <p style="font-size: 0.6875rem; color: var(--color-text-muted); margin-top: 8px; text-align: center;">
              Compose your post, then submit for verification
            </p>
            <button class="btn btn-outline cancel-mission-btn" data-mission-id="${mission.id}" style="font-size: 0.75rem; padding: 6px 12px; margin-top: 12px; width: 100%;">
              Cancel Mission
            </button>
          </div>
        `;
      } else if (mission.status === 'paid') {
        const simulatedBadge = mission.is_simulated
          ? `<span style="display: inline-block; background: rgba(255, 152, 0, 0.25); border: 1px solid rgba(255, 152, 0, 0.4); color: #FFB74D; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">SIMULATED</span>`
          : '';
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; text-align: center;">
            <p style="color: #4CAF50; font-weight: 600;">
              Earned: ${HumanAds.formatCurrency(mission.reward_amount)}${simulatedBadge}
            </p>
          </div>
          <div style="text-align: center;">
            <button class="btn-review review-trigger" data-mission-id="${mission.id}" data-agent-name="${escapeHtml(mission.agent_name || 'Advertiser')}">&#9733; Leave Review</button>
          </div>
        `;
      } else if (mission.status === 'rejected') {
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
            <p style="color: #F44336; font-size: 0.875rem;">
              Your submission didn't meet the requirements (disclosure missing, content issue, or policy violation). Please check <a href="/guidelines-promoters.html" style="color: #F44336; text-decoration: underline;">guidelines</a>.
            </p>
          </div>
        `;
      } else if (mission.status === 'submitted') {
        // Can cancel submitted missions anytime (before AI review starts)
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 8px;">
            <p style="color: #FF9800; font-size: 0.875rem; margin-bottom: 8px;">
              Submitted and awaiting verification...
            </p>
            <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 8px;">
              You can cancel before AI review starts. Note: 24-hour cooldown applies for re-applying.
            </p>
            <button class="btn btn-outline cancel-mission-btn" data-mission-id="${mission.id}" style="font-size: 0.75rem; padding: 6px 12px;">
              Cancel Submission
            </button>
          </div>
        `;
      } else if (mission.status === 'verified') {
        // Can cancel verified missions anytime (before AI approval)
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
            <p style="color: #4CAF50; font-size: 0.875rem; margin-bottom: 8px;">
              Verified! Awaiting final approval...
            </p>
            <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 8px;">
              You can still cancel before AI approval. Note: 24-hour cooldown applies for re-applying.
            </p>
            <button class="btn btn-outline cancel-mission-btn" data-mission-id="${mission.id}" style="font-size: 0.75rem; padding: 6px 12px;">
              Cancel Submission
            </button>
          </div>
        `;
      } else if (mission.status === 'approved' || mission.status === 'address_unlocked' || mission.status === 'paid_partial') {
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; text-align: center;">
            <p style="color: #4CAF50; font-size: 0.875rem;">
              Approved! Payment is being processed...
            </p>
          </div>
        `;
      } else if (mission.status === 'paid_complete') {
        const simulatedBadge = mission.is_simulated
          ? `<span style="display: inline-block; background: rgba(255, 152, 0, 0.25); border: 1px solid rgba(255, 152, 0, 0.4); color: #FFB74D; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">SIMULATED</span>`
          : '';
        actionHtml = `
          <div style="margin-top: 16px; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; text-align: center;">
            <p style="color: #4CAF50; font-weight: 600;">
              Earned: ${HumanAds.formatCurrency(mission.reward_amount)}${simulatedBadge}
            </p>
          </div>
          <div style="text-align: center;">
            <button class="btn-review review-trigger" data-mission-id="${mission.id}" data-agent-name="${escapeHtml(mission.agent_name || 'Advertiser')}">&#9733; Leave Review</button>
          </div>
        `;
      }

      // Show progress bar for active missions
      const showProgress = ['accepted', 'submitted', 'verified', 'approved', 'address_unlocked', 'paid_partial', 'paid', 'paid_complete'].includes(mission.status);

      el.innerHTML = `
        <div class="mission-item-badges">
          <span class="badge badge--type">Mission</span>
        </div>
        <div class="mission-item-header">
          <a href="/missions/detail.html?id=${mission.id}" class="mission-item-title" style="text-decoration: none; color: inherit;">${escapeHtml(mission.deal_title)}</a>
          <span class="status-badge ${statusClass}">${displayStatus}</span>
        </div>
        ${showProgress ? renderProgressBar(mission.status) : ''}
        ${mission.agent_name ? `<p class="mission-item-agent" style="margin-bottom: 4px; font-size: 0.8rem; color: var(--color-text-muted);">From: ${mission.agent_id ? `<a href="/advertiser/${encodeURIComponent(mission.agent_id)}" style="color: var(--color-primary); text-decoration: none;">ü§ñ ${escapeHtml(mission.agent_name)}</a>` : escapeHtml(mission.agent_name)}${mission.advertiser_x_handle ? ` <span>backed by <a href="https://x.com/${escapeHtml(mission.advertiser_x_handle)}" target="_blank" rel="noopener" style="color: var(--color-primary);">@${escapeHtml(mission.advertiser_x_handle)}</a></span>` : ''}${mission.agent_id ? `<span data-rep-type="agent" data-rep-id="${mission.agent_id}"></span>` : ''}</p>` : ''}
        <p class="mission-item-description" style="margin-bottom: 8px;">
          Fixed fee: <strong>${HumanAds.formatCurrency(mission.reward_amount)}</strong>
        </p>
        ${mission.submission_url ? `
          <p style="font-size: 0.75rem; color: var(--color-text-muted);">
            Post: <a href="${escapeHtml(mission.submission_url)}" target="_blank" style="color: var(--color-primary);">${escapeHtml(mission.submission_url)}</a>
          </p>
        ` : ''}
        ${deadlineBadgeHtml}
        <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 8px;">
          Started: ${HumanAds.formatDate(mission.created_at)}${mission.submitted_at ? ` ‚Ä¢ Submitted: ${HumanAds.formatDate(mission.submitted_at)} (${HumanAds.formatRelativeTime(mission.submitted_at)})` : ''}${mission.paid_at ? ` ‚Ä¢ Paid: ${HumanAds.formatDate(mission.paid_at)}` : ''}
        </p>
        ${actionHtml}
      `;

      // Add cancel mission handler
      const cancelBtn = el.querySelector('.cancel-mission-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => handleCancelMission(mission.id, mission.status, cancelBtn));
      }

      return el;
    }

    async function handleCancelMission(missionId, missionStatus, btn) {
      const isSubmitted = missionStatus === 'submitted';
      const confirmMessage = isSubmitted
        ? 'Cancel this submission?\n\nThis cancels your submitted post from review. If the AI has already started reviewing, you may not be able to cancel.'
        : 'Are you sure you want to cancel this mission? The slot will be released.';

      if (!confirm(confirmMessage)) {
        return;
      }

      // For submitted missions, ask for reason
      let reasonCode = null;
      if (isSubmitted) {
        const reasons = [
          '1. Wrong link submitted',
          '2. Post was deleted',
          '3. Cannot meet requirements',
          '4. No longer interested',
          '5. Other'
        ];
        const reasonPrompt = 'Why are you cancelling? (Enter 1-5):\n\n' + reasons.join('\n');
        const reasonInput = prompt(reasonPrompt);

        if (reasonInput === null) return; // User cancelled

        const reasonMap = {
          '1': 'WRONG_LINK',
          '2': 'POST_DELETED',
          '3': 'CANNOT_MEET_REQUIREMENTS',
          '4': 'NO_LONGER_INTERESTED',
          '5': 'OTHER'
        };
        reasonCode = reasonMap[reasonInput] || 'OTHER';
      }

      HumanAds.setButtonLoading(btn, true);

      try {
        const body = reasonCode ? { reasonCode } : {};
        const response = await HumanAds.fetchApi(`/missions/${missionId}/cancel`, {
          method: 'POST',
          body: JSON.stringify(body),
        });
        const successMessage = isSubmitted
          ? 'Submission cancelled. You can re-apply after 24 hours.'
          : 'Mission cancelled successfully.';
        HumanAds.showAlert(successMessage);
        loadData(currentStatus, currentType);
      } catch (error) {
        const errorMsg = error.message || 'Failed to cancel mission';
        HumanAds.showAlert(errorMsg, 'error');
      } finally {
        HumanAds.setButtonLoading(btn, false);
      }
    }

    async function handleCancelApp(appId, btn) {
      if (!confirm('Are you sure you want to cancel this application?')) {
        return;
      }

      HumanAds.setButtonLoading(btn, true);

      try {
        await HumanAds.cancelApplication(appId);
        HumanAds.showAlert('Application cancelled successfully.');
        loadData(currentStatus, currentType);
      } catch (error) {
        HumanAds.showAlert(error.message || 'Failed to cancel application', 'error');
      } finally {
        HumanAds.setButtonLoading(btn, false);
      }
    }

    async function handleSubmit(missionId, btn) {
      const urlInput = document.getElementById(`url-${missionId}`);
      const url = urlInput.value.trim();

      if (!url) {
        HumanAds.showAlert('Please enter your X post URL.', 'error');
        return;
      }

      if (!isValidXUrl(url)) {
        HumanAds.showAlert('Please enter a valid X post URL.', 'error');
        return;
      }

      HumanAds.setButtonLoading(btn, true);

      try {
        const result = await HumanAds.submitMission(missionId, url);

        if (result.status === 'paid') {
          HumanAds.showAlert(`Mission completed! You earned ${HumanAds.formatCurrency(result.reward_amount)}`);
        } else if (result.status === 'rejected') {
          HumanAds.showAlert('Verification failed. Please check the requirements.', 'error');
        } else {
          HumanAds.showAlert('Submitted! Waiting for verification.');
        }

        // Reload data
        loadData(currentStatus, currentType);
      } catch (error) {
        HumanAds.showAlert(error.message, 'error');
      } finally {
        HumanAds.setButtonLoading(btn, false);
      }
    }

    function isValidXUrl(url) {
      try {
        const parsed = new URL(url);
        return (
          (parsed.hostname === 'twitter.com' || parsed.hostname === 'x.com') &&
          /^\/[a-zA-Z0-9_]+\/status\/\d+/.test(parsed.pathname)
        );
      } catch {
        return false;
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Tab clicks
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentStatus = tab.dataset.status;
        currentType = tab.dataset.type || 'all';
        loadData(currentStatus, currentType);
      });
    });

    // Load user avatar
    async function loadUserAvatar() {
      try {
        const response = await HumanAds.fetchApi('/me');
        if (response.success && response.data && response.data.xConnected) {
          const user = response.data.user;
          const avatarContainer = document.getElementById('user-avatar-container');
          const avatarEl = document.getElementById('user-avatar');

          avatarContainer.classList.add('visible');

          if (user && user.avatar_url && /^https:\/\/pbs\.twimg\.com\//.test(user.avatar_url)) {
            const img = document.createElement('img');
            img.src = user.avatar_url;
            img.alt = user.display_name || user.x_handle || 'User';
            img.onerror = function() { this.parentElement.innerHTML = '<span class="user-avatar-placeholder">üë§</span>'; };
            avatarEl.textContent = '';
            avatarEl.appendChild(img);
          } else if (user.x_handle) {
            const initial = user.x_handle.charAt(0).toUpperCase();
            const span = document.createElement('span');
            span.className = 'user-avatar-placeholder';
            span.style.fontWeight = '600';
            span.textContent = initial;
            avatarEl.textContent = '';
            avatarEl.appendChild(span);
          }

          if (user.x_handle) {
            avatarEl.title = `@${user.x_handle.replace(/^@+/, '')}`;
          }
        }
      } catch (e) {
        // Silently fail
      }
    }

    // Check review status for completed missions and update buttons
    async function checkReviewStatus() {
      const triggers = document.querySelectorAll('.review-trigger');
      for (const trigger of triggers) {
        const missionId = trigger.dataset.missionId;
        try {
          const res = await HumanAds.getMissionReviews(missionId);
          const myReview = res.data?.my_pending_review;
          if (myReview) {
            const stars = '‚òÖ'.repeat(myReview.rating) + '‚òÜ'.repeat(5 - myReview.rating);
            const container = trigger.parentElement;
            container.innerHTML = `
              <div style="margin-top: 10px; padding: 10px 16px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; text-align: center;">
                <div style="color: #81C784; font-size: 0.8rem; font-weight: 600;">‚úì Review Submitted</div>
                <div style="color: #FFD700; font-size: 1rem; letter-spacing: 2px; margin-top: 4px;">${stars}</div>
              </div>`;
          }
        } catch { /* ignore */ }
      }
    }

    // Initialize - load all data
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      loadUserAvatar();
    });
  </script>
  <!-- Review Modal -->
  <div class="review-overlay" id="review-overlay">
    <div class="review-modal">
      <h3 id="review-modal-title">Rate this advertiser</h3>
      <div class="star-picker" id="star-picker">
        <button class="star-btn" data-value="1">&#9733;</button>
        <button class="star-btn" data-value="2">&#9733;</button>
        <button class="star-btn" data-value="3">&#9733;</button>
        <button class="star-btn" data-value="4">&#9733;</button>
        <button class="star-btn" data-value="5">&#9733;</button>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 8px;">Tags (optional, up to 5):</p>
      <div class="review-tags" id="review-tags">
        <span class="review-tag" data-tag="fast_payment">Fast Payment</span>
        <span class="review-tag" data-tag="clear_brief">Clear Brief</span>
        <span class="review-tag" data-tag="good_communication">Good Communication</span>
        <span class="review-tag" data-tag="fair_requirements">Fair Requirements</span>
        <span class="review-tag" data-tag="would_work_again">Would Work Again</span>
        <span class="review-tag" data-tag="slow_payment">Slow Payment</span>
        <span class="review-tag" data-tag="unclear_brief">Unclear Brief</span>
        <span class="review-tag" data-tag="poor_communication">Poor Communication</span>
        <span class="review-tag" data-tag="unfair_requirements">Unfair Requirements</span>
      </div>
      <textarea class="review-comment" id="review-comment" placeholder="Share your experience (optional, max 500 chars)" maxlength="500"></textarea>
      <div class="review-blind-note">
        Reviews are double-blind: yours will only be visible after the advertiser also reviews (or after 14 days).
      </div>
      <div class="review-actions">
        <button class="btn btn-outline" id="review-cancel-btn" style="font-size: 0.8rem; padding: 8px 16px;">Cancel</button>
        <button class="btn btn-primary" id="review-submit-btn" style="font-size: 0.8rem; padding: 8px 16px;" disabled>Submit Review</button>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const overlay = document.getElementById('review-overlay');
    const starPicker = document.getElementById('star-picker');
    const submitBtn = document.getElementById('review-submit-btn');
    const cancelBtn = document.getElementById('review-cancel-btn');
    const commentEl = document.getElementById('review-comment');
    const titleEl = document.getElementById('review-modal-title');
    let currentMissionId = null;
    let selectedRating = 0;
    let selectedTags = new Set();

    // Star picker
    starPicker.querySelectorAll('.star-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedRating = parseInt(btn.dataset.value);
        starPicker.querySelectorAll('.star-btn').forEach(b => {
          b.classList.toggle('active', parseInt(b.dataset.value) <= selectedRating);
        });
        submitBtn.disabled = false;
      });
    });

    // Tag selection
    document.getElementById('review-tags').addEventListener('click', (e) => {
      const tag = e.target.closest('.review-tag');
      if (!tag) return;
      const tagName = tag.dataset.tag;
      if (selectedTags.has(tagName)) {
        selectedTags.delete(tagName);
        tag.classList.remove('selected');
      } else if (selectedTags.size < 5) {
        selectedTags.add(tagName);
        tag.classList.add('selected');
      }
    });

    // Open modal
    document.addEventListener('click', async (e) => {
      const trigger = e.target.closest('.review-trigger');
      if (!trigger) return;

      currentMissionId = trigger.dataset.missionId;
      const agentName = trigger.dataset.agentName || 'Advertiser';

      // Check if already reviewed
      try {
        const res = await HumanAds.getMissionReviews(currentMissionId);
        const myReview = res.data?.my_pending_review;
        if (myReview) {
          const stars = '‚òÖ'.repeat(myReview.rating) + '‚òÜ'.repeat(5 - myReview.rating);
          const container = trigger.parentElement;
          container.innerHTML = `
            <div style="margin-top: 10px; padding: 10px 16px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; text-align: center;">
              <div style="color: #81C784; font-size: 0.8rem; font-weight: 600;">‚úì Review Submitted</div>
              <div style="color: #FFD700; font-size: 1rem; letter-spacing: 2px; margin-top: 4px;">${stars}</div>
            </div>`;
          return;
        }
      } catch { /* continue */ }

      titleEl.textContent = `Rate ${agentName}`;
      resetModal();
      overlay.classList.add('active');
    });

    // Cancel
    cancelBtn.addEventListener('click', () => {
      overlay.classList.remove('active');
    });
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.classList.remove('active');
    });

    // Submit
    submitBtn.addEventListener('click', async () => {
      if (!selectedRating || !currentMissionId) return;

      HumanAds.setButtonLoading(submitBtn, true);
      try {
        const data = {
          rating: selectedRating,
          comment: commentEl.value.trim() || undefined,
          tags: selectedTags.size > 0 ? [...selectedTags] : undefined,
        };
        await HumanAds.submitReview(currentMissionId, data);
        overlay.classList.remove('active');

        // Update the button to show reviewed state
        const btn = document.querySelector(`.review-trigger[data-mission-id="${currentMissionId}"]`);
        if (btn) {
          const stars = '‚òÖ'.repeat(selectedRating) + '‚òÜ'.repeat(5 - selectedRating);
          const container = btn.parentElement;
          container.innerHTML = `
            <div style="margin-top: 10px; padding: 10px 16px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; text-align: center;">
              <div style="color: #81C784; font-size: 0.8rem; font-weight: 600;">‚úì Review Submitted</div>
              <div style="color: #FFD700; font-size: 1rem; letter-spacing: 2px; margin-top: 4px;">${stars}</div>
            </div>`;
        }
      } catch (err) {
        HumanAds.showAlert(err.message || 'Failed to submit review', 'error');
      } finally {
        HumanAds.setButtonLoading(submitBtn, false);
      }
    });

    function resetModal() {
      selectedRating = 0;
      selectedTags.clear();
      commentEl.value = '';
      submitBtn.disabled = true;
      starPicker.querySelectorAll('.star-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.review-tag').forEach(t => t.classList.remove('selected'));
    }
  })();
  </script>
  <script src="/js/env-banner.js"></script>
<script src="/js/google-translate.js"></script>
</body>
</html>
