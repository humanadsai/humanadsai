<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Advertiser Test - HumanAds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    .test-page {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: 100px;
    }
    .test-header {
      margin-bottom: 24px;
      text-align: center;
    }
    .test-header h1 {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      margin-bottom: 8px;
    }
    .test-header p {
      color: var(--color-text-muted);
      font-size: 0.8125rem;
    }
    .env-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-family: var(--font-mono);
      margin-top: 8px;
    }
    .env-badge.ledger { background: rgba(52, 199, 89, 0.2); color: #34c759; }
    .env-badge.onchain { background: rgba(255, 149, 0, 0.2); color: #ff9500; }
    .env-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .wallet-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-family: var(--font-mono);
    }
    .wallet-status.connected {
      background: rgba(52, 199, 89, 0.1);
      border: 1px solid rgba(52, 199, 89, 0.3);
      color: #34c759;
    }
    .wallet-status.disconnected {
      background: rgba(255, 149, 0, 0.1);
      border: 1px solid rgba(255, 149, 0, 0.3);
      color: #ff9500;
    }
    .wallet-status .wallet-icon {
      width: 16px;
      height: 16px;
    }

    .step-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .step-card.completed {
      border-color: rgba(52, 199, 89, 0.5);
      background: rgba(52, 199, 89, 0.05);
    }
    .step-card.active {
      border-color: var(--color-primary);
      background: rgba(255, 107, 53, 0.05);
    }
    .step-card.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .step-card.completed .step-number {
      background: #34c759;
      color: white;
    }
    .step-card.active .step-number {
      background: var(--color-primary);
      color: white;
    }
    .step-title {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      font-weight: 600;
    }
    .step-description {
      color: var(--color-text-muted);
      font-size: 0.8125rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .input-group {
      margin-bottom: 10px;
    }
    .input-group label {
      display: block;
      font-size: 0.6875rem;
      color: var(--color-text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 10px 12px;
      background: var(--color-background-light);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--color-primary);
    }
    .input-group input::placeholder {
      color: var(--color-text-muted);
      opacity: 0.6;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 0.8125rem;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--color-border);
      background: var(--color-background-light);
      color: var(--color-text);
      width: 100%;
    }
    .btn:hover:not(:disabled) {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.primary {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }
    .btn.primary:hover:not(:disabled) {
      background: #e55a2b;
    }
    .btn.success {
      background: #34c759;
      border-color: #34c759;
      color: white;
    }
    .btn.wallet {
      background: linear-gradient(135deg, #7B3FE4 0%, #A855F7 100%);
      border-color: transparent;
      color: white;
    }
    .btn.wallet:hover:not(:disabled) {
      opacity: 0.9;
    }
    .btn.wallet.connected {
      background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
    }
    .btn.metamask {
      background: linear-gradient(135deg, #F6851B 0%, #E2761B 100%);
      border-color: transparent;
      color: white;
    }
    .btn.metamask:hover:not(:disabled) {
      opacity: 0.9;
    }
    .btn.secondary {
      background: transparent;
      border: 1px dashed var(--color-border);
      color: var(--color-text-muted);
      font-size: 0.75rem;
    }
    .btn.secondary:hover:not(:disabled) {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn-row .btn {
      flex: 1;
      min-width: 120px;
    }

    .result-box {
      background: var(--color-background-light);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      display: none;
    }
    .result-box.show { display: block; }
    .result-box.error {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.2);
    }
    .result-box.success {
      background: rgba(52, 199, 89, 0.1);
      color: #34c759;
      border: 1px solid rgba(52, 199, 89, 0.2);
    }
    .result-box pre {
      margin: 8px 0 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.8125rem;
    }
    .info-row:last-child { border-bottom: none; }
    .info-row .label {
      color: var(--color-text-muted);
    }
    .info-row .value {
      font-family: var(--font-mono);
      font-weight: 500;
      max-width: 60%;
      text-align: right;
      word-break: break-all;
    }
    .info-row .value.highlight {
      color: var(--color-primary);
    }
    .info-row .value.success {
      color: #34c759;
    }

    .payment-box {
      background: rgba(255, 107, 53, 0.1);
      border: 1px solid rgba(255, 107, 53, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .payment-box .title {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--color-primary);
      margin-bottom: 8px;
    }

    .timeline {
      margin-top: 24px;
      padding: 16px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
    }
    .timeline h3 {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      margin-bottom: 12px;
    }
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      font-size: 0.75rem;
    }
    .timeline-item .step {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 0.625rem;
      flex-shrink: 0;
    }
    .timeline-item.done .step {
      background: #34c759;
      color: white;
    }
    .timeline-item .content {
      flex: 1;
    }
    .timeline-item .name {
      font-weight: 500;
    }
    .timeline-item .id {
      color: var(--color-text-muted);
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      word-break: break-all;
    }

    .complete-banner {
      background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
      color: white;
      text-align: center;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .complete-banner h2 {
      font-family: var(--font-mono);
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    .complete-banner p {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .loading { text-align: center; padding: 40px; color: var(--color-text-muted); }
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Wallet Modal Styles */
    .wallet-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .wallet-modal {
      background: var(--color-surface);
      border-radius: 16px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .wallet-modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .wallet-modal-header h3 {
      font-family: var(--font-mono);
      font-size: 1rem;
      margin: 0;
    }
    .wallet-modal-close {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 1.5rem;
      line-height: 1;
    }
    .wallet-modal-body {
      padding: 16px;
    }
    .wallet-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--color-background-light);
    }
    .wallet-option:hover {
      border-color: var(--color-primary);
      background: rgba(255, 107, 53, 0.05);
    }
    .wallet-option.recommended {
      border-color: var(--color-primary);
    }
    .wallet-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .wallet-option-info {
      flex: 1;
    }
    .wallet-option-name {
      font-weight: 600;
      font-size: 0.875rem;
    }
    .wallet-option-desc {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 2px;
    }
    .wallet-option-badge {
      font-size: 0.625rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--color-primary);
      color: white;
    }
    .wallet-section-title {
      font-size: 0.6875rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 16px 0 8px;
    }
    .wallet-section-title:first-child {
      margin-top: 0;
    }
    .wallet-qr-container {
      text-align: center;
      padding: 20px;
    }
    .wallet-qr-container canvas {
      border-radius: 12px;
      max-width: 100%;
    }
    .wallet-qr-uri {
      margin-top: 12px;
      padding: 8px;
      background: var(--color-background-light);
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      word-break: break-all;
      color: var(--color-text-muted);
    }
    .wallet-copy-btn {
      margin-top: 8px;
      padding: 8px 16px;
      font-size: 0.75rem;
    }
    .wallet-back-btn {
      margin-top: 16px;
      width: 100%;
    }
    .wallet-deep-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .wallet-deep-link {
      flex: 1;
      min-width: calc(50% - 4px);
      padding: 10px;
      font-size: 0.75rem;
      text-align: center;
      border-radius: 8px;
      background: var(--color-background-light);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .wallet-deep-link:hover {
      border-color: var(--color-primary);
    }

    /* Copy/Paste buttons */
    .copy-btn, .paste-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 4px 8px;
      font-size: 0.625rem;
      font-family: var(--font-mono);
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--color-border);
      background: var(--color-background-light);
      color: var(--color-text-muted);
      transition: all 0.2s;
    }
    .copy-btn:hover, .paste-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    .copy-btn.copied {
      background: rgba(52, 199, 89, 0.1);
      border-color: #34c759;
      color: #34c759;
    }
    .info-row-with-copy {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.8125rem;
      gap: 8px;
    }
    .info-row-with-copy:last-child { border-bottom: none; }
    .info-row-with-copy .label {
      color: var(--color-text-muted);
      flex-shrink: 0;
    }
    .info-row-with-copy .value-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      justify-content: flex-end;
      min-width: 0;
    }
    .info-row-with-copy .value {
      font-family: var(--font-mono);
      font-weight: 500;
      word-break: break-all;
      text-align: right;
    }
    .info-row-with-copy .value.highlight {
      color: var(--color-primary);
    }
    .input-with-paste {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .input-with-paste input {
      flex: 1;
    }
    .input-with-paste .paste-btn {
      padding: 10px 12px;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    /* Fallback message box */
    .fallback-box {
      background: rgba(255, 149, 0, 0.1);
      border: 1px solid rgba(255, 149, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      text-align: center;
    }
    .fallback-box .title {
      font-family: var(--font-mono);
      font-weight: 600;
      color: #ff9500;
      margin-bottom: 8px;
    }
    .fallback-box .desc {
      font-size: 0.8125rem;
      color: var(--color-text-muted);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    /* MetaMask install notice */
    .install-notice {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-align: center;
      margin-top: 8px;
    }
    .install-notice a {
      color: var(--color-primary);
      text-decoration: underline;
    }

    @media (max-width: 480px) {
      .btn-row { flex-direction: column; }
      .btn-row .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/>
          <circle cx="14" cy="20" r="4" fill="#FF6B35"/>
          <path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </header>
    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false"></nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <main class="test-page" id="content">
      <div class="loading"><span class="spinner"></span> Loading...</div>
    </main>

    <!-- Wallet Selection Modal -->
    <div id="wallet-modal" class="wallet-modal-overlay" style="display:none;">
      <div class="wallet-modal">
        <div class="wallet-modal-header">
          <h3 id="wallet-modal-title">Connect Wallet</h3>
          <button class="wallet-modal-close" onclick="closeWalletModal()">&times;</button>
        </div>
        <div class="wallet-modal-body" id="wallet-modal-body">
          <!-- Content inserted dynamically -->
        </div>
      </div>
    </div>
  </div>

  <script src="/js/side-menu.js"></script>
  <script src="/js/humanads.js"></script>
  <!-- Ethers.js for wallet interactions -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <!-- QRCode for WalletConnect QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- WalletConnect packages -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.2/dist/index.umd.min.js"></script>
  <script>
    // WalletConnect Project ID (public - for HumanAds)
    const WALLETCONNECT_PROJECT_ID = '3c95ec9b803a06e64a9c5f24ef906cdc';

    // Chain configurations - Sepolia only
    // Base Sepolia has been removed; all requests fallback to Sepolia
    const CHAIN_CONFIG = {
      sepolia: {
        chainId: 11155111,
        chainIdHex: '0xaa36a7',
        name: 'Sepolia (Testnet)',
        shortName: 'Sepolia',
        rpcUrl: 'https://rpc.sepolia.org',
        blockExplorer: 'https://sepolia.etherscan.io',
        tokens: {
          usdc: {
            address: '0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238',
            decimals: 6,
            symbol: 'USDC',
            name: 'USDC (Official)',
          },
          husd: {
            address: '0x62c2225d5691515bd4ee36539d127d0db7dceb67',
            decimals: 6,
            symbol: 'hUSD',
            name: 'hUSD (HumanAds Test)',
          },
        },
        defaultToken: 'husd',
      },
    };

    // Default chain (only Sepolia supported)
    const DEFAULT_CHAIN = 'sepolia';

    // Normalize chain key - fallback deprecated chains to sepolia
    function normalizeChain(chainKey) {
      // Fallback base_sepolia or any unknown chain to sepolia
      if (!CHAIN_CONFIG[chainKey]) {
        console.log(`Chain "${chainKey}" not supported, falling back to sepolia`);
        return DEFAULT_CHAIN;
      }
      return chainKey;
    }

    // Helper to get current token config
    function getTokenConfig(chainKey, tokenKey) {
      const chain = CHAIN_CONFIG[chainKey];
      if (!chain) return null;
      return chain.tokens[tokenKey] || chain.tokens[chain.defaultToken];
    }

    // Get available tokens for a chain
    function getAvailableTokens(chainKey) {
      const chain = CHAIN_CONFIG[chainKey];
      if (!chain) return [];
      return Object.entries(chain.tokens)
        .filter(([key, token]) => token.address) // Only tokens with addresses
        .map(([key, token]) => ({ key, ...token }));
    }

    // ERC-20 ABI for transfer
    const ERC20_ABI = [
      'function transfer(address to, uint256 amount) returns (bool)',
      'function balanceOf(address owner) view returns (uint256)',
      'function decimals() view returns (uint8)',
      'function symbol() view returns (string)',
    ];

    // Detect mobile and in-app browser
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const hasInjectedProvider = typeof window.ethereum !== 'undefined';
    const isInMetaMaskBrowser = hasInjectedProvider && window.ethereum?.isMetaMask && isMobile;

    // Get the dApp host for MetaMask deep link
    const DAPP_HOST = window.location.host;
    const DAPP_PATH = '/advertiser/test';

    // MetaMask Deep Link - opens this page inside MetaMask's browser
    function getMetaMaskDeepLink() {
      return `https://metamask.app.link/dapp/${DAPP_HOST}${DAPP_PATH}`;
    }

    // Check if WalletConnect SDK is loaded
    function isWalletConnectLoaded() {
      return !!(window.EthereumProvider?.default || window.EthereumProvider);
    }

    // State
    const state = {
      environment: null,
      payoutMode: 'ledger',
      chain: 'sepolia', // Only Sepolia supported
      token: 'husd', // Selected token key (hUSD only in test mode)
      dealId: null,
      applicationId: null,
      missionId: null,
      operatorWallet: null,
      aufAmountCents: 0,
      payoutAmountCents: 0,
      treasuryAddress: null,
      currentStep: 1,
      timeline: [],
      // Wallet state
      walletConnected: false,
      walletAddress: null,
      walletProvider: null, // The raw provider (injected or WalletConnect)
      ethersProvider: null, // ethers.BrowserProvider wrapper
      signer: null,
      connectionType: null, // 'injected' or 'walletconnect'
      wcProvider: null, // WalletConnect provider instance
      // Pre-Steps state (added for setup workflow)
      preSteps: {
        mode: true, // Always true for test mode
        advertiserRegistered: false,
        advertiserId: null,
        advertiserName: null,
        advertiserWebsite: null,
        advertiserXHandle: null,
        advertiserEmail: null,
        advertiserNotes: null,
        walletConnected: false,
        walletAddress: null,
        chain: 'sepolia',
        sepoliaEthOk: false,
        husdReady: false,
        husdBalance: 0,
        lastHusdTx: null,
      },
    };

    async function checkAdmin() {
      const res = await HumanAds.fetchApi('/me');
      if (!res.success || !res.data?.xConnected || !res.data?.user?.is_admin) {
        window.location.href = '/admin';
        return false;
      }
      return true;
    }


    // ========== PRE-STEPS FUNCTIONS ==========

    // Pre-1: Register AI Advertiser
    async function registerAdvertiser() {
      const name = document.getElementById('advertiser-name').value.trim();
      if (!name) {
        alert('Advertiser name is required');
        return;
      }

      const website = document.getElementById('advertiser-website').value.trim();
      const xHandle = document.getElementById('advertiser-x-handle').value.trim();
      const email = document.getElementById('advertiser-email').value.trim();
      const notes = document.getElementById('advertiser-notes').value.trim();

      try {
        // Generate a simple advertiser ID (in real implementation, this would be server-generated)
        const advertiserId = 'adv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Store in state (in real implementation, this would be saved to database)
        state.preSteps.advertiserRegistered = true;
        state.preSteps.advertiserId = advertiserId;
        state.preSteps.advertiserName = name;
        state.preSteps.advertiserWebsite = website || null;
        state.preSteps.advertiserXHandle = xHandle || null;
        state.preSteps.advertiserEmail = email || null;
        state.preSteps.advertiserNotes = notes || null;

        // Save to localStorage for persistence
        localStorage.setItem('humanads_pre_steps', JSON.stringify(state.preSteps));

        // Re-render
        await render();

        alert(`✓ Advertiser registered successfully!\\n\\nAdvertiser ID: ${advertiserId}`);
      } catch (error) {
        console.error('Failed to register advertiser:', error);
        alert('Failed to register advertiser. Please try again.');
      }
    }

    // Pre-2: Connect Wallet (Sepolia) - for Pre-Steps only
    async function connectWalletPreStep() {
      try {
        // Check if MetaMask or compatible wallet is available
        if (!window.ethereum) {
          alert('Please install MetaMask or use MetaMask mobile browser');
          return;
        }

        // Request account access
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          alert('No accounts found. Please unlock your wallet.');
          return;
        }

        const address = accounts[0];

        // Check network (Sepolia chain ID = 11155111 or 0xaa36a7)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        const chainIdDecimal = parseInt(chainId, 16);

        if (chainIdDecimal !== 11155111) {
          // Try to switch to Sepolia
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0xaa36a7' }], // Sepolia
            });
          } catch (switchError) {
            // If network doesn't exist, add it
            if (switchError.code === 4902) {
              try {
                await window.ethereum.request({
                  method: 'wallet_addEthereumChain',
                  params: [{
                    chainId: '0xaa36a7',
                    chainName: 'Sepolia Testnet',
                    nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
                    rpcUrls: ['https://ethereum-sepolia-rpc.publicnode.com'],
                    blockExplorerUrls: ['https://sepolia.etherscan.io'],
                  }],
                });
              } catch (addError) {
                alert('Failed to add Sepolia network. Please add it manually.');
                return;
              }
            } else {
              alert('Please switch to Sepolia network manually.');
              return;
            }
          }
        }

        // Check Sepolia ETH balance (optional but helpful)
        const balance = await window.ethereum.request({
          method: 'eth_getBalance',
          params: [address, 'latest'],
        });
        const balanceInEth = parseInt(balance, 16) / 1e18;
        const hasSepoliaEth = balanceInEth > 0.001; // Minimum threshold

        // Update state
        state.preSteps.walletConnected = true;
        state.preSteps.walletAddress = address;
        state.preSteps.chain = 'sepolia';
        state.preSteps.sepoliaEthOk = hasSepoliaEth;

        // Save to localStorage
        localStorage.setItem('humanads_pre_steps', JSON.stringify(state.preSteps));

        // Re-render
        await render();

        if (!hasSepoliaEth) {
          alert(`✓ Wallet connected!\\n\\n⚠ Warning: Low Sepolia ETH balance (${balanceInEth.toFixed(4)} ETH).\\nYou may need to get Sepolia ETH from the faucet before proceeding.`);
        } else {
          alert(`✓ Wallet connected successfully!\\n\\nAddress: ${address.substring(0, 10)}...${address.substring(address.length - 8)}`);
        }
      } catch (error) {
        console.error('Failed to connect wallet:', error);
        alert('Failed to connect wallet. Please try again.');
      }
    }

    // Pre-3: Get hUSD
    async function getHusd() {
      if (!state.preSteps.walletConnected || !state.preSteps.walletAddress) {
        alert('Please connect your wallet first (Pre-Step 2)');
        return;
      }

      try {
        // In a real implementation, this would:
        // 1. Call a faucet contract to mint hUSD
        // 2. Or call an admin API to allocate hUSD to the test advertiser
        // For now, we'll simulate the process

        const confirmed = confirm(
          'This will request hUSD test tokens.\\n\\n' +
          'Requirements:\\n' +
          '- Sepolia ETH for gas\\n' +
          '- Connected wallet\\n\\n' +
          'Proceed?'
        );

        if (!confirmed) return;

        // Simulate transaction (in real implementation, call faucet contract)
        alert('⏳ Requesting hUSD...\\n\\nThis would normally:\\n1. Call the hUSD faucet contract\\n2. Mint test tokens to your address\\n3. Wait for transaction confirmation\\n\\nFor this demo, we\\'ll simulate success.');

        // Simulate success
        const mockTxHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join('');
        const mockHusdAmount = 1000; // 1000 hUSD

        state.preSteps.husdReady = true;
        state.preSteps.husdBalance = mockHusdAmount;
        state.preSteps.lastHusdTx = mockTxHash;

        // Save to localStorage
        localStorage.setItem('humanads_pre_steps', JSON.stringify(state.preSteps));

        // Re-render
        await render();

        alert(`✓ hUSD acquired successfully!\\n\\nBalance: ${mockHusdAmount} hUSD\\nTx: ${mockTxHash.substring(0, 10)}...${mockTxHash.substring(mockTxHash.length - 8)}`);
      } catch (error) {
        console.error('Failed to get hUSD:', error);
        alert('Failed to acquire hUSD. Please try again.');
      }
    }

    // Check if Pre-Steps are complete
    function arePreStepsComplete() {
      return state.preSteps.mode &&
             state.preSteps.advertiserRegistered &&
             state.preSteps.walletConnected &&
             state.preSteps.husdReady;
    }

    // Load Pre-Steps state from localStorage
    function loadPreSteps() {
      try {
        const saved = localStorage.getItem('humanads_pre_steps');
        if (saved) {
          const parsed = JSON.parse(saved);
          Object.assign(state.preSteps, parsed);
        }
      } catch (error) {
        console.error('Failed to load pre-steps from localStorage:', error);
      }
    }

    // ========== END PRE-STEPS FUNCTIONS ==========
    async function loadEnvironment() {
      const res = await HumanAds.fetchApi('/advertiser/test/environment');
      if (res.success && res.data) {
        state.environment = res.data.environment;
        state.payoutMode = res.data.payout_mode;
        state.treasuryAddress = res.data.treasury_address;
        return res.data;
      }
      return null;
    }

    function formatCents(cents) {
      return '$' + (cents / 100).toFixed(2);
    }

    function formatUsdc(cents) {
      return (cents / 100).toFixed(2) + ' hUSD';
    }

    function formatTokenAmount(cents, symbol = 'hUSD') {
      return (cents / 100).toFixed(2) + ' ' + symbol;
    }

    function truncate(str, len = 16) {
      if (!str || str.length <= len) return str;
      return str.slice(0, len/2) + '...' + str.slice(-len/2);
    }

    function getChainDisplayName(chainKey) {
      return CHAIN_CONFIG[chainKey]?.name || chainKey;
    }

    // Copy to clipboard
    async function copyToClipboard(text, btnEl) {
      try {
        await navigator.clipboard.writeText(text);
        if (btnEl) {
          const originalText = btnEl.innerHTML;
          btnEl.classList.add('copied');
          btnEl.innerHTML = 'Copied!';
          setTimeout(() => {
            btnEl.classList.remove('copied');
            btnEl.innerHTML = originalText;
          }, 1500);
        }
      } catch (e) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        if (btnEl) {
          btnEl.classList.add('copied');
          btnEl.innerHTML = 'Copied!';
          setTimeout(() => {
            btnEl.classList.remove('copied');
            btnEl.innerHTML = 'Copy';
          }, 1500);
        }
      }
    }

    // Paste from clipboard
    async function pasteToInput(inputId) {
      try {
        const text = await navigator.clipboard.readText();
        const input = document.getElementById(inputId);
        if (input && text) {
          input.value = text.trim();
        }
      } catch (e) {
        alert('Unable to paste. Please paste manually.');
      }
    }

    // Open MetaMask via deep link
    function openMetaMask() {
      const deepLink = getMetaMaskDeepLink();
      window.location.href = deepLink;
    }

    // hUSD Contract Code for easy deployment
    const HUSD_CONTRACT_CODE = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

/**
 * HumanAds Test USD (hUSD)
 * - decimals=6 (USDC compatible)
 * - owner only mint
 * - Sepolia testnet
 */
contract HumanAdsTestUSD {
    string public name = "HumanAds Test USD";
    string public symbol = "hUSD";
    uint8 public decimals = 6;

    uint256 public totalSupply;
    address public owner;

    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;

    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed holder, address indexed spender, uint256 value);

    modifier onlyOwner() {
        require(msg.sender == owner, "only owner");
        _;
    }

    constructor() {
        owner = msg.sender;
    }

    function mint(address to, uint256 amount) external onlyOwner {
        totalSupply += amount;
        balanceOf[to] += amount;
        emit Transfer(address(0), to, amount);
    }

    function transfer(address to, uint256 amount) external returns (bool) {
        require(balanceOf[msg.sender] >= amount, "balance");
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
        emit Transfer(msg.sender, to, amount);
        return true;
    }

    function approve(address spender, uint256 amount) external returns (bool) {
        allowance[msg.sender][spender] = amount;
        emit Approval(msg.sender, spender, amount);
        return true;
    }

    function transferFrom(address from, address to, uint256 amount) external returns (bool) {
        uint256 allowed = allowance[from][msg.sender];
        require(allowed >= amount, "allowance");
        require(balanceOf[from] >= amount, "balance");

        allowance[from][msg.sender] = allowed - amount;
        balanceOf[from] -= amount;
        balanceOf[to] += amount;

        emit Transfer(from, to, amount);
        return true;
    }

    function setOwner(address newOwner) external onlyOwner {
        owner = newOwner;
    }
}`;

    function toggleContractCode() {
      const section = document.getElementById('contract-code-section');
      const codeEl = document.getElementById('contract-code');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        codeEl.textContent = HUSD_CONTRACT_CODE;
      } else {
        section.style.display = 'none';
      }
    }

    function copyContractCode(btnEl) {
      copyToClipboard(HUSD_CONTRACT_CODE, btnEl);
    }

    function showResult(stepId, success, data) {
      const el = document.getElementById(`${stepId}-result`);
      if (!el) return;
      el.className = `result-box show ${success ? 'success' : 'error'}`;
      if (success) {
        el.innerHTML = `<strong>Success</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
      } else {
        el.innerHTML = `<strong>Error:</strong> ${data.message || JSON.stringify(data)}`;
      }
    }

    function updateStepState(stepNum) {
      state.currentStep = stepNum;
      document.querySelectorAll('.step-card').forEach((card, i) => {
        const num = i + 1;
        card.classList.remove('active', 'completed', 'disabled');
        if (num < stepNum) {
          card.classList.add('completed');
        } else if (num === stepNum) {
          card.classList.add('active');
        } else {
          card.classList.add('disabled');
        }
      });
    }

    function addToTimeline(step, name, id) {
      state.timeline.push({ step, name, id, done: true });
      renderTimeline();
    }

    function renderTimeline() {
      const container = document.getElementById('timeline-items');
      if (!container) return;
      container.innerHTML = state.timeline.map(item => `
        <div class="timeline-item done">
          <div class="step">${item.step}</div>
          <div class="content">
            <div class="name">${item.name}</div>
            <div class="id">${item.id}</div>
          </div>
        </div>
      `).join('');
    }

    function updateWalletUI() {
      const statusEl = document.getElementById('wallet-status');
      const connectBtn = document.getElementById('btn-connect-wallet');

      if (statusEl) {
        if (state.walletConnected) {
          statusEl.className = 'wallet-status connected';
          const typeLabel = state.connectionType === 'walletconnect' ? ' (WC)' : '';
          statusEl.innerHTML = `
            <svg class="wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
              <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
              <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
            </svg>
            ${truncate(state.walletAddress, 12)}${typeLabel}
          `;
        } else {
          statusEl.className = 'wallet-status disconnected';
          statusEl.innerHTML = `
            <svg class="wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
              <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
              <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
            </svg>
            Not Connected
          `;
        }
      }

      if (connectBtn) {
        if (state.walletConnected) {
          connectBtn.className = 'btn wallet connected';
          connectBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            Connected: ${truncate(state.walletAddress, 10)}
          `;
        } else {
          connectBtn.className = 'btn wallet';
          connectBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
              <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
              <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
            </svg>
            Connect Wallet
          `;
        }
      }

      // Update send buttons
      const sendAufBtn = document.getElementById('btn-send-auf');
      const sendPayoutBtn = document.getElementById('btn-send-payout');
      if (sendAufBtn) sendAufBtn.disabled = !state.walletConnected;
      if (sendPayoutBtn) sendPayoutBtn.disabled = !state.walletConnected;
    }

    // ========== Wallet Modal ==========

    function openWalletModal() {
      const modal = document.getElementById('wallet-modal');
      const body = document.getElementById('wallet-modal-body');
      const title = document.getElementById('wallet-modal-title');

      title.textContent = 'Connect Wallet';

      let html = '';

      // === MOBILE (iPhone Safari etc.) ===
      if (isMobile && !isInMetaMaskBrowser) {
        // Primary: Open MetaMask app (always works)
        html += `
          <div class="wallet-section-title">Recommended</div>
          <div class="wallet-option recommended" onclick="openMetaMask(); closeWalletModal();">
            <div class="wallet-option-icon" style="background:linear-gradient(135deg,#F6851B,#E2761B);">
              <svg width="24" height="24" viewBox="0 0 318 318" fill="white">
                <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
                <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
              </svg>
            </div>
            <div class="wallet-option-info">
              <div class="wallet-option-name">Open MetaMask</div>
              <div class="wallet-option-desc">Opens this page in MetaMask app</div>
            </div>
            <span class="wallet-option-badge">Best</span>
          </div>
          <p class="install-notice">
            Don't have MetaMask? <a href="https://metamask.io/download/" target="_blank">Install here</a>
          </p>
        `;

        // Secondary: WalletConnect (may fail on iOS Safari)
        const wcDisabled = !isWalletConnectLoaded();
        html += `
          <div class="wallet-section-title" style="margin-top:16px;">Alternative</div>
          <div class="wallet-option ${wcDisabled ? 'disabled' : ''}" style="${wcDisabled ? 'opacity:0.5;cursor:not-allowed;' : ''}" onclick="${wcDisabled ? 'showWalletConnectFallback()' : 'connectWalletConnect()'}">
            <div class="wallet-option-icon" style="background:linear-gradient(135deg,#3B99FC,#5BB0FF);">
              <svg width="24" height="24" viewBox="0 0 400 400" fill="white">
                <path d="M127.4 168.7c42.4-41.5 111.2-41.5 153.6 0l5.1 5c2.1 2.1 2.1 5.4 0 7.5l-17.5 17.1c-1.1 1-2.8 1-3.8 0l-7-6.9c-29.6-29-77.6-29-107.2 0l-7.5 7.3c-1.1 1-2.8 1-3.8 0l-17.5-17.1c-2.1-2.1-2.1-5.4 0-7.5l5.6-5.4zm189.8 35.3l15.6 15.3c2.1 2.1 2.1 5.4 0 7.5l-70.3 68.8c-2.1 2.1-5.6 2.1-7.7 0l-49.9-48.9c-.5-.5-1.4-.5-1.9 0l-49.9 48.9c-2.1 2.1-5.6 2.1-7.7 0l-70.3-68.8c-2.1-2.1-2.1-5.4 0-7.5l15.6-15.3c2.1-2.1 5.6-2.1 7.7 0l49.9 48.9c.5.5 1.4.5 1.9 0l49.9-48.9c2.1-2.1 5.6-2.1 7.7 0l49.9 48.9c.5.5 1.4.5 1.9 0l49.9-48.9c2.1-2.1 5.6-2.1 7.7 0z"/>
              </svg>
            </div>
            <div class="wallet-option-info">
              <div class="wallet-option-name">WalletConnect</div>
              <div class="wallet-option-desc">${wcDisabled ? 'SDK not loaded - use MetaMask' : 'Connect with other wallets'}</div>
            </div>
          </div>
        `;
      }
      // === IN METAMASK BROWSER ===
      else if (isInMetaMaskBrowser) {
        html += `
          <div class="wallet-section-title">MetaMask Detected</div>
          <div class="wallet-option recommended" onclick="connectInjected()">
            <div class="wallet-option-icon" style="background:linear-gradient(135deg,#F6851B,#E2761B);">
              <svg width="24" height="24" viewBox="0 0 318 318" fill="white">
                <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
                <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
              </svg>
            </div>
            <div class="wallet-option-info">
              <div class="wallet-option-name">MetaMask</div>
              <div class="wallet-option-desc">Connect using MetaMask</div>
            </div>
            <span class="wallet-option-badge">Ready</span>
          </div>
        `;
      }
      // === DESKTOP ===
      else {
        // Injected provider option (if available)
        if (hasInjectedProvider) {
          html += `
            <div class="wallet-section-title">Browser Extension</div>
            <div class="wallet-option recommended" onclick="connectInjected()">
              <div class="wallet-option-icon" style="background:linear-gradient(135deg,#F6851B,#E2761B);">
                <svg width="24" height="24" viewBox="0 0 318 318" fill="white">
                  <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
                  <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
                </svg>
              </div>
              <div class="wallet-option-info">
                <div class="wallet-option-name">${getInjectedWalletName()}</div>
                <div class="wallet-option-desc">Browser extension detected</div>
              </div>
              <span class="wallet-option-badge">Detected</span>
            </div>
          `;
        }

        // WalletConnect option for desktop
        html += `
          <div class="wallet-section-title">${hasInjectedProvider ? 'Mobile Wallets' : 'Connect Wallet'}</div>
          <div class="wallet-option" onclick="connectWalletConnect()">
            <div class="wallet-option-icon" style="background:linear-gradient(135deg,#3B99FC,#5BB0FF);">
              <svg width="24" height="24" viewBox="0 0 400 400" fill="white">
                <path d="M127.4 168.7c42.4-41.5 111.2-41.5 153.6 0l5.1 5c2.1 2.1 2.1 5.4 0 7.5l-17.5 17.1c-1.1 1-2.8 1-3.8 0l-7-6.9c-29.6-29-77.6-29-107.2 0l-7.5 7.3c-1.1 1-2.8 1-3.8 0l-17.5-17.1c-2.1-2.1-2.1-5.4 0-7.5l5.6-5.4zm189.8 35.3l15.6 15.3c2.1 2.1 2.1 5.4 0 7.5l-70.3 68.8c-2.1 2.1-5.6 2.1-7.7 0l-49.9-48.9c-.5-.5-1.4-.5-1.9 0l-49.9 48.9c-2.1 2.1-5.6 2.1-7.7 0l-70.3-68.8c-2.1-2.1-2.1-5.4 0-7.5l15.6-15.3c2.1-2.1 5.6-2.1 7.7 0l49.9 48.9c.5.5 1.4.5 1.9 0l49.9-48.9c2.1-2.1 5.6-2.1 7.7 0l49.9 48.9c.5.5 1.4.5 1.9 0l49.9-48.9c2.1-2.1 5.6-2.1 7.7 0z"/>
              </svg>
            </div>
            <div class="wallet-option-info">
              <div class="wallet-option-name">WalletConnect</div>
              <div class="wallet-option-desc">Scan QR code with your mobile wallet</div>
            </div>
          </div>
        `;

        // If no injected provider
        if (!hasInjectedProvider) {
          html += `
            <div class="wallet-section-title" style="margin-top:20px;">Install a Wallet</div>
            <div class="wallet-deep-links">
              <a href="https://metamask.io/download/" target="_blank" class="wallet-deep-link">MetaMask</a>
              <a href="https://rabby.io/" target="_blank" class="wallet-deep-link">Rabby</a>
            </div>
          `;
        }
      }

      body.innerHTML = html;
      modal.style.display = 'flex';
    }

    // Show fallback when WalletConnect fails
    function showWalletConnectFallback() {
      const body = document.getElementById('wallet-modal-body');
      const title = document.getElementById('wallet-modal-title');

      title.textContent = 'WalletConnect Unavailable';
      body.innerHTML = `
        <div class="fallback-box">
          <div class="title">WalletConnect SDK Failed to Load</div>
          <div class="desc">
            This can happen on iOS Safari. Use MetaMask directly instead - it's more reliable on mobile.
          </div>
        </div>
        <div class="wallet-option recommended" onclick="openMetaMask(); closeWalletModal();">
          <div class="wallet-option-icon" style="background:linear-gradient(135deg,#F6851B,#E2761B);">
            <svg width="24" height="24" viewBox="0 0 318 318" fill="white">
              <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
              <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
            </svg>
          </div>
          <div class="wallet-option-info">
            <div class="wallet-option-name">Open MetaMask</div>
            <div class="wallet-option-desc">Opens this page in MetaMask app</div>
          </div>
        </div>
        <p class="install-notice">
          Don't have MetaMask? <a href="https://metamask.io/download/" target="_blank">Install here</a>
        </p>
        <button class="btn secondary wallet-back-btn" onclick="openWalletModal()">Back to options</button>
      `;
    }

    function closeWalletModal() {
      document.getElementById('wallet-modal').style.display = 'none';
    }

    function getInjectedWalletName() {
      if (!window.ethereum) return 'Browser Wallet';
      if (window.ethereum.isRabby) return 'Rabby';
      if (window.ethereum.isMetaMask) return 'MetaMask';
      if (window.ethereum.isCoinbaseWallet) return 'Coinbase Wallet';
      if (window.ethereum.isPhantom) return 'Phantom';
      if (window.ethereum.isTrust) return 'Trust Wallet';
      if (window.ethereum.isOKExWallet || window.ethereum.isOkxWallet) return 'OKX Wallet';
      return 'Browser Wallet';
    }

    // ========== Connect Methods ==========

    async function connectWallet() {
      if (state.walletConnected) {
        // Disconnect
        await disconnectWallet();
        return;
      }

      openWalletModal();
    }

    async function disconnectWallet() {
      if (state.wcProvider) {
        try {
          await state.wcProvider.disconnect();
        } catch (e) {
          console.error('WC disconnect error:', e);
        }
      }

      state.walletConnected = false;
      state.walletAddress = null;
      state.walletProvider = null;
      state.ethersProvider = null;
      state.signer = null;
      state.connectionType = null;
      state.wcProvider = null;

      updateWalletUI();
    }

    async function connectInjected() {
      closeWalletModal();
      const btn = document.getElementById('btn-connect-wallet');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Connecting...';

      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send('eth_requestAccounts', []);

        if (accounts.length === 0) {
          throw new Error('No accounts found. Please unlock your wallet.');
        }

        state.walletProvider = window.ethereum;
        state.ethersProvider = provider;
        state.signer = await provider.getSigner();
        state.walletAddress = await state.signer.getAddress();
        state.walletConnected = true;
        state.connectionType = 'injected';

        // Try to switch to the selected chain
        await switchToChain(state.chain);

        updateWalletUI();

        // Setup event listeners
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);
      } catch (e) {
        console.error('Injected connection error:', e);
        let message = e.message || 'Connection failed';
        if (e.code === 4001) {
          message = 'Connection rejected by user.';
        }
        alert('Failed to connect: ' + message);
      }

      btn.disabled = false;
      updateWalletUI();
    }

    async function connectWalletConnect() {
      const btn = document.getElementById('btn-connect-wallet');

      // Check if SDK is loaded
      if (!isWalletConnectLoaded()) {
        // Show fallback modal instead of alert
        showWalletConnectFallback();
        document.getElementById('wallet-modal').style.display = 'flex';
        return;
      }

      closeWalletModal();
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Connecting...';

      try {
        const chainConfig = CHAIN_CONFIG[state.chain];

        // Initialize WalletConnect provider
        const EthereumProvider = window.EthereumProvider?.default || window.EthereumProvider;

        const wcProvider = await EthereumProvider.init({
          projectId: WALLETCONNECT_PROJECT_ID,
          chains: [chainConfig.chainId],
          optionalChains: [11155111], // Sepolia only
          showQrModal: true,
          qrModalOptions: {
            themeMode: 'dark',
            themeVariables: {
              '--wcm-z-index': '9999',
            },
          },
          metadata: {
            name: 'HumanAds',
            description: 'AI Advertiser Test Page',
            url: window.location.origin,
            icons: [window.location.origin + '/favicon.svg'],
          },
        });

        // Enable session (shows QR modal)
        await wcProvider.enable();

        const accounts = wcProvider.accounts;
        if (!accounts || accounts.length === 0) {
          throw new Error('No accounts returned from wallet.');
        }

        state.wcProvider = wcProvider;
        state.walletProvider = wcProvider;
        state.ethersProvider = new ethers.BrowserProvider(wcProvider);
        state.signer = await state.ethersProvider.getSigner();
        state.walletAddress = accounts[0];
        state.walletConnected = true;
        state.connectionType = 'walletconnect';

        // Setup event listeners
        wcProvider.on('accountsChanged', handleAccountsChanged);
        wcProvider.on('chainChanged', handleChainChanged);
        wcProvider.on('disconnect', () => {
          disconnectWallet();
        });

        updateWalletUI();
      } catch (e) {
        console.error('WalletConnect error:', e);
        let message = e.message || 'Connection failed';
        const isCancelled = message.includes('User rejected') ||
                           message.includes('rejected') ||
                           message.includes('Modal closed') ||
                           message.includes('cancelled');

        if (!isCancelled) {
          // Show fallback modal for real errors
          if (isMobile) {
            showWalletConnectFallback();
            document.getElementById('wallet-modal').style.display = 'flex';
          } else {
            alert('WalletConnect failed: ' + message);
          }
        }
      }

      btn.disabled = false;
      updateWalletUI();
    }

    function handleAccountsChanged(accounts) {
      if (!accounts || accounts.length === 0) {
        disconnectWallet();
      } else {
        state.walletAddress = accounts[0];
        updateWalletUI();
      }
    }

    function handleChainChanged(chainId) {
      // Reload provider on chain change
      if (state.walletConnected && state.walletProvider) {
        state.ethersProvider = new ethers.BrowserProvider(state.walletProvider);
        state.ethersProvider.getSigner().then(signer => {
          state.signer = signer;
        });
      }
    }

    async function switchToChain(chainKey) {
      const chainConfig = CHAIN_CONFIG[chainKey];
      if (!chainConfig || !state.walletProvider) return;

      try {
        await state.walletProvider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: chainConfig.chainIdHex }],
        });
      } catch (switchError) {
        // Chain not added, try to add it
        if (switchError.code === 4902 || switchError.message?.includes('Unrecognized chain')) {
          try {
            await state.walletProvider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: chainConfig.chainIdHex,
                chainName: chainConfig.name,
                rpcUrls: [chainConfig.rpcUrl],
                blockExplorerUrls: [chainConfig.blockExplorer],
                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
              }],
            });
          } catch (addError) {
            console.error('Failed to add chain:', addError);
            alert(`Please add ${chainConfig.name} to your wallet manually.\n\nChain ID: ${chainConfig.chainId}\nRPC: ${chainConfig.rpcUrl}`);
          }
        } else {
          console.error('Switch chain error:', switchError);
        }
      }
    }

    async function sendUsdcTransfer(toAddress, amountCents, type) {
      if (!state.walletConnected || !state.signer) {
        alert('Please connect your wallet first.');
        return null;
      }

      // Normalize address: trim whitespace and apply EIP-55 checksum
      try {
        toAddress = ethers.getAddress(toAddress.trim());
      } catch (e) {
        alert('Invalid wallet address: ' + toAddress);
        return null;
      }

      const chainConfig = CHAIN_CONFIG[state.chain];
      const tokenConfig = getTokenConfig(state.chain, state.token);
      if (!chainConfig || !tokenConfig) {
        alert('Invalid chain or token configuration.');
        return null;
      }

      if (!tokenConfig.address) {
        alert(`Token ${tokenConfig.symbol} is not configured. Please set the contract address first.`);
        return null;
      }

      const btn = document.getElementById(type === 'auf' ? 'btn-send-auf' : 'btn-send-payout');
      const txInput = document.getElementById(type === 'auf' ? 'auf-tx-hash' : 'payout-tx-hash');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Switching chain...';

      try {
        // Switch to correct chain
        await switchToChain(state.chain);

        btn.innerHTML = '<span class="spinner"></span> Preparing...';

        // Re-create provider after chain switch
        state.ethersProvider = new ethers.BrowserProvider(state.walletProvider);
        const signer = await state.ethersProvider.getSigner();

        // Create contract instance with selected token
        const tokenContract = new ethers.Contract(
          tokenConfig.address,
          ERC20_ABI,
          signer
        );

        // Calculate amount in token base units (using token decimals)
        const decimals = tokenConfig.decimals || 6;
        const amountBase = BigInt(amountCents) * BigInt(10 ** (decimals - 2)); // cents to base units

        btn.innerHTML = '<span class="spinner"></span> Confirm in wallet...';

        // Send transaction
        const tx = await tokenContract.transfer(toAddress, amountBase);

        // Update UI with tx hash immediately
        if (txInput) {
          txInput.value = tx.hash;
        }

        // Wait for confirmation
        btn.innerHTML = '<span class="spinner"></span> Confirming...';
        await tx.wait(1);

        btn.innerHTML = 'Transaction Sent';
        btn.disabled = false;

        return tx.hash;
      } catch (e) {
        console.error('Transaction error:', e);

        let message = 'Transaction failed';
        const tokenSymbol = tokenConfig?.symbol || 'token';
        if (e.code === 4001 || e.code === 'ACTION_REJECTED' || e.message?.includes('rejected')) {
          message = 'Transaction rejected by user.';
        } else if (e.message?.includes('insufficient funds') || e.message?.includes('exceeds balance')) {
          message = `Insufficient ${tokenSymbol} balance. Please ensure you have enough testnet ${tokenSymbol}.`;
        } else if (e.message?.includes('user rejected')) {
          message = 'Transaction rejected by user.';
        } else if (e.shortMessage) {
          message = e.shortMessage;
        } else if (e.message) {
          message = e.message.slice(0, 100);
        }

        alert(message);

        btn.innerHTML = type === 'auf' ? 'Send AUF Payment' : 'Send Payout';
        btn.disabled = false;
        return null;
      }
    }

    function renderPage(envData) {
      const content = document.getElementById('content');

      content.innerHTML = `
        <div class="test-header">
          <h1>AI Advertiser Test</h1>
          <p>E2E Payment Flow Wizard</p>
          <div class="env-badge ${state.payoutMode}">
            <span class="dot"></span>
            ${state.payoutMode === 'ledger' ? 'Ledger Mode (Simulated)' : 'Onchain Mode'}
          </div>
          <div class="wallet-status disconnected" id="wallet-status">
            <svg class="wallet-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
              <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
              <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
            </svg>
            Not Connected
          </div>
        </div>


        <!-- ========== PRE-STEPS: SETUP (BEFORE STEP A) ========== -->
        <div class="setup-section" style="margin-bottom: 24px; padding: 16px; background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2); border-radius: 12px;">
          <h2 style="font-family: var(--font-mono); font-size: 1rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="background: rgba(255, 107, 53, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">SETUP</span>
            Pre-Steps: Prepare for Testing
          </h2>
          <p style="font-size: 0.8125rem; color: var(--color-text-muted); margin-bottom: 16px;">
            Complete these setup steps before proceeding to Step A. This ensures you have everything needed for test mode.
          </p>

          <!-- Pre-0: Mode Selection (Test) -->
          <div class="step-card ${state.preSteps.mode ? 'completed' : 'active'}" id="pre-step-0">
            <div class="step-header">
              <div class="step-number" style="background: rgba(255, 107, 53, 0.2); color: var(--color-primary);">P0</div>
              <div class="step-title">Test Mode (hUSD / Sepolia)</div>
              ${state.preSteps.mode ? '<span class="status-badge success">✓</span>' : ''}
            </div>
            <div class="step-description">
              This setup is for Test Mode only. Production requires USDC.
            </div>
            <div class="info-row">
              <span class="label">Mode</span>
              <span class="value">Test Mode (hUSD / Sepolia)</span>
            </div>
            <div class="info-row">
              <span class="label">Ad Spend</span>
              <span class="value">FREE (test token)</span>
            </div>
            <div class="info-row">
              <span class="label">Gas</span>
              <span class="value">Sepolia ETH required</span>
            </div>
            <div style="margin-top: 12px; padding: 8px; background: rgba(52, 199, 89, 0.1); border-radius: 6px; font-size: 0.75rem;">
              ✓ Test Mode is active. Ad spend is free, but you'll need Sepolia ETH for gas.
            </div>
          </div>

          <!-- Pre-1: Register AI Advertiser -->
          <div class="step-card ${state.preSteps.advertiserRegistered ? 'completed' : state.preSteps.mode ? 'active' : 'disabled'}" id="pre-step-1">
            <div class="step-header">
              <div class="step-number" style="background: rgba(255, 107, 53, 0.2); color: var(--color-primary);">P1</div>
              <div class="step-title">Register AI Advertiser</div>
              ${state.preSteps.advertiserRegistered ? '<span class="status-badge success">✓</span>' : ''}
            </div>
            <div class="step-description">
              Create your AI Advertiser profile (no engineering knowledge required).
            </div>
            ${!state.preSteps.advertiserRegistered ? `
            <div style="margin-top: 12px;">
              <input type="text" id="advertiser-name" placeholder="Advertiser Name (required)"
                     style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-family: var(--font-mono); font-size: 0.8125rem;">
              <input type="url" id="advertiser-website" placeholder="Website / Project URL (optional)"
                     style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-family: var(--font-mono); font-size: 0.8125rem;">
              <input type="text" id="advertiser-x-handle" placeholder="X handle (optional, e.g., @yourbrand)"
                     style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-family: var(--font-mono); font-size: 0.8125rem;">
              <input type="email" id="advertiser-email" placeholder="Contact email (optional)"
                     style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-family: var(--font-mono); font-size: 0.8125rem;">
              <textarea id="advertiser-notes" placeholder="Notes (optional)" rows="2"
                        style="width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-family: var(--font-mono); font-size: 0.8125rem; resize: vertical;"></textarea>
              <button class="btn primary" onclick="registerAdvertiser()" style="width: 100%;">
                Create Advertiser Profile
              </button>
            </div>
            ` : `
            <div class="info-row">
              <span class="label">Advertiser ID</span>
              <span class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-family: var(--font-mono); font-size: 0.75rem;">${state.preSteps.advertiserId || 'N/A'}</span>
                <button onclick="navigator.clipboard.writeText('${state.preSteps.advertiserId}')"
                        style="padding: 2px 6px; font-size: 0.6875rem; border-radius: 4px; border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); cursor: pointer;">
                  Copy
                </button>
              </span>
            </div>
            <div class="info-row">
              <span class="label">Name</span>
              <span class="value">${state.preSteps.advertiserName || 'N/A'}</span>
            </div>
            `}
          </div>

          <!-- Pre-2: Connect Wallet (Sepolia) -->
          <div class="step-card ${state.preSteps.walletConnected ? 'completed' : state.preSteps.advertiserRegistered ? 'active' : 'disabled'}" id="pre-step-2">
            <div class="step-header">
              <div class="step-number" style="background: rgba(255, 107, 53, 0.2); color: var(--color-primary);">P2</div>
              <div class="step-title">Connect Wallet (Sepolia)</div>
              ${state.preSteps.walletConnected ? '<span class="status-badge success">✓</span>' : ''}
            </div>
            <div class="step-description">
              Connect your wallet to Sepolia testnet for test transactions.
            </div>
            ${!state.preSteps.walletConnected ? `
            <div style="margin-top: 12px;">
              ${isMobile && !isInMetaMaskBrowser ? `
              <button class="btn metamask" onclick="openMetaMask()" style="width: 100%; margin-bottom: 8px;">
                <svg width="16" height="16" viewBox="0 0 318 318" fill="currentColor">
                  <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
                  <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
                </svg>
                Open MetaMask
              </button>
              ` : ''}
              <button class="btn primary" onclick="connectWalletPreStep()" style="width: 100%;">
                Connect Wallet (Sepolia)
              </button>
              <div style="margin-top: 8px; padding: 8px; background: rgba(255, 149, 0, 0.1); border-radius: 6px; font-size: 0.75rem; color: rgba(255, 149, 0, 1);">
                ⚠ Make sure your wallet is on Sepolia network
              </div>
            </div>
            ` : `
            <div class="info-row">
              <span class="label">Address</span>
              <span class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-family: var(--font-mono); font-size: 0.75rem;">${truncate(state.preSteps.walletAddress, 20)}</span>
                <button onclick="navigator.clipboard.writeText('${state.preSteps.walletAddress}')"
                        style="padding: 2px 6px; font-size: 0.6875rem; border-radius: 4px; border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); cursor: pointer;">
                  Copy
                </button>
              </span>
            </div>
            <div class="info-row">
              <span class="label">Network</span>
              <span class="value">Sepolia</span>
            </div>
            `}
          </div>

          <!-- Pre-3: Get hUSD (requires Sepolia ETH) -->
          <div class="step-card ${state.preSteps.husdReady ? 'completed' : state.preSteps.walletConnected ? 'active' : 'disabled'}" id="pre-step-3">
            <div class="step-header">
              <div class="step-number" style="background: rgba(255, 107, 53, 0.2); color: var(--color-primary);">P3</div>
              <div class="step-title">Get hUSD (Test Token)</div>
              ${state.preSteps.husdReady ? '<span class="status-badge success">✓</span>' : ''}
            </div>
            <div class="step-description">
              Acquire hUSD test tokens for ad spend. Sepolia ETH is required for gas.
            </div>
            ${!state.preSteps.husdReady ? `
            <div style="margin-top: 12px;">
              <div style="padding: 8px; background: rgba(255, 149, 0, 0.1); border-radius: 6px; font-size: 0.75rem; margin-bottom: 8px;">
                ⚠ <strong>Sepolia ETH is required for gas.</strong><br>
                If you don't have Sepolia ETH, get it from a PoW faucet first.
              </div>
              <a href="https://sepolia-faucet.pk910.de/" target="_blank" class="btn secondary" style="width: 100%; margin-bottom: 8px; text-decoration: none; display: block; text-align: center;">
                Get Sepolia ETH (PoW Faucet)
              </a>
              <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 12px;">
                This is a PoW faucet. You may need to mine for a few minutes in your browser.
              </div>
              <button class="btn primary" onclick="getHusd()" style="width: 100%;">
                Get hUSD (Test Token)
              </button>
            </div>
            ` : `
            <div class="info-row">
              <span class="label">hUSD Balance</span>
              <span class="value">${state.preSteps.husdBalance || 0} hUSD</span>
            </div>
            ${state.preSteps.lastHusdTx ? `
            <div class="info-row">
              <span class="label">Last Tx</span>
              <span class="value" style="font-family: var(--font-mono); font-size: 0.75rem;">${truncate(state.preSteps.lastHusdTx, 20)}</span>
            </div>
            ` : ''}
            `}
          </div>

          <!-- Setup Complete / Proceed to Step A -->
          ${state.preSteps.husdReady ? `
          <div style="margin-top: 16px; padding: 12px; background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: 8px;">
            <div style="font-family: var(--font-mono); font-size: 0.875rem; font-weight: 600; margin-bottom: 8px; color: #34c759;">
              ✓ READY FOR STEP A
            </div>
            <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 12px;">
              All setup steps are complete. You can now proceed to Step A to begin the E2E payment flow.
            </div>
            <button class="btn primary" onclick="document.getElementById('step-a').scrollIntoView({behavior: 'smooth', block: 'start'})" style="width: 100%;">
              Proceed to Step A →
            </button>
          </div>
          ` : `
          <div style="margin-top: 16px; padding: 12px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 8px; font-size: 0.75rem; color: rgba(255, 149, 0, 1);">
            ⏳ Complete all setup steps above to unlock Step A
          </div>
          `}
        </div>
        <!-- ========== END PRE-STEPS ========== -->

        <!-- Step A: Environment -->
        <div class="step-card ${arePreStepsComplete() ? 'active' : 'disabled'}" id="step-a">
          <div class="step-header">
            <div class="step-number">A</div>
            <div class="step-title">Environment & Wallet</div>
          </div>
          <div class="step-description">Select token${isMobile && !isInMetaMaskBrowser ? '. Tap "Open MetaMask" to continue in the MetaMask app.' : ' and connect your wallet.'}</div>
          <div class="info-row">
            <span class="label">Network</span>
            <span class="value">Sepolia (Testnet)</span>
          </div>
          <div class="info-row">
            <span class="label">Token</span>
            <span class="value">hUSD (HumanAds Test)</span>
          </div>
          <div class="info-row">
            <span class="label">Payout Mode</span>
            <span class="value">${state.payoutMode}</span>
          </div>
          <div class="info-row">
            <span class="label">Treasury</span>
            <span class="value" style="font-size:0.6875rem;">${truncate(state.treasuryAddress, 20)}</span>
          </div>
          ${isMobile && !isInMetaMaskBrowser ? `
          <button class="btn metamask" onclick="openMetaMask()">
            <svg width="16" height="16" viewBox="0 0 318 318" fill="currentColor">
              <path d="M274.1 35.5l-99.5 73.9L193 65.8z"/>
              <path d="M44.4 35.5l98.7 74.6-17.5-44.3zm193.7 171.3l-26.5 40.6 56.7 15.6 16.3-55.3zm-213.1.9l16.2 55.3 56.7-15.6-26.5-40.6z"/>
            </svg>
            Open MetaMask
          </button>
          <button class="btn secondary" id="btn-connect-wallet" onclick="connectWallet()" style="margin-top:8px;">
            Or connect via WalletConnect
          </button>
          ` : `
          <button class="btn wallet" id="btn-connect-wallet" onclick="connectWallet()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
              <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
              <path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>
            </svg>
            Connect Wallet
          </button>
          `}

          <!-- hUSD Contract Deploy Helper -->
          <div id="husd-deploy-helper" style="margin-top:16px;padding-top:16px;border-top:1px dashed var(--color-border);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:0.75rem;color:var(--color-text-muted);">Need hUSD for testing?</span>
              <button class="btn secondary" onclick="toggleContractCode()" style="padding:4px 8px;font-size:0.6875rem;">
                Show Contract Code
              </button>
            </div>
            <div id="contract-code-section" style="display:none;">
              <div style="background:var(--color-background-light);border-radius:8px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                  <span style="font-family:var(--font-mono);font-size:0.75rem;font-weight:600;">HumanAdsTestUSD.sol</span>
                  <button class="copy-btn" onclick="copyContractCode(this)">Copy All</button>
                </div>
                <pre id="contract-code" style="font-size:0.625rem;line-height:1.4;max-height:200px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;margin:0;color:var(--color-text-muted);"></pre>
              </div>
              <div style="font-size:0.6875rem;color:var(--color-text-muted);line-height:1.5;">
                <strong>Deploy Steps:</strong><br>
                1. Open <a href="https://remix.ethereum.org" target="_blank" style="color:var(--color-primary);">remix.ethereum.org</a><br>
                2. Create new file, paste code<br>
                3. Compile (0.8.20)<br>
                4. Deploy → Sepolia<br>
                5. mint(your_address, 100000000000000000000)<br>
                6. Copy contract address → set in Token dropdown
              </div>
            </div>
          </div>
        </div>

        <!-- Step B: Create Deal -->
        <div class="step-card disabled" id="step-b">
          <div class="step-header">
            <div class="step-number">B</div>
            <div class="step-title">Create Mission</div>
          </div>
          <div class="step-description">Create a test deal as an AI advertiser.</div>
          <div class="input-group">
            <label>Reward Amount</label>
            <select id="reward-amount">
              <option value="500">$5.00</option>
              <option value="1000">$10.00</option>
            </select>
          </div>
          <button class="btn primary" onclick="createDeal()">
            Create Test Deal
          </button>
          <div class="result-box" id="step-b-result"></div>
        </div>

        <!-- Step C: Seed Application -->
        <div class="step-card disabled" id="step-c">
          <div class="step-header">
            <div class="step-number">C</div>
            <div class="step-title">Seed Application</div>
          </div>
          <div class="step-description">Create test promoter and application.</div>
          <div class="info-row" id="deal-id-row" style="display:none;">
            <span class="label">Deal ID</span>
            <span class="value highlight" id="display-deal-id">-</span>
          </div>
          <button class="btn primary" onclick="seedData()" disabled id="btn-seed">
            Seed Test Promoter & Application
          </button>
          <div class="result-box" id="step-c-result"></div>
        </div>

        <!-- Step D: Select & Approve -->
        <div class="step-card disabled" id="step-d">
          <div class="step-header">
            <div class="step-number">D</div>
            <div class="step-title">Select & Approve</div>
          </div>
          <div class="step-description">Select application and approve for payment.</div>
          <div class="info-row" id="app-id-row" style="display:none;">
            <span class="label">Application ID</span>
            <span class="value" id="display-app-id">-</span>
          </div>
          <div class="btn-row">
            <button class="btn" onclick="selectApplication()" disabled id="btn-select">Select</button>
            <button class="btn primary" onclick="approveMission()" disabled id="btn-approve">Approve</button>
          </div>
          <div class="result-box" id="step-d-result"></div>
        </div>

        <!-- Step E: Pay AUF (10%) -->
        <div class="step-card disabled" id="step-e">
          <div class="step-header">
            <div class="step-number">E</div>
            <div class="step-title">Pay AUF (10%)</div>
          </div>
          <div class="step-description">Pay the AUF to the treasury. ${isMobile ? 'Copy the address/amount, send in MetaMask, then paste the tx hash.' : ''}</div>
          <div class="payment-box" id="auf-payment-info" style="display:none;">
            <div class="title">AUF Payment Details</div>
            <div class="info-row-with-copy">
              <span class="label">Network</span>
              <div class="value-group">
                <span class="value" id="auf-chain">-</span>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">Token</span>
              <div class="value-group">
                <span class="value" id="auf-token">hUSD</span>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">To</span>
              <div class="value-group">
                <span class="value" id="auf-to" style="font-size:0.625rem;">-</span>
                <button class="copy-btn" onclick="copyToClipboard(state.aufPaymentInfo?.to_address || state.treasuryAddress, this)">Copy</button>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">Amount</span>
              <div class="value-group">
                <span class="value highlight" id="auf-amount">-</span>
                <button class="copy-btn" onclick="copyToClipboard((state.aufAmountCents / 100).toFixed(2), this)">Copy</button>
              </div>
            </div>
          </div>
          <button class="btn metamask" onclick="sendAuf()" disabled id="btn-send-auf">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
            Send AUF Payment
          </button>
          <div class="input-group" style="margin-top:12px;">
            <label>AUF Transaction Hash</label>
            <div class="input-with-paste">
              <input type="text" id="auf-tx-hash" placeholder="${state.payoutMode === 'ledger' ? 'SIMULATED_xxx or paste tx hash' : 'Paste tx hash after sending'}" />
              <button class="paste-btn" onclick="pasteToInput('auf-tx-hash')">Paste</button>
            </div>
          </div>
          <button class="btn primary" onclick="unlockAddress()" disabled id="btn-unlock">
            Verify & Unlock Address
          </button>
          <div class="result-box" id="step-e-result"></div>
        </div>

        <!-- Step F: Pay Promoter (90%) -->
        <div class="step-card disabled" id="step-f">
          <div class="step-header">
            <div class="step-number">F</div>
            <div class="step-title">Pay Promoter (90%)</div>
          </div>
          <div class="step-description">Send the payout to the promoter. ${isMobile ? 'Copy the address/amount, send in MetaMask, then paste the tx hash.' : ''}</div>
          <div class="payment-box" id="payout-payment-info" style="display:none;">
            <div class="title">Payout Details</div>
            <div class="info-row-with-copy">
              <span class="label">Network</span>
              <div class="value-group">
                <span class="value" id="payout-chain">-</span>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">Token</span>
              <div class="value-group">
                <span class="value" id="payout-token">hUSD</span>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">To (Promoter)</span>
              <div class="value-group">
                <span class="value" id="payout-to" style="font-size:0.625rem;">-</span>
                <button class="copy-btn" onclick="copyToClipboard(state.operatorWallet, this)">Copy</button>
              </div>
            </div>
            <div class="info-row-with-copy">
              <span class="label">Amount</span>
              <div class="value-group">
                <span class="value highlight" id="payout-amount">-</span>
                <button class="copy-btn" onclick="copyToClipboard((state.payoutAmountCents / 100).toFixed(2), this)">Copy</button>
              </div>
            </div>
          </div>
          <button class="btn metamask" onclick="sendPayout()" disabled id="btn-send-payout">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12l7 7 7-7"/>
            </svg>
            Send Payout
          </button>
          <div class="input-group" style="margin-top:12px;">
            <label>Payout Transaction Hash</label>
            <div class="input-with-paste">
              <input type="text" id="payout-tx-hash" placeholder="${state.payoutMode === 'ledger' ? 'SIMULATED_xxx or paste tx hash' : 'Paste tx hash after sending'}" />
              <button class="paste-btn" onclick="pasteToInput('payout-tx-hash')">Paste</button>
            </div>
          </div>
          <button class="btn primary" onclick="confirmPayout()" disabled id="btn-confirm">
            Confirm Payout
          </button>
          <div class="result-box" id="step-f-result"></div>
        </div>

        <!-- Step G: Complete -->
        <div class="step-card disabled" id="step-g">
          <div class="step-header">
            <div class="step-number">G</div>
            <div class="step-title">Complete</div>
          </div>
          <div id="complete-content" style="display:none;">
            <div class="complete-banner">
              <h2>PAID</h2>
              <p>E2E Payment Flow Complete!</p>
            </div>
            <button class="btn" onclick="startOver()">Start Over</button>
          </div>
        </div>

        <!-- Timeline -->
        <div class="timeline" id="timeline" style="display:none;">
          <h3>Timeline</h3>
          <div id="timeline-items"></div>
        </div>
      `;

      updateStepState(2); // Start at step B (Create Deal)
    }

    // Token is fixed to hUSD in test mode
    function renderTokenOptions(chainKey) {
      return '<option value="husd" selected>hUSD (HumanAds Test)</option>';
    }

    // Chain is fixed to Sepolia, token is fixed to hUSD in test mode
    function handleChainChange(chainKey) {
      // Always normalize to sepolia (only supported chain)
      state.chain = normalizeChain(chainKey);
      // Force hUSD in test mode
      state.token = 'husd';

      if (state.walletConnected) {
        switchToChain(state.chain);
      }
    }

    function handleTokenChange(tokenKey) {
      state.token = tokenKey;
      const tokenConfig = getTokenConfig(state.chain, tokenKey);
      console.log(`Token changed to: ${tokenConfig?.symbol} (${tokenConfig?.address || 'not deployed'})`);
    }

    // === API Calls ===

    async function createDeal() {
      const btn = document.querySelector('#step-b .btn.primary');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Creating...';

      try {
        const rewardAmount = parseInt(document.getElementById('reward-amount').value);
        const res = await HumanAds.fetchApi('/advertiser/test/deals/create', {
          method: 'POST',
          body: JSON.stringify({ reward_amount: rewardAmount, chain: state.chain }),
        });

        if (res.success && res.data?.deal_id) {
          state.dealId = res.data.deal_id;
          showResult('step-b', true, { deal_id: state.dealId });
          addToTimeline('B', 'Deal Created', state.dealId);

          // Update UI
          document.getElementById('display-deal-id').textContent = truncate(state.dealId);
          document.getElementById('deal-id-row').style.display = 'flex';
          document.getElementById('btn-seed').disabled = false;

          updateStepState(3);
        } else {
          showResult('step-b', false, res.error || res);
        }
      } catch (e) {
        showResult('step-b', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Create Test Deal';
    }

    async function seedData() {
      const btn = document.getElementById('btn-seed');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Seeding...';

      try {
        const res = await HumanAds.fetchApi('/advertiser/test/seed', {
          method: 'POST',
          body: JSON.stringify({ deal_id: state.dealId }),
        });

        if (res.success && res.data?.application_id) {
          state.applicationId = res.data.application_id;
          state.missionId = res.data.mission_id;
          // Normalize wallet address with EIP-55 checksum
          try {
            state.operatorWallet = res.data.operator_wallet ? ethers.getAddress(res.data.operator_wallet.trim()) : null;
          } catch (e) {
            state.operatorWallet = res.data.operator_wallet; // Keep as-is if normalization fails
          }

          showResult('step-c', true, res.data);
          addToTimeline('C', 'Application Seeded', state.applicationId);

          // Update UI
          document.getElementById('display-app-id').textContent = truncate(state.applicationId);
          document.getElementById('app-id-row').style.display = 'flex';
          document.getElementById('btn-select').disabled = false;
          document.getElementById('btn-approve').disabled = false;

          updateStepState(4);
        } else {
          showResult('step-c', false, res.error || res);
        }
      } catch (e) {
        showResult('step-c', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Seed Test Promoter & Application';
    }

    async function selectApplication() {
      const btn = document.getElementById('btn-select');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';

      try {
        const res = await HumanAds.fetchApi(`/advertiser/test/applications/${state.applicationId}/select`, {
          method: 'POST',
          body: JSON.stringify({}),
        });

        if (res.success) {
          showResult('step-d', true, { status: 'selected' });
        } else {
          if (res.error?.code === 'ALREADY_SELECTED' || res.error?.message?.includes('already')) {
            showResult('step-d', true, { status: 'already selected' });
          } else {
            showResult('step-d', false, res.error || res);
          }
        }
      } catch (e) {
        showResult('step-d', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Select';
    }

    async function approveMission() {
      const btn = document.getElementById('btn-approve');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';

      try {
        const res = await HumanAds.fetchApi(`/advertiser/test/applications/${state.applicationId}/approve`, {
          method: 'POST',
          body: JSON.stringify({}),
        });

        if (res.success && res.data) {
          state.aufAmountCents = res.data.auf_amount_cents;
          state.payoutAmountCents = res.data.payout_amount_cents || (res.data.auf_amount_cents * 9);
          state.aufPaymentInfo = res.data.payment_info;

          showResult('step-d', true, {
            status: 'approved',
            auf_amount: formatCents(state.aufAmountCents),
          });
          addToTimeline('D', 'Mission Approved', `AUF: ${formatCents(state.aufAmountCents)}`);

          // Update payment info with user-friendly display
          const tokenConfig = getTokenConfig(state.chain, state.token);
          const tokenSymbol = tokenConfig?.symbol || 'hUSD';
          document.getElementById('auf-amount').textContent = formatTokenAmount(state.aufAmountCents, tokenSymbol);
          document.getElementById('auf-to').textContent = truncate(res.data.payment_info?.to_address || state.treasuryAddress, 24);
          document.getElementById('auf-chain').textContent = getChainDisplayName(state.chain);
          document.getElementById('auf-token').textContent = tokenSymbol;
          document.getElementById('auf-payment-info').style.display = 'block';
          document.getElementById('btn-send-auf').disabled = !state.walletConnected;
          document.getElementById('btn-unlock').disabled = false;

          updateStepState(5);
          document.getElementById('timeline').style.display = 'block';
        } else {
          showResult('step-d', false, res.error || res);
        }
      } catch (e) {
        showResult('step-d', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Approve';
    }

    async function sendAuf() {
      if (!state.aufPaymentInfo) {
        alert('Payment info not available.');
        return;
      }

      const toAddress = state.aufPaymentInfo.to_address || state.treasuryAddress;
      const txHash = await sendUsdcTransfer(toAddress, state.aufAmountCents, 'auf');

      if (txHash) {
        addToTimeline('E', 'AUF Sent', truncate(txHash, 16));
      }
    }

    async function sendPayout() {
      if (!state.operatorWallet) {
        alert('Operator wallet not available.');
        return;
      }

      const txHash = await sendUsdcTransfer(state.operatorWallet, state.payoutAmountCents, 'payout');

      if (txHash) {
        addToTimeline('F', 'Payout Sent', truncate(txHash, 16));
      }
    }

    async function unlockAddress() {
      const btn = document.getElementById('btn-unlock');
      const txHash = document.getElementById('auf-tx-hash').value.trim();

      if (!txHash) {
        if (state.payoutMode === 'ledger') {
          document.getElementById('auf-tx-hash').value = 'SIMULATED_' + crypto.randomUUID().replace(/-/g, '');
          return unlockAddress();
        }
        showResult('step-e', false, { message: 'Please enter the transaction hash' });
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Verifying...';

      try {
        const res = await HumanAds.fetchApi(`/advertiser/test/applications/${state.applicationId}/unlock-address`, {
          method: 'POST',
          body: JSON.stringify({
            auf_tx_hash: txHash,
            chain: state.chain,
            token: 'hUSD',
          }),
        });

        if (res.success && res.data) {
          // Normalize wallet address with EIP-55 checksum
          try {
            state.operatorWallet = ethers.getAddress((res.data.wallet_address || '').trim());
          } catch (e) {
            showResult('step-e', false, { message: 'Invalid wallet address from promoter: ' + res.data.wallet_address });
            btn.disabled = false;
            btn.innerHTML = 'Verify & Unlock Address';
            return;
          }
          state.payoutAmountCents = res.data.payout_amount_cents;
          state.payoutPaymentInfo = res.data.payment_info;

          showResult('step-e', true, {
            wallet_address: state.operatorWallet,
            payout_amount: formatCents(state.payoutAmountCents),
          });
          addToTimeline('E', 'Address Unlocked', truncate(state.operatorWallet, 20));

          const tokenConfig = getTokenConfig(state.chain, state.token);
          const tokenSymbol = tokenConfig?.symbol || 'hUSD';
          document.getElementById('payout-amount').textContent = formatTokenAmount(state.payoutAmountCents, tokenSymbol);
          document.getElementById('payout-to').textContent = truncate(state.operatorWallet, 24);
          document.getElementById('payout-chain').textContent = getChainDisplayName(state.chain);
          document.getElementById('payout-token').textContent = tokenSymbol;
          document.getElementById('payout-payment-info').style.display = 'block';
          document.getElementById('btn-send-payout').disabled = !state.walletConnected;
          document.getElementById('btn-confirm').disabled = false;

          updateStepState(6);
        } else {
          showResult('step-e', false, res.error || res);
        }
      } catch (e) {
        showResult('step-e', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Verify & Unlock Address';
    }

    async function confirmPayout() {
      const btn = document.getElementById('btn-confirm');
      const txHash = document.getElementById('payout-tx-hash').value.trim();

      if (!txHash) {
        if (state.payoutMode === 'ledger') {
          document.getElementById('payout-tx-hash').value = 'SIMULATED_' + crypto.randomUUID().replace(/-/g, '');
          return confirmPayout();
        }
        showResult('step-f', false, { message: 'Please enter the transaction hash' });
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Confirming...';

      try {
        const res = await HumanAds.fetchApi(`/advertiser/test/applications/${state.applicationId}/confirm-payout`, {
          method: 'POST',
          body: JSON.stringify({
            payout_tx_hash: txHash,
            chain: state.chain,
            token: 'hUSD',
          }),
        });

        if (res.success && res.data) {
          showResult('step-f', true, { status: 'paid_complete' });
          addToTimeline('F', 'Payout Confirmed', formatCents(state.payoutAmountCents));
          addToTimeline('G', 'Complete', 'PAID');

          document.getElementById('complete-content').style.display = 'block';
          updateStepState(7);

          document.getElementById('step-g').classList.remove('disabled');
          document.getElementById('step-g').classList.add('completed');
        } else {
          showResult('step-f', false, res.error || res);
        }
      } catch (e) {
        showResult('step-f', false, { message: e.message });
      }

      btn.disabled = false;
      btn.innerHTML = 'Confirm Payout';
    }

    function startOver() {
      Object.assign(state, {
        dealId: null,
        applicationId: null,
        missionId: null,
        operatorWallet: null,
        aufAmountCents: 0,
        payoutAmountCents: 0,
        currentStep: 1,
        timeline: [],
        aufPaymentInfo: null,
        payoutPaymentInfo: null,
      });

      window.location.reload();
    }

    // === Init ===
    (async function() {
      try {
        if (await checkAdmin()) {
          loadPreSteps(); // Restore Pre-Steps state from localStorage
          const envData = await loadEnvironment();
          renderPage(envData);
          SideMenu.init(true, true);
        }
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('content').innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--color-error);">
            <h2>Initialization Error</h2>
            <p>${error.message || 'Unknown error occurred'}</p>
            <button class="btn primary" onclick="window.location.reload()" style="margin-top: 16px;">
              Reload Page
            </button>
          </div>
        `;
      }
    })();
  </script>
  <script src="/js/env-banner.js"></script>
</body>
</html>
