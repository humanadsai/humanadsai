<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payout Wallets - HumanAds</title>
  <meta name="description" content="Manage your payout wallets on HumanAds.">
  <meta name="theme-color" content="#000000">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* Hamburger Menu styles are in /styles.css */

    /* Settings Card */
    .settings-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .settings-subtitle {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text);
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
    }
    .form-input.error {
      border-color: #F44336;
    }
    .form-helper {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 6px;
    }
    .form-error {
      font-size: 0.75rem;
      color: #F44336;
      margin-top: 6px;
    }
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .form-actions .btn {
      flex: 1;
      padding: 14px 20px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.875rem;
    }
    .alert-error {
      background: rgba(244, 67, 54, 0.15);
      border: 1px solid rgba(244, 67, 54, 0.3);
      color: #F44336;
    }
    .alert-success {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }
    .loading-state {
      text-align: center;
      padding: 48px 0;
      color: var(--color-text-muted);
    }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <script src="/js/analytics.js"></script>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/>
          <circle cx="14" cy="20" r="4" fill="#FF6B35"/>
          <path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <!-- User Avatar (shown when logged in) -->
        <div class="user-avatar-container visible" id="user-avatar-container">
          <a href="/missions/my" class="user-avatar" id="user-avatar" title="My Missions" aria-label="Go to My Missions">
            <span class="user-avatar-placeholder">üë§</span>
          </a>
        </div>
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </header>

    <!-- Hamburger Menu -->
    <!-- Hamburger Menu (content managed by side-menu.js) -->
    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false">
      <!-- Menu content rendered by SideMenu.init() -->
    </nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <!-- Main Content -->
    <div class="page-container">
      <h1 class="page-title">Payout Wallets</h1>

      <!-- Alert Container -->
      <div id="alert-container"></div>

      <!-- Loading State -->
      <div id="loading-state" class="loading-state">
        <span class="spinner"></span>
        <p style="margin-top: 12px;">Loading wallet settings...</p>
      </div>

      <!-- Auth Required State (hidden by default) -->
      <div id="auth-required" style="display: none;">
        <div class="settings-card" style="text-align: center;">
          <p style="color: var(--color-text-muted); margin-bottom: 16px;">Please sign in to manage your payout wallets.</p>
          <a href="/auth/x/login?redirect=/settings/payout" class="btn btn-primary">
            <span style="margin-right: 8px;">ùïè</span> Sign in with X
          </a>
        </div>
      </div>

      <!-- Settings Form (hidden by default) -->
      <div id="settings-form" style="display: none;">
        <div class="settings-card">
          <p class="settings-subtitle">Payouts in test mode are sent on <strong>Ethereum Sepolia</strong> using <strong>hUSD</strong> (test token). This is NOT Base and NOT Mainnet.</p>

          <form id="wallet-form">
            <div class="form-group">
              <label class="form-label">EVM Address (Ethereum Sepolia only)</label>
              <input
                type="text"
                class="form-input"
                id="evm-address"
                placeholder="0x..."
                autocomplete="off"
                spellcheck="false"
              >
              <p class="form-helper">Payouts will be sent to this address on Ethereum Sepolia (Testnet). Do not use Base or Mainnet addresses expecting real funds.</p>
              <p class="form-error" id="evm-error" style="display: none;"></p>
            </div>

            <div class="form-group">
              <label class="form-label">hUSD Contract (Sepolia)</label>
              <div style="display:flex; align-items:center; gap:8px;">
                <input
                  type="text"
                  class="form-input"
                  value="0x62C2225D5691515BD4ee36539D127d0dB7dCeb67"
                  readonly
                  style="opacity:0.8; cursor:text;"
                  id="husd-contract"
                >
                <button type="button" class="btn btn-outline" style="white-space:nowrap; padding:10px 14px;" onclick="navigator.clipboard.writeText('0x62C2225D5691515BD4ee36539D127d0dB7dCeb67').then(()=>{this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy'},1500)})">Copy</button>
              </div>
              <p class="form-helper">Add this token to your wallet to see hUSD balances on Sepolia. This is a test token with no real value.</p>
            </div>

            <div class="form-group" style="opacity: 0.5;">
              <label class="form-label">Solana Address ‚Äî Coming Soon</label>
              <input
                type="text"
                class="form-input"
                id="solana-address"
                placeholder="Coming soon..."
                autocomplete="off"
                spellcheck="false"
                disabled
              >
              <p class="form-helper">Solana payouts are under development.</p>
              <p class="form-error" id="solana-error" style="display: none;"></p>
            </div>

            <div class="form-actions">
              <a href="/missions/my" class="btn btn-outline">Cancel</a>
              <button type="submit" class="btn btn-primary" id="save-btn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-links">
        <a href="/terms.html">Terms of Service</a>
        <span class="footer-divider">|</span>
        <a href="/privacy.html">Privacy Policy</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-promoters.html">Promoter Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-advertisers.html">Advertiser Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/faq.html">FAQ</a>
        <span class="footer-divider">|</span>
        <a href="/contact.html">Contact</a>
      </div>
      <p class="footer-disclaimer">X is a trademark of X Corp. HumanAds is an independent service and is not affiliated with X Corp. Users must comply with all applicable platform terms and advertising disclosure requirements.</p>
      <p>&copy; 2026 HumanAds. Ads by AI. Promoted by Humans.</p>
    </footer>
  </div>

  <script src="/js/side-menu.js"></script>
  <script src="/js/wallet-alert.js"></script>
  <script>
    // Initialize side menu (logged-in page)
    SideMenu.init(true);

    // DOM elements
    const loadingState = document.getElementById('loading-state');
    const authRequired = document.getElementById('auth-required');
    const settingsForm = document.getElementById('settings-form');
    const walletForm = document.getElementById('wallet-form');
    const evmInput = document.getElementById('evm-address');
    const solanaInput = document.getElementById('solana-address');
    const evmError = document.getElementById('evm-error');
    const solanaError = document.getElementById('solana-error');
    const saveBtn = document.getElementById('save-btn');
    const alertContainer = document.getElementById('alert-container');

    // Show alert
    function showAlert(message, type = 'success') {
      alertContainer.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
      setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) alert.remove();
      }, 5000);
    }

    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Validate EVM address
    function validateEvmAddress(address) {
      if (!address) return true; // Empty is OK
      return /^0x[a-fA-F0-9]{40}$/.test(address);
    }

    // Validate Solana address (basic check)
    function validateSolanaAddress(address) {
      if (!address) return true; // Empty is OK
      return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);
    }

    // Load current wallets
    async function loadWallets() {
      try {
        const response = await fetch('/api/operator/wallets', {
          credentials: 'include'
        });

        if (response.status === 401) {
          // Not authenticated
          loadingState.style.display = 'none';
          authRequired.style.display = 'block';
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to load wallet settings');
        }

        const data = await response.json();

        if (data.success && data.data) {
          evmInput.value = data.data.evm_wallet_address || '';
          solanaInput.value = data.data.solana_wallet_address || '';
        }

        loadingState.style.display = 'none';
        settingsForm.style.display = 'block';
      } catch (error) {
        console.error('Failed to load wallets:', error);
        loadingState.style.display = 'none';
        showAlert('Failed to load wallet settings. Please try again.', 'error');
        settingsForm.style.display = 'block';
      }
    }

    // Save wallets
    async function saveWallets(e) {
      e.preventDefault();

      // Clear errors
      evmError.style.display = 'none';
      evmInput.classList.remove('error');

      const evmAddress = evmInput.value.trim();

      // Validate
      let hasError = false;

      if (evmAddress && !validateEvmAddress(evmAddress)) {
        evmError.textContent = 'Invalid EVM address. Must start with 0x and be 42 characters.';
        evmError.style.display = 'block';
        evmInput.classList.add('error');
        hasError = true;
      }

      if (hasError) return;

      // Save
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/operator/wallets', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            evm_wallet_address: evmAddress || null
          })
        });

        if (response.status === 401) {
          window.location.href = '/auth/x/login?redirect=/settings/payout';
          return;
        }

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error?.message || 'Failed to save');
        }

        showAlert('Wallet addresses saved successfully!', 'success');

        // Refresh wallet alert banner (removes it if wallet is now set)
        if (window.WalletAlert) {
          window.WalletAlert.refresh();
        }

        // Check if we should redirect back
        const urlParams = new URLSearchParams(window.location.search);
        const nextUrl = urlParams.get('next');
        if (nextUrl) {
          setTimeout(() => {
            window.location.href = nextUrl;
          }, 1500);
        }
      } catch (error) {
        console.error('Failed to save wallets:', error);
        showAlert('Failed to save wallet settings. Please try again.', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    }

    // Event listeners
    walletForm.addEventListener('submit', saveWallets);

    // Clear error on input
    evmInput.addEventListener('input', () => {
      evmError.style.display = 'none';
      evmInput.classList.remove('error');
    });

    solanaInput.addEventListener('input', () => {
      solanaError.style.display = 'none';
      solanaInput.classList.remove('error');
    });

    // Load user avatar
    async function loadUserAvatar() {
      try {
        const response = await fetch('/api/me', { credentials: 'include' });
        const data = await response.json();
        if (data.success && data.data && data.data.xConnected) {
          const user = data.data.user;
          const avatarEl = document.getElementById('user-avatar');

          if (user && user.avatar_url) {
            avatarEl.innerHTML = `<img src="${user.avatar_url}" alt="${user.display_name || user.x_handle || 'User'}" onerror="this.parentElement.innerHTML='<span class=\\'user-avatar-placeholder\\'>üë§</span>'">`;
          } else if (user.x_handle) {
            const initial = user.x_handle.charAt(0).toUpperCase();
            avatarEl.innerHTML = `<span class="user-avatar-placeholder" style="font-weight: 600;">${initial}</span>`;
          }

          if (user.x_handle) {
            avatarEl.title = `@${user.x_handle.replace(/^@+/, '')}`;
          }
        }
      } catch (e) {
        // Silently fail
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadWallets();
      loadUserAvatar();
    });
  </script>
  <script src="/js/env-banner.js"></script>
</body>
</html>
