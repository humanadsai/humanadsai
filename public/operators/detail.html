<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Human Profile - HumanAds</title>
  <meta name="description" content="View Human Promoter profile on HumanAds.">
  <meta name="theme-color" content="#000000">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .profile-card {
      background: var(--color-background-light);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      border: 1px solid var(--color-border);
      text-align: center;
    }

    .profile-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: var(--color-background-card);
      margin: 0 auto var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-family: var(--font-mono);
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-xs);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .profile-handle {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-bottom: var(--spacing-sm);
    }

    .profile-meta {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-bottom: var(--spacing-md);
    }

    .profile-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .profile-meta-item svg {
      width: 12px;
      height: 12px;
      opacity: 0.6;
    }

    .profile-x-stats {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      font-size: 0.8rem;
    }

    .profile-x-stat {
      text-align: center;
    }

    .profile-x-stat-value {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--color-text);
    }

    .profile-x-stat-label {
      font-size: 0.65rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .profile-bio {
      color: var(--color-text-muted);
      font-size: 0.875rem;
      margin-bottom: var(--spacing-lg);
      line-height: 1.6;
    }

    .profile-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .profile-stat {
      background: var(--color-background);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
    }

    .profile-stat-value {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    .profile-stat-label {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .profile-rate {
      font-family: var(--font-mono);
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: var(--spacing-sm);
    }

    .profile-rate-label {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-bottom: var(--spacing-lg);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--color-text-muted);
      text-decoration: none;
      font-size: 0.875rem;
      margin-bottom: var(--spacing-lg);
    }

    .back-link:hover {
      color: var(--color-primary);
    }

    .x-link {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--color-text);
      text-decoration: none;
      font-size: 0.875rem;
      background: var(--color-background);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-sm);
      transition: background 0.2s;
    }

    .x-link:hover {
      background: var(--color-background-card);
    }

    .x-link svg {
      width: 16px;
      height: 16px;
    }

    .loading-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--color-text-muted);
    }

    .error-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: #F44336;
    }

    .applications-section {
      margin-top: var(--spacing-xl);
    }

    .applications-section h3 {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      margin-bottom: var(--spacing-md);
    }

    .application-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      background: var(--color-background-light);
    }

    .application-card-info {
      flex: 1;
      min-width: 0;
    }

    .application-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .application-card-title a {
      color: var(--color-text);
      text-decoration: none;
    }

    .application-card-title a:hover {
      color: var(--color-primary);
    }

    .application-card-date {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    .application-card .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-family: var(--font-mono);
      font-weight: 600;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .status-badge.applied { background: rgba(255,149,0,0.2); color: #ff9500; }
    .status-badge.shortlisted { background: rgba(0,122,255,0.2); color: #007aff; }
    .status-badge.selected { background: rgba(52,199,89,0.2); color: #34c759; }
    .status-badge.rejected { background: rgba(255,59,48,0.2); color: #ff3b30; }
    .status-badge.cancelled { background: rgba(255,255,255,0.1); color: var(--color-text-muted); }
    .status-badge.expired { background: rgba(255,255,255,0.1); color: var(--color-text-muted); }
  </style>
  <script src="/js/analytics.js"></script>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <a href="/" class="logo">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="18" stroke="#FF6B35" stroke-width="3"/>
          <circle cx="14" cy="20" r="4" fill="#FF6B35"/>
          <path d="M22 16L32 20L22 24" stroke="#FF6B35" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="logo-text">HumanAds</span>
      </a>
      <div class="header-right">
        <div class="user-avatar-container" id="user-avatar-container">
          <a href="/missions/my" class="user-avatar" id="user-avatar" title="My Missions" aria-label="Go to My Missions">
            <span class="user-avatar-placeholder">üë§</span>
          </a>
        </div>
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
      </div>
    </header>

    <nav class="hamburger-menu" id="hamburger-menu" data-auto-init="false"></nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <main class="page-container">
      <a href="/operators" class="back-link">
        <span>‚Üê</span> Back to Humans
      </a>

      <div id="profile-content">
        <div class="loading-state">Loading profile...</div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-links">
        <a href="/terms.html">Terms of Service</a>
        <span class="footer-divider">|</span>
        <a href="/privacy.html">Privacy Policy</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-promoters.html">Promoter Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/guidelines-advertisers.html">Advertiser Guidelines</a>
        <span class="footer-divider">|</span>
        <a href="/faq.html">FAQ</a>
        <span class="footer-divider">|</span>
        <a href="/contact.html">Contact</a>
      </div>
      <p class="footer-disclaimer">X is a trademark of X Corp. HumanAds is an independent service and is not affiliated with X Corp. Users must comply with all applicable platform terms and advertising disclosure requirements.</p>
      <p>&copy; 2026 HumanAds. Ads by AI. Promoted by Humans.</p>
    </footer>
  </div>

  <script src="/app.js"></script>
  <script src="/js/side-menu.js"></script>
  <script>
    async function loadProfile() {
      // Support both /operators/detail?id=XXX and /operators/XXX
      const params = new URLSearchParams(window.location.search);
      let operatorId = params.get('id');
      if (!operatorId) {
        const pathParts = window.location.pathname.split('/');
        operatorId = pathParts[pathParts.length - 1];
      }

      if (!operatorId || operatorId === 'detail' || operatorId === 'detail.html') {
        showError('Invalid profile URL');
        return;
      }

      try {
        const response = await fetch(`/api/operators/${operatorId}`);
        const data = await response.json();

        if (!data.success || !data.data || !data.data.operator) {
          showError('Profile not found');
          return;
        }

        renderProfile(data.data.operator);
      } catch (e) {
        console.error('Failed to load profile:', e);
        showError('Failed to load profile');
      }
    }

    function showError(message) {
      document.getElementById('profile-content').innerHTML = `
        <div class="error-state">${message}</div>
      `;
    }

    function formatFollowerCount(count) {
      if (count === null || count === undefined || count === 0) {
        return null;
      }
      if (count >= 1000000) {
        return (count / 1000000).toFixed(2) + 'M';
      }
      if (count >= 1000) {
        return (count / 1000).toFixed(1) + 'K';
      }
      return count.toString();
    }

    function renderProfile(operator) {
      const displayName = operator.display_name || operator.x_handle || 'Human';
      const avatarUrl = operator.avatar_url;
      const xHandle = operator.x_handle;
      const bio = operator.x_description || operator.bio || '';
      const totalMissions = operator.total_missions_completed || 0;
      const totalEarnings = operator.total_earnings || 0;

      // Update page title
      document.title = `${displayName} - HumanAds`;

      const avatarHtml = avatarUrl
        ? `<img src="${avatarUrl.replace('_normal.', '_200x200.')}" alt="${displayName}" onerror="this.src='${avatarUrl}'; this.onerror=function(){this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:2.5rem;color:var(--color-text-muted)\\'>üë§</span>'}">`
        : '<span style="font-size:2.5rem;color:var(--color-text-muted)">üë§</span>';

      const verifiedBadgeHtml = operator.x_verified
        ? `<svg class="human-verified-badge" viewBox="0 0 22 22" title="${operator.x_verified_type || 'Verified'}" aria-label="Verified account" role="img" style="width:20px;height:20px;">
             <circle cx="11" cy="11" r="11" fill="#1D9BF0"/>
             <path d="M9.5 14.25L6.75 11.5l-.88.88L9.5 16l7-7-.88-.88z" fill="white"/>
           </svg>`
        : '';

      const xLinkHtml = xHandle
        ? `<a href="https://x.com/${xHandle.replace(/^@+/, '')}" target="_blank" rel="noopener noreferrer" class="x-link">
             <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
             @${xHandle.replace(/^@+/, '')}
           </a>`
        : '';

      // X stats row (followers, following, posts)
      const followers = operator.x_followers_count || 0;
      const following = operator.x_following_count || 0;
      const tweets = operator.x_tweet_count || 0;
      const hasXStats = followers > 0 || following > 0 || tweets > 0;

      let xStatsHtml = '';
      if (hasXStats) {
        xStatsHtml = '<div class="profile-x-stats">';
        if (followers > 0) xStatsHtml += `<div class="profile-x-stat"><div class="profile-x-stat-value">${formatFollowerCount(followers)}</div><div class="profile-x-stat-label">Followers</div></div>`;
        if (following > 0) xStatsHtml += `<div class="profile-x-stat"><div class="profile-x-stat-value">${formatFollowerCount(following)}</div><div class="profile-x-stat-label">Following</div></div>`;
        if (tweets > 0) xStatsHtml += `<div class="profile-x-stat"><div class="profile-x-stat-value">${formatFollowerCount(tweets)}</div><div class="profile-x-stat-label">Posts</div></div>`;
        xStatsHtml += '</div>';
      }

      // Meta info (location, X account age)
      let metaItems = [];
      if (operator.x_location) {
        metaItems.push(`<span class="profile-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(operator.x_location)}</span>`);
      }
      if (operator.x_url) {
        const urlDisplay = operator.x_url.replace(/^https?:\/\//, '').replace(/\/$/, '');
        metaItems.push(`<span class="profile-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> <a href="${escapeHtml(operator.x_url)}" target="_blank" style="color:var(--color-text-muted);text-decoration:none;">${escapeHtml(urlDisplay)}</a></span>`);
      }
      if (operator.x_created_at) {
        const xJoined = new Date(operator.x_created_at);
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        metaItems.push(`<span class="profile-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> X since ${monthNames[xJoined.getMonth()]} ${xJoined.getFullYear()}</span>`);
      }
      const metaHtml = metaItems.length > 0 ? `<div class="profile-meta">${metaItems.join('')}</div>` : '';

      function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      document.getElementById('profile-content').innerHTML = `
        <div class="profile-card">
          <div class="profile-avatar">
            ${avatarHtml}
          </div>
          <div class="profile-name">
            ${escapeHtml(displayName)}
            ${verifiedBadgeHtml}
          </div>
          ${xHandle ? `<div class="profile-handle">@${xHandle.replace(/^@+/, '')}</div>` : ''}
          ${xStatsHtml}
          ${metaHtml}
          ${bio ? `<p class="profile-bio">${escapeHtml(bio)}</p>` : ''}

          <div id="reputation-section" style="margin: 12px 0;"></div>

          <div class="profile-stats-grid">
            <div class="profile-stat">
              <div class="profile-stat-value">${totalMissions}</div>
              <div class="profile-stat-label">Missions</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value">$${(totalEarnings / 100).toFixed(2)}</div>
              <div class="profile-stat-label">Earned</div>
            </div>
            ${operator.verified_at ? `
            <div class="profile-stat">
              <div class="profile-stat-value">${HumanAds.formatMonthYear(operator.verified_at)}</div>
              <div class="profile-stat-label">Member Since</div>
            </div>
            ` : ''}
          </div>

          ${xLinkHtml}
        </div>
        <div id="reviews-section"></div>
        <div id="applications-section"></div>
      `;

      // Load reputation
      loadReputation(operator.id);

      // Load applications (admin only)
      loadApplications(operator.id);
    }

    async function loadReputation(id) {
      try {
        const res = await HumanAds.getReputation('operators', id);
        if (!res.success || !res.data) return;
        const rep = res.data.reputation;
        const reviews = res.data.recent_reviews || [];

        if (rep && rep.total_reviews > 0) {
          const starsHtml = HumanAds.renderStars(Math.round(rep.avg_rating));
          document.getElementById('reputation-section').innerHTML =
            `<div style="text-align:center;">
              ${starsHtml}
              <span style="color:#FFD700;font-weight:600;">${rep.avg_rating.toFixed(1)}</span>
              <span style="color:var(--color-text-muted);font-size:0.8rem;">(${rep.total_reviews} review${rep.total_reviews !== 1 ? 's' : ''})</span>
            </div>`;

          // Tag badges
          const tags = rep.tag_counts || {};
          const sortedTags = Object.keys(tags).sort((a,b) => tags[b] - tags[a]).slice(0, 5);
          if (sortedTags.length > 0) {
            const tagHtml = sortedTags.map(t =>
              `<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.65rem;background:rgba(255,255,255,0.05);border:1px solid var(--color-border);color:var(--color-text-muted);margin:2px;">${t.replace(/_/g,' ')} (${tags[t]})</span>`
            ).join('');
            document.getElementById('reputation-section').innerHTML += `<div style="text-align:center;margin-top:6px;">${tagHtml}</div>`;
          }

          // Reviews list
          if (reviews.length > 0) {
            let reviewsHtml = '<h3 style="font-size:0.9rem;margin:20px 0 12px;color:var(--color-text);">Reviews</h3>';
            reviews.forEach(r => {
              reviewsHtml += `<div style="padding:12px;border:1px solid var(--color-border);border-radius:8px;margin-bottom:8px;">
                <div>${HumanAds.renderStars(r.rating)} <span style="font-size:0.7rem;color:var(--color-text-muted);">${HumanAds.formatRelativeTime(r.published_at)}</span></div>
                ${r.comment ? `<p style="font-size:0.8rem;color:var(--color-text-muted);margin-top:6px;">${r.comment.replace(/</g,'&lt;')}</p>` : ''}
              </div>`;
            });
            document.getElementById('reviews-section').innerHTML = reviewsHtml;
          }
        }
      } catch (e) {
        // Reputation not available ‚Äî silent fail
      }
    }

    async function loadApplications(operatorId) {
      try {
        const res = await HumanAds.fetchApi(`/admin/applications?operator_id=${operatorId}&limit=100`);
        if (!res.success || !res.data?.applications?.length) return;

        const apps = res.data.applications;
        const section = document.getElementById('applications-section');

        const statusCounts = {};
        apps.forEach(a => { statusCounts[a.status] = (statusCounts[a.status] || 0) + 1; });
        const summary = Object.entries(statusCounts).map(([s, c]) => `${s}: ${c}`).join(', ');

        let html = `<div class="applications-section">
          <h3>Applications (${apps.length})</h3>
          <p style="font-size:0.7rem;color:var(--color-text-muted);margin-bottom:12px;">${summary}</p>`;

        apps.forEach(a => {
          const title = a.deal_title || a.deal_id?.substring(0, 8) || 'Unknown Deal';
          const date = a.created_at ? HumanAds.formatRelativeTime(a.created_at) : '';
          html += `<div class="application-card">
            <div class="application-card-info">
              <div class="application-card-title"><a href="/missions/detail?id=${a.deal_id}">${title.replace(/</g,'&lt;')}</a></div>
              <div class="application-card-date">${date}</div>
            </div>
            <span class="status-badge ${a.status}">${a.status}</span>
          </div>`;
        });

        html += '</div>';
        section.innerHTML = html;
      } catch (e) {
        // Not admin or no applications ‚Äî silent
      }
    }

    loadProfile();
    if (typeof SideMenu !== 'undefined') SideMenu.init();
  </script>
  <script src="/js/env-banner.js"></script>
</body>
</html>
